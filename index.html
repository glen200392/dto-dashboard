<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="DTO Dashboard - Digital Transformation Office Management System">
  <title>DTO Dashboard</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    /* ============================= */
    /* CSS VARIABLES & THEMING SYSTEM */
    /* ============================= */

    :root,
    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #eff6ff;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --sidebar-bg: #1e293b;
      --sidebar-text: #cbd5e1;
      --sidebar-active: #3b82f6;
      --sidebar-hover: #334155;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
      --accent: #60a5fa;
      --accent-hover: #3b82f6;
      --accent-light: #1e3a5f;
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #60a5fa;
      --sidebar-hover: #1e293b;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    /* ============================= */
    /* GLOBAL STYLES */
    /* ============================= */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ============================= */
    /* LAYOUT STRUCTURE */
    /* ============================= */

    #app {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 240px;
      height: 100vh;
      background-color: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: width 0.3s ease;
      overflow-y: auto;
      overflow-x: hidden;
    }

    #sidebar::-webkit-scrollbar {
      width: 6px;
    }

    #sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    #sidebar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    #sidebar::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    body.sidebar-collapsed #sidebar {
      width: 60px;
    }

    #main-content {
      margin-left: 240px;
      width: calc(100% - 240px);
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }

    body.sidebar-collapsed #main-content {
      margin-left: 60px;
      width: calc(100% - 60px);
    }

    #topbar {
      position: sticky;
      top: 0;
      background-color: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      z-index: 50;
      box-shadow: var(--card-shadow);
    }

    #view-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    #view-container::-webkit-scrollbar {
      width: 8px;
    }

    #view-container::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    #view-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    #view-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ============================= */
    /* SIDEBAR STYLES */
    /* ============================= */

    .sidebar-logo {
      padding: 20px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .sidebar-logo-text {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .sidebar-logo-subtitle {
      font-size: 11px;
      color: var(--sidebar-text);
      opacity: 0.8;
      white-space: nowrap;
    }

    body.sidebar-collapsed .sidebar-logo-subtitle,
    body.sidebar-collapsed .sidebar-logo-text {
      display: none;
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--sidebar-text);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
    }

    .nav-item:hover {
      background-color: var(--sidebar-hover);
      color: #ffffff;
    }

    .nav-item.active {
      background-color: var(--sidebar-active);
      color: #ffffff;
      font-weight: 600;
    }

    .nav-icon {
      font-size: 18px;
      min-width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .nav-label {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.sidebar-collapsed .nav-label {
      display: none;
    }

    .sidebar-footer {
      padding: 16px 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .collapse-btn {
      width: 100%;
      padding: 12px 16px;
      background-color: var(--sidebar-hover);
      color: var(--sidebar-text);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .collapse-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }

    /* ============================= */
    /* TOPBAR STYLES */
    /* ============================= */

    #breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .breadcrumb-separator {
      color: var(--border-color);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 24px;
      flex: 1;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    #global-search {
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      width: 250px;
      transition: all 0.2s ease;
      position: relative;
    }

    #global-search:focus {
      outline: none;
      border-color: var(--accent);
      background-color: var(--bg-primary);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .search-icon {
      position: absolute;
      left: 10px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .theme-toggle-btn,
    .user-menu-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 8px;
      border-radius: 6px;
    }

    .theme-toggle-btn:hover,
    .user-menu-btn:hover {
      background-color: var(--bg-secondary);
      color: var(--accent);
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--accent);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .avatar:hover {
      box-shadow: 0 0 0 2px var(--accent);
    }

    /* ============================= */
    /* CARD STYLES */
    /* ============================= */

    .card {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
    }

    .card:hover {
      box-shadow: var(--card-shadow-hover);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* ============================= */
    /* BUTTON STYLES */
    /* ============================= */

    .btn {
      padding: 10px 16px;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background-color: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }

    .btn-primary:hover:not(:disabled) {
      background-color: var(--accent-hover);
      border-color: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .btn-danger {
      background-color: var(--danger);
      color: #ffffff;
      border-color: var(--danger);
    }

    .btn-danger:hover:not(:disabled) {
      background-color: #dc2626;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--text-primary);
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s ease;
    }

    .btn-close:hover {
      color: var(--accent);
    }

    /* ============================= */
    /* BADGE STYLES */
    /* ============================= */

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    .badge-success {
      background-color: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .badge-warning {
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .badge-danger {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .badge-info {
      background-color: rgba(6, 182, 212, 0.1);
      color: var(--info);
    }

    /* ============================= */
    /* FORM STYLES */
    /* ============================= */

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* ============================= */
    /* TABLE STYLES */
    /* ============================= */

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table thead {
      background-color: var(--bg-secondary);
      border-bottom: 2px solid var(--border-color);
    }

    .data-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table tbody tr:hover {
      background-color: var(--bg-secondary);
    }

    /* ============================= */
    /* TABS STYLES */
    /* ============================= */

    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 12px 16px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ============================= */
    /* KPI CARD STYLES */
    /* ============================= */

    .kpi-card {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .kpi-icon {
      font-size: 28px;
    }

    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .kpi-trend.up {
      color: var(--success);
    }

    .kpi-trend.down {
      color: var(--danger);
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .kpi-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* ============================= */
    /* PROGRESS BAR STYLES */
    /* ============================= */

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* ============================= */
    /* CHART CONTAINER */
    /* ============================= */

    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin: 20px 0;
    }

    /* ============================= */
    /* GRID LAYOUTS */
    /* ============================= */

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    /* ============================= */
    /* EDIT PANEL & OVERLAY */
    /* ============================= */

    .edit-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 180;
      transition: opacity 0.3s ease;
    }

    .edit-overlay.hidden {
      display: none;
      opacity: 0;
    }

    .edit-panel {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: 400px;
      background-color: var(--bg-primary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      z-index: 200;
      box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
      animation: slideInRight 0.3s ease;
    }

    .edit-panel.hidden {
      display: none;
      animation: slideOutRight 0.3s ease;
    }

    .edit-panel-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .edit-panel-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .edit-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .edit-panel-body::-webkit-scrollbar {
      width: 6px;
    }

    .edit-panel-body::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .edit-panel-body::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .edit-panel-footer {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* ============================= */
    /* MODAL STYLES */
    /* ============================= */

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 250;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal-content {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
    }

    /* ============================= */
    /* TOAST STYLES */
    /* ============================= */

    #toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast-container {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      min-width: 300px;
      box-shadow: var(--card-shadow-hover);
      animation: slideUpAndFade 0.3s ease;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    .toast.info {
      border-left: 4px solid var(--info);
    }

    /* ============================= */
    /* AGENT CARD */
    /* ============================= */

    .agent-card {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      gap: 16px;
      align-items: center;
      transition: all 0.3s ease;
    }

    .agent-card:hover {
      box-shadow: var(--card-shadow-hover);
    }

    .agent-avatar {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      background-color: var(--accent);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .agent-info {
      flex: 1;
    }

    .agent-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .agent-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.active {
      background-color: var(--success);
    }

    .status-dot.idle {
      background-color: var(--warning);
    }

    .status-dot.paused {
      background-color: var(--text-muted);
    }

    .status-dot.error {
      background-color: var(--danger);
    }

    /* ============================= */
    /* WORKFLOW STEP */
    /* ============================= */

    .workflow-step {
      background-color: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      min-width: 150px;
      transition: all 0.3s ease;
    }

    .workflow-step:hover {
      border-color: var(--accent);
      box-shadow: var(--card-shadow-hover);
    }

    .workflow-step.active {
      border-color: var(--accent);
      background-color: var(--accent-light);
    }

    .workflow-step.completed {
      border-color: var(--success);
      background-color: rgba(34, 197, 94, 0.05);
    }

    .workflow-step-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .workflow-step-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ============================= */
    /* ACTIVITY ITEM */
    /* ============================= */

    .activity-item {
      display: flex;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      font-size: 20px;
      min-width: 32px;
      text-align: center;
      flex-shrink: 0;
    }

    .activity-content {
      flex: 1;
    }

    .activity-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ============================= */
    /* GANTT CHART */
    /* ============================= */

    .gantt-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }

    .gantt-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .gantt-label {
      min-width: 150px;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .gantt-track {
      flex: 1;
      height: 32px;
      background-color: var(--bg-secondary);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .gantt-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 4px;
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #ffffff;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .gantt-bar:hover {
      filter: brightness(1.1);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    /* ============================= */
    /* ANIMATIONS */
    /* ============================= */

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUpAndFade {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* ============================= */
    /* UTILITY CLASSES */
    /* ============================= */

    .hidden {
      display: none !important;
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .gap-4 {
      gap: 16px;
    }

    .gap-2 {
      gap: 8px;
    }

    .mb-4 {
      margin-bottom: 16px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .text-center {
      text-align: center;
    }

    /* ============================= */
    /* RESPONSIVE DESIGN */
    /* ============================= */

    @media (max-width: 768px) {
      #sidebar {
        width: 60px;
        transform: translateX(-100%);
      }

      body.sidebar-open #sidebar {
        transform: translateX(0);
      }

      #main-content {
        margin-left: 0;
        width: 100%;
      }

      .topbar-left {
        gap: 12px;
      }

      #global-search {
        width: auto;
        min-width: 200px;
      }

      .stat-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }

      .card-grid {
        grid-template-columns: 1fr;
      }

      .edit-panel {
        width: 100%;
        max-width: 100%;
      }

      .modal-content {
        width: 95%;
      }

      #toast-container {
        left: 12px;
        right: 12px;
        bottom: 12px;
      }

      .toast-container {
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      #topbar {
        padding: 12px 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      #breadcrumb {
        order: 3;
        width: 100%;
        font-size: 12px;
      }

      #global-search {
        width: 100%;
        min-width: unset;
      }

      .topbar-right {
        gap: 12px;
      }

      .stat-grid {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 8px 12px;
      }
    }

    /* ============================================ */
    /* COMPREHENSIVE COMPONENT CSS - ALL VIEWS      */
    /* ============================================ */

    /* === VIEW CONTAINERS === */
    .view-overview,
    .view-projects-list,
    .view-project-detail,
    .view-action-detail,
    .view-timeline,
    .view-agents,
    .view-team,
    .view-team-member,
    .view-all-actions,
    .view-settings,
    .agent-squad-container,
    .agent-detail-container,
    .workflows-container,
    .activity-container {
      max-width: 1400px;
      width: 100%;
    }

    /* === VIEW HEADER === */
    .view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .view-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    /* === SECTION HEADER (Agent pages) === */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .section-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* === BREADCRUMB === */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .bc-current {
      color: var(--text-primary);
      font-weight: 500;
    }

    /* === DETAIL HEADER === */
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .detail-header h2 {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 0;
    }

    /* === STAT GRID (Overview) === */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    /* === STAT CARD === */
    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--card-shadow);
    }
    .stat-icon {
      font-size: 1.8rem;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: var(--accent-light);
      flex-shrink: 0;
    }
    .stat-content {
      flex: 1;
      min-width: 0;
    }
    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
    }

    /* === STATS GRID (Agent Squad) === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    /* === STATS ROW (Detail pages mini stats) === */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-mini {
      text-align: center;
      padding: 12px 8px;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
    }

    /* === STAT BOX (Agent metrics tab) === */
    .stat-box {
      text-align: center;
      padding: 16px 12px;
      border-radius: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
    }
    .stat-num {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent);
      line-height: 1.2;
    }
    .stat-lbl {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* === SUMMARY STATS (Activity page) === */
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    /* === CHART GRID (Overview) - CRITICAL: Fixed heights === */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    .chart-grid .card {
      min-height: 0;
      overflow: hidden;
    }
    .chart-grid .card canvas {
      width: 100% !important;
      max-height: 280px !important;
    }

    /* === CHART CONTAINER (Agent metrics tab) === */
    .chart-container {
      position: relative;
      width: 100%;
      height: 250px;
      max-height: 300px;
    }
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* === CARD === */
    .card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      margin-bottom: 0;
    }
    .card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    /* === CARD GRID === */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    /* === CARD ACTIONS === */
    .card-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .card-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .card-status-indicator {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* === AGENT CARD (Squad view) === */
    .agent-card {
      position: relative;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--card-shadow);
    }
    .agent-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }
    .agent-card-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .agent-emoji {
      font-size: 2rem;
      line-height: 1;
      flex-shrink: 0;
    }
    .agent-info {
      flex: 1;
      min-width: 0;
    }
    .agent-info h3 {
      margin: 0 0 4px 0;
      font-size: 1rem;
      font-weight: 600;
    }
    .agent-info p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* === AGENT STATUS BADGES === */
    .agent-status {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .agent-status.active { background: #dcfce7; color: #16a34a; }
    .agent-status.idle { background: #fef3c7; color: #d97706; }
    .agent-status.paused { background: var(--bg-secondary); color: var(--text-muted); }
    .agent-status.error { background: #fee2e2; color: #dc2626; }
    [data-theme="dark"] .agent-status.active { background: #14532d; color: #4ade80; }
    [data-theme="dark"] .agent-status.idle { background: #451a03; color: #fbbf24; }
    [data-theme="dark"] .agent-status.error { background: #450a0a; color: #f87171; }

    /* === AGENT TABLE === */
    .agent-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .agent-table thead {
      background: var(--bg-secondary, #f8fafc);
      border-bottom: 2px solid var(--border-color, #e2e8f0);
    }
    .agent-table th {
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary, #64748b);
      white-space: nowrap;
    }
    .agent-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color, #e2e8f0);
      vertical-align: middle;
    }
    .agent-table .agent-row:hover {
      background: var(--bg-secondary, #f8fafc);
    }
    .agent-table .agent-row:last-child td {
      border-bottom: none;
    }
    [data-theme="dark"] .agent-table thead {
      background: #1e293b;
    }
    [data-theme="dark"] .agent-table .agent-row:hover {
      background: #1e293b;
    }

    /* === BADGE SYSTEM === */
    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .badge-autonomy {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 500;
      background: var(--accent-light);
      color: var(--accent);
    }
    .badge-secondary {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      background: var(--bg-secondary);
      color: var(--text-muted);
      border: 1px solid var(--border-color);
    }
    .type-badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 500;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    .priority-badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    /* === LLM INDICATOR === */
    .llm-indicator {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* === PROJECTS TAGS (Agent card) === */
    .projects-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    /* === METRICS ROW (Agent card) === */
    .metrics-row {
      display: flex;
      gap: 12px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    /* === LAST ACTIVITY (Agent card) === */
    .last-activity {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* === QUICK ACTIONS BAR (Agent Squad) === */
    .quick-actions-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    /* === ACTIVITY FEED SECTION === */
    .activity-feed-section {
      margin-top: 24px;
    }
    .feed-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .feed-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }
    .feed-nav {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .feed-link {
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .feed-link:hover {
      text-decoration: underline;
    }
    .divider {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* === ACTIVITY LIST & ITEMS === */
    .activity-list {
      display: flex;
      flex-direction: column;
    }
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.85rem;
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-entry {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.85rem;
    }
    .activity-entry:last-child {
      border-bottom: none;
    }
    .time {
      white-space: nowrap;
      color: var(--text-muted);
      font-size: 0.8rem;
      min-width: 48px;
      flex-shrink: 0;
    }
    .agent {
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .message {
      flex: 1;
      color: var(--text-secondary);
      min-width: 0;
      word-break: break-word;
    }

    /* === ACTIVITY TIMELINE FULL (Activity page) === */
    .activity-timeline-full {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }
    .date-group {
      border-bottom: 1px solid var(--border-color);
    }
    .date-group:last-child {
      border-bottom: none;
    }
    .date-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    /* === ACTIVITY FILTERS === */
    .activity-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    /* === ACTIVITY TAB === */
    .activity-tab {
      padding: 0;
    }

    /* === FILTER ROW === */
    .filter-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      align-items: center;
    }

    /* === FILTER BAR === */
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      align-items: center;
    }

    /* === CONTROLS ROW === */
    .controls-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      align-items: center;
    }

    /* === LINKS === */
    .link {
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
    }
    .link:hover {
      text-decoration: underline;
    }
    .bc-link {
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
    }
    .bc-link:hover {
      text-decoration: underline;
    }
    .bc-sep {
      margin: 0 6px;
      color: var(--text-muted);
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    .back-link:hover {
      text-decoration: underline;
    }

    /* === AGENT DETAIL CONTAINER === */
    .agent-identity-section {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
    }
    .identity-header {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .emoji-name {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .emoji-input {
      font-size: 2rem;
      width: 60px;
      text-align: center;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 4px;
      background: var(--bg-secondary);
    }
    .name-input {
      font-size: 1.2rem;
      font-weight: 600;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      min-width: 180px;
    }
    .role-description {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 200px;
    }
    .role-input {
      font-size: 0.9rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .description-input {
      font-size: 0.85rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }

    /* === CONTROLS GRID (Agent detail) === */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .control-group {
      margin-bottom: 0;
    }
    .control-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    /* === STATUS BUTTONS (Agent detail) === */
    .status-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .btn-toggle {
      padding: 6px 14px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-toggle:hover {
      border-color: var(--accent);
    }
    .btn-toggle.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* === AUTONOMY SELECTOR === */
    .autonomy-selector {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .autonomy-selector label {
      text-transform: none !important;
      font-weight: 400 !important;
    }

    /* === SCHEDULE DISPLAY === */
    .schedule-display {
      font-size: 0.85rem;
      color: var(--text-secondary);
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    .tz {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: 4px;
    }

    /* === PROJECTS CHECKBOXES === */
    .projects-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    /* === LLM CONFIG SECTION === */
    .llm-config-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .llm-config-section h4 {
      font-size: 0.9rem;
      margin-bottom: 12px;
    }
    .note {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 8px;
    }

    /* === ACTION BUTTONS === */
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    /* === TABS (Agent detail) === */
    .tabs-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }
    .tab-nav {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      background: var(--bg-secondary);
    }
    .tab-btn {
      padding: 12px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .tab-btn:hover {
      color: var(--text-primary);
      background: var(--bg-primary);
    }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: var(--bg-primary);
    }
    .tab-content {
      padding: 20px;
    }

    /* === DETAIL TABS (Project detail) === */
    .detail-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 16px;
    }
    .detail-tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .detail-tab-btn:hover {
      color: var(--text-primary);
    }
    .detail-tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* === TASK QUEUE TAB === */
    .task-queue-tab {
      padding: 0;
    }
    .task-section {
      margin-bottom: 16px;
    }
    .task-section h4 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .task-section.collapsible h4 {
      cursor: pointer;
    }
    .task-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 0.85rem;
      gap: 10px;
    }
    .task-item .task-name {
      flex: 1;
      font-weight: 500;
      color: var(--text-primary);
    }
    .task-item .task-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .due-date {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .add-task-form {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .add-task-form input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.85rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* === METRICS TAB === */
    .metrics-tab {
      padding: 0;
    }

    /* === WORKFLOW CARD === */
    .workflow-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
    }
    .workflow-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .workflow-header h3 {
      margin: 0;
      font-size: 1rem;
    }
    .description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .trigger-info {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border-radius: 6px;
    }
    .workflow-steps {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    .workflow-step {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.8rem;
    }
    .step-content {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .step-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .workflow-arrow {
      color: var(--text-muted);
      font-size: 0.8rem;
    }
    .run-info {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* === EXPORT BUTTONS === */
    .export-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    /* === TEAM OVERVIEW === */
    .team-overview {
      margin-bottom: 20px;
    }

    /* === TEAM CARDS & GRID === */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .team-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--card-shadow);
    }
    .team-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }
    .team-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 12px 0;
    }
    .team-stat {
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      background: var(--bg-secondary);
    }
    .team-stat .team-stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .team-stat .team-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* === PROJECT CARD === */
    .project-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--card-shadow);
    }
    .project-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }
    .project-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .project-body {
      padding: 16px 20px;
    }

    /* === DATA TABLE === */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .data-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border-color);
      background: var(--bg-secondary);
      white-space: nowrap;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .data-table td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    .data-table tbody tr:hover {
      background: var(--bg-secondary);
    }
    .detail-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .detail-table th {
      padding: 10px 14px;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border-color);
      background: var(--bg-secondary);
      font-size: 0.8rem;
    }
    .detail-table td {
      padding: 8px 14px;
      border-bottom: 1px solid var(--border-color);
    }
    .detail-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    /* === GANTT TABLE === */
    .gantt-container {
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }
    .gantt-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .gantt-table th,
    .gantt-table td {
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      text-align: center;
      white-space: nowrap;
    }
    .gantt-table th {
      background: var(--bg-secondary);
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    .gantt-table td:first-child {
      text-align: left;
      font-weight: 500;
      min-width: 150px;
    }

    /* === TAGS === */
    .tag {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    .tools-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    /* === ICON BUTTON === */
    .btn-icon {
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 10px;
      font-size: 0.9rem;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .btn-icon:hover {
      background: var(--bg-secondary);
      border-color: var(--accent);
    }

    /* === BUTTONS === */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      font-family: inherit;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover {
      background: var(--accent-hover);
    }
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .btn-secondary:hover {
      background: var(--bg-tertiary);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      opacity: 0.9;
    }
    .btn-sm {
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    /* === FORM INPUTS === */
    .input-select,
    .input-text {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.85rem;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: inherit;
    }
    .input-select:focus,
    .input-text:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    .input-range {
      width: 100%;
      accent-color: var(--accent);
    }

    /* === SETTING GROUP === */
    .setting-group {
      margin-bottom: 20px;
    }
    .setting-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    /* === PROGRESS BAR === */
    .progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
      background: var(--accent);
    }

    /* === INFO BOX === */
    .info-box {
      padding: 16px 20px;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      margin-bottom: 16px;
    }

    /* === RADIO GROUP === */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 400;
    }

    /* === GLOBAL STATS === */
    .global-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    /* === METRICS GRID === */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .metric-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .metric-card .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
    }
    .metric-card .metric-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* === QUICK ACTIONS === */
    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    /* === FLOW DIAGRAM === */
    .flow-diagram {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      overflow-x: auto;
      flex-wrap: wrap;
    }
    .flow-arrow {
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    /* === SUMMARY FOOTER === */
    .summary-footer {
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .summary-footer span {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* === LABEL === */
    .label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    /* === ERROR === */
    .error {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    /* === SHOW/HIDDEN === */
    .hidden {
      display: none !important;
    }
    .show {
      display: block !important;
    }

    /* === TEXT UTILITIES === */
    .text-muted {
      color: var(--text-muted);
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      #sidebar {
        width: 0;
        overflow: hidden;
      }
      #main-content {
        margin-left: 0;
        width: 100%;
      }
      .stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      .card-grid {
        grid-template-columns: 1fr;
      }
      .controls-grid {
        grid-template-columns: 1fr;
      }
    }

    /* === ACTIVITY TIMELINE (Overview feed) === */
    .activity-timeline {
      display: flex;
      flex-direction: column;
    }

    /* === PROJECT DETAIL TAB BUTTON === */
    .tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab:hover {
      color: var(--text-primary);
    }
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* === DYNAMIC BADGE COLORS (status/type) === */
    .badge-active { background: #dcfce7; color: #16a34a; }
    .badge-idle { background: #fef3c7; color: #d97706; }
    .badge-paused { background: var(--bg-secondary); color: var(--text-muted); }
    .badge-error { background: #fee2e2; color: #dc2626; }
    .badge-on_track { background: #dcfce7; color: #16a34a; }
    .badge-completed { background: #dbeafe; color: #2563eb; }
    .badge-in_progress { background: #fef3c7; color: #d97706; }
    .badge-pending { background: var(--bg-secondary); color: var(--text-muted); }
    .badge-at_risk { background: #fee2e2; color: #dc2626; }
    .badge-delayed { background: #fce4ec; color: #c62828; }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-info { background: #dbeafe; color: #2563eb; }
    .badge-alert { background: #fef3c7; color: #d97706; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-daily { background: var(--accent-light); color: var(--accent); }
    .badge-weekly { background: #f3e8ff; color: #7c3aed; }
    .badge-continuous { background: #dcfce7; color: #16a34a; }
    .badge-hourly { background: #fef3c7; color: #d97706; }
    .badge-schedule { background: #e0f2fe; color: #0284c7; }
    .badge-event { background: #fce7f3; color: #db2777; }
    [data-theme="dark"] .badge-active { background: #14532d; color: #4ade80; }
    [data-theme="dark"] .badge-idle { background: #451a03; color: #fbbf24; }
    [data-theme="dark"] .badge-error { background: #450a0a; color: #f87171; }
    [data-theme="dark"] .badge-on_track { background: #14532d; color: #4ade80; }
    [data-theme="dark"] .badge-completed { background: #1e3a5f; color: #60a5fa; }
    [data-theme="dark"] .badge-in_progress { background: #451a03; color: #fbbf24; }
    [data-theme="dark"] .badge-at_risk { background: #450a0a; color: #f87171; }
    [data-theme="dark"] .badge-delayed { background: #450a0a; color: #f87171; }
    [data-theme="dark"] .badge-success { background: #14532d; color: #4ade80; }
    [data-theme="dark"] .badge-info { background: #1e3a5f; color: #60a5fa; }
    [data-theme="dark"] .badge-alert { background: #451a03; color: #fbbf24; }
    [data-theme="dark"] .badge-warning { background: #451a03; color: #fbbf24; }

    /* === CHART.JS OVERFLOW FIX === */
    canvas {
      max-width: 100% !important;
      max-height: 320px !important;
    }
    .chart-grid .card {
      position: relative;
      overflow: hidden;
      max-height: 360px;
    }
    #view-container {
      overflow-x: hidden;
    }

    /* ==================== NOTIFICATION CENTER ==================== */
    #notif-bell {
      position: relative;
      cursor: pointer;
      font-size: 20px;
      padding: 4px 8px;
      border: none;
      background: none;
      color: var(--text-primary);
    }
    #notif-bell .notif-badge {
      position: absolute;
      top: 0; right: 2px;
      background: #ef4444;
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      line-height: 16px;
    }
    #notif-bell .notif-badge.visible { display: flex; }
    #notif-panel {
      position: fixed;
      top: 56px; right: 20px;
      width: 360px;
      max-height: 480px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      z-index: 9998;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    #notif-panel.visible { display: flex; }
    .notif-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 14px;
    }
    .notif-header button {
      background: none; border: none; font-size: 12px; cursor: pointer; color: var(--accent); padding: 2px 6px;
    }
    .notif-list {
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
    }
    .notif-item {
      display: flex;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
      transition: background .15s;
    }
    .notif-item:hover { background: var(--bg-secondary); }
    .notif-item.unread { background: var(--accent-light, #eff6ff); }
    .notif-dot {
      min-width: 8px; width: 8px; height: 8px;
      border-radius: 50%; margin-top: 5px;
    }
    .notif-dot.info { background: #3b82f6; }
    .notif-dot.success { background: #22c55e; }
    .notif-dot.warning { background: #f59e0b; }
    .notif-dot.error { background: #ef4444; }
    .notif-content { flex: 1; min-width: 0; }
    .notif-title { font-weight: 600; }
    .notif-body { color: var(--text-secondary); font-size: 12px; margin-top: 2px; }
    .notif-time { color: var(--text-muted); font-size: 11px; white-space: nowrap; margin-top: 2px; }
    .notif-empty { padding: 32px 16px; text-align: center; color: var(--text-muted); font-size: 13px; }

    [data-theme="dark"] #notif-panel { background: var(--bg-secondary); border-color: var(--border-color); }
    [data-theme="dark"] .notif-item.unread { background: rgba(59,130,246,0.08); }

    /* ==================== TALK UI - CHAT PANEL ==================== */
    #talk-fab {
      position: fixed;
      bottom: 28px;
      right: 28px;
      z-index: 9999;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(99,102,241,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #talk-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 28px rgba(99,102,241,0.6);
    }
    #talk-fab.open {
      background: linear-gradient(135deg, #ef4444, #f97316);
      box-shadow: 0 4px 20px rgba(239,68,68,0.45);
    }
    #talk-fab .fab-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #22c55e;
      border: 2px solid #fff;
      display: none;
    }
    #talk-fab.has-unread .fab-badge { display: block; }

    #talk-panel {
      position: fixed;
      bottom: 96px;
      right: 28px;
      z-index: 9998;
      width: 400px;
      max-width: calc(100vw - 56px);
      height: 520px;
      max-height: calc(100vh - 140px);
      background: var(--bg-primary, #ffffff);
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                  opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #talk-panel.visible {
      transform: translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .talk-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 18px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      flex-shrink: 0;
    }
    .talk-header-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .talk-header-info { flex: 1; }
    .talk-header-info h4 { margin: 0; font-size: 14px; font-weight: 600; }
    .talk-header-info span { font-size: 11px; opacity: 0.8; }
    .talk-header-actions { display: flex; gap: 6px; }
    .talk-header-actions button {
      background: rgba(255,255,255,0.15);
      border: none;
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    .talk-header-actions button:hover { background: rgba(255,255,255,0.3); }

    .talk-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .talk-messages::-webkit-scrollbar { width: 4px; }
    .talk-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

    .talk-msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.5;
      word-break: break-word;
      animation: talkMsgIn 0.2s ease-out;
    }
    @keyframes talkMsgIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .talk-msg.bot {
      align-self: flex-start;
      background: var(--bg-secondary, #f1f5f9);
      color: var(--text-primary, #1e293b);
      border-bottom-left-radius: 4px;
    }
    .talk-msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .talk-msg.system {
      align-self: center;
      background: transparent;
      color: var(--text-secondary, #94a3b8);
      font-size: 11px;
      padding: 4px 12px;
      max-width: 100%;
      text-align: center;
    }
    .talk-msg .msg-time {
      display: block;
      font-size: 10px;
      opacity: 0.6;
      margin-top: 4px;
    }
    .talk-msg.bot .msg-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .talk-msg.bot .msg-actions button {
      background: var(--bg-primary, #fff);
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      color: #6366f1;
      transition: background 0.15s;
    }
    .talk-msg.bot .msg-actions button:hover {
      background: #6366f1;
      color: #fff;
    }

    .talk-typing {
      align-self: flex-start;
      padding: 10px 14px;
      background: var(--bg-secondary, #f1f5f9);
      border-radius: 14px;
      border-bottom-left-radius: 4px;
      display: none;
    }
    .talk-typing.show { display: flex; gap: 4px; align-items: center; }
    .talk-typing span {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #94a3b8;
      animation: typingDot 1.4s infinite both;
    }
    .talk-typing span:nth-child(2) { animation-delay: 0.2s; }
    .talk-typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingDot {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    .talk-input-area {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 12px 14px;
      border-top: 1px solid var(--border, #e2e8f0);
      background: var(--bg-primary, #fff);
      flex-shrink: 0;
    }
    .talk-input-area textarea {
      flex: 1;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 13px;
      font-family: inherit;
      resize: none;
      max-height: 80px;
      min-height: 36px;
      line-height: 1.4;
      background: var(--bg-secondary, #f8fafc);
      color: var(--text-primary, #1e293b);
      outline: none;
      transition: border-color 0.2s;
    }
    .talk-input-area textarea:focus {
      border-color: #6366f1;
    }
    .talk-input-area textarea::placeholder {
      color: var(--text-secondary, #94a3b8);
    }
    .talk-send-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: transform 0.15s, opacity 0.15s;
      flex-shrink: 0;
    }
    .talk-send-btn:hover { transform: scale(1.08); }
    .talk-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .talk-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 14px;
      border-top: 1px solid var(--border, #e2e8f0);
      background: var(--bg-primary, #fff);
      flex-shrink: 0;
    }
    .talk-suggestions button {
      background: var(--bg-secondary, #f1f5f9);
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      padding: 4px 12px;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-primary, #475569);
      white-space: nowrap;
      transition: all 0.15s;
    }
    .talk-suggestions button:hover {
      background: #6366f1;
      color: #fff;
      border-color: #6366f1;
    }

    /* Dark theme overrides for Talk UI */
    [data-theme="dark"] #talk-panel {
      background: #1e293b;
      border-color: #334155;
    }
    [data-theme="dark"] .talk-msg.bot { background: #334155; color: #e2e8f0; }
    [data-theme="dark"] .talk-msg.bot .msg-actions button {
      background: #1e293b;
      border-color: #475569;
    }
    [data-theme="dark"] .talk-typing { background: #334155; }
    [data-theme="dark"] .talk-input-area { background: #1e293b; border-color: #334155; }
    [data-theme="dark"] .talk-input-area textarea { background: #0f172a; border-color: #334155; color: #e2e8f0; }
    [data-theme="dark"] .talk-suggestions { background: #1e293b; border-color: #334155; }
    [data-theme="dark"] .talk-suggestions button { background: #334155; border-color: #475569; color: #cbd5e1; }

    /* Mobile responsive */
    @media (max-width: 640px) {
      #talk-panel {
        right: 8px;
        bottom: 80px;
        width: calc(100vw - 16px);
        height: calc(100vh - 100px);
        border-radius: 12px;
      }
      #talk-fab { right: 16px; bottom: 16px; }
    }

  </style>
</head>

<body>
  <div id="app">
    <!-- SIDEBAR -->
    <aside id="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-text">DTO</div>
        <div class="sidebar-logo-subtitle">Digital Transformation Office</div>
      </div>

      <nav class="sidebar-nav">
        <a href="#/" class="nav-item active" data-route="overview">
          <span class="nav-icon"></span>
          <span class="nav-label"></span>
        </a>
        <a href="#/projects" class="nav-item" data-route="projects">
          <span class="nav-icon"></span>
          <span class="nav-label"></span>
        </a>
        <a href="#/timeline" class="nav-item" data-route="timeline">
          <span class="nav-icon"></span>
          <span class="nav-label"></span>
        </a>
        <a href="#/agents" class="nav-item" data-route="agents">
          <span class="nav-icon"></span>
          <span class="nav-label">Agent</span>
        </a>
        <a href="#/team" class="nav-item" data-route="team">
          <span class="nav-icon"></span>
          <span class="nav-label"></span>
        </a>
        <a href="#/actions" class="nav-item" data-route="actions">
          <span class="nav-icon"></span>
          <span class="nav-label">Actions</span>
        </a>
        <a href="#/settings" class="nav-item" data-route="settings">
          <span class="nav-icon"></span>
          <span class="nav-label"></span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="toggleTalkPanel()" style="border-top:1px solid var(--border,#e2e8f0);margin-top:8px;padding-top:12px;">
          <span class="nav-icon"></span>
          <span class="nav-label">Talk AI</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <button class="collapse-btn" onclick="toggleSidebar()" title="Toggle Sidebar"></button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content">
      <!-- TOPBAR -->
      <header id="topbar">
        <div class="topbar-left">
          <div id="breadcrumb">
            <span class="breadcrumb-item">Dashboard</span>
          </div>
          <div style="position: relative; flex: 1; max-width: 300px;">
            <span class="search-icon"></span>
            <input type="text" id="global-search" placeholder="..." oninput="handleSearch(this.value)" />
          </div>
        </div>

        <div class="topbar-right">
          <button id="notif-bell" onclick="toggleNotifPanel()" title="">
            
            <span class="notif-badge" id="notif-badge-count">0</span>
          </button>
          <button id="theme-toggle" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle Theme"></button>
          <button class="user-menu-btn" title="User Menu"></button>
          <div class="avatar"></div>
        </div>

        <!-- Notification Center Panel -->
        <div id="notif-panel">
          <div class="notif-header">
            <span> </span>
            <button onclick="markAllNotifsRead()"></button>
          </div>
          <div class="notif-list" id="notif-list"></div>
        </div>
      </header>

      <!-- VIEW CONTAINER -->
      <div id="view-container">
        <!-- Dynamic content will be rendered here -->
      </div>
    </main>
  </div>

  <!-- EDIT PANEL OVERLAY -->
  <div id="edit-overlay" class="edit-overlay hidden" onclick="closeEditPanel()"></div>

  <!-- EDIT PANEL -->
  <div id="edit-panel" class="edit-panel hidden">
    <div class="edit-panel-header">
      <h3 id="edit-panel-title">Edit Action Item</h3>
      <button class="btn-close" onclick="closeEditPanel()">&times;</button>
    </div>
    <div id="edit-panel-body" class="edit-panel-body">
      <!-- Dynamic form content will be rendered here -->
    </div>
    <div class="edit-panel-footer">
      <button class="btn btn-secondary" onclick="closeEditPanel()"></button>
      <button class="btn btn-primary" onclick="saveEdit()"></button>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toast-container"></div>

  <!-- MODAL OVERLAY -->
  <div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal()">
    <div id="modal-content" class="modal-content">
      <!-- Dynamic modal content will be rendered here -->
    </div>
  </div>

  <!-- ==================== TALK UI ==================== -->
  <button id="talk-fab" onclick="toggleTalkPanel()" title="Talk to AI Assistant">
    <span id="talk-fab-icon"></span>
    <div class="fab-badge"></div>
  </button>

  <div id="talk-panel">
    <div class="talk-header">
      <div class="talk-header-avatar"></div>
      <div class="talk-header-info">
        <h4>DTO Assistant</h4>
        <span id="talk-status-text"></span>
      </div>
      <div class="talk-header-actions">
        <button onclick="clearChatHistory()" title=""></button>
        <button onclick="toggleTalkPanel()" title=""></button>
      </div>
    </div>

    <div class="talk-messages" id="talk-messages">
      <!-- Messages rendered here -->
    </div>

    <div class="talk-typing" id="talk-typing">
      <span></span><span></span><span></span>
    </div>

    <div class="talk-suggestions" id="talk-suggestions">
      <button onclick="sendSuggestion('')"> </button>
      <button onclick="sendSuggestion('')"> </button>
      <button onclick="sendSuggestion('Agent ')"> Agent</button>
      <button onclick="sendSuggestion('')"> </button>
      <button onclick="sendSuggestion('')"> </button>
    </div>

    <div class="talk-input-area">
      <textarea id="talk-input" placeholder="..." rows="1"
        onkeydown="handleTalkKeydown(event)"
        oninput="autoResizeTalkInput(this)"></textarea>
      <button class="talk-send-btn" id="talk-send-btn" onclick="sendTalkMessage()" title=""></button>
    </div>
  </div>

  <script>
// ==================== DATA LAYER ====================
const APP_VERSION = '3.0.0';
const STORAGE_KEY = 'dto_dashboard_v3';

// ==================== SUPABASE CONFIG ====================
const SUPABASE_URL = 'https://akubvdnrbghxcujdfhzk.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrdWJ2ZG5yYmdoeGN1amRmaHprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MzQ3MzQsImV4cCI6MjA4NjExMDczNH0.uOCt7uh-9R_j22LiG0tF-Hupt6dXtOM-P-y9d4MZQCY';
let sb = null;
try { if (window.supabase) sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch(e) { console.warn('[Supabase] Init failed:', e); }

// ==================== DB  FRONTEND ADAPTERS ====================
const AUTO_DB2FE = { 'full': 'lead', 'supervised': 'specialist', 'manual': 'intern' };
const AUTO_FE2DB = { 'lead': 'full', 'specialist': 'supervised', 'intern': 'manual' };

function dbProjectToFE(dbP, dbActions) {
  return {
    id: dbP.id, code: dbP.code, name: dbP.name,
    description: dbP.metadata?.description || '',
    owner: dbP.owner || '',
    lead: dbP.metadata?.lead || '',
    startDate: dbP.start_date ? dbP.start_date.substring(0, 7) : '',
    endDate: dbP.end_date ? dbP.end_date.substring(0, 7) : '',
    status: dbP.status, progress: dbP.progress,
    color: dbP.color || '#3b82f6',
    actionItems: dbActions.filter(a => a.project_id === dbP.id).map(dbActionToFE)
  };
}

function dbActionToFE(a) {
  const m = a.notes ? a.notes.match(/\[M(\d+)-M(\d+)\]/) : null;
  return {
    id: a.id, name: a.title,
    breakdown: a.notes ? a.notes.replace(/\s*\[M\d+-M\d+\]\s*$/, '') : '',
    ownerUnit: a.category || '', owner: a.owner || '',
    status: a.status, priority: a.priority,
    startMonth: m ? parseInt(m[1]) : 1,
    endMonth: m ? parseInt(m[2]) : 12
  };
}

function dbAgentToFE(a) {
  let sched = {};
  try { sched = typeof a.schedule === 'string' ? JSON.parse(a.schedule) : (a.schedule || {}); } catch(e) {}
  return {
    id: a.id, name: a.name, emoji: a.emoji || '',
    role: a.role || '', description: a.description || '',
    status: a.status,
    autonomy: AUTO_DB2FE[a.autonomy] || a.autonomy,
    assignedProjects: a.assigned_projects || [],
    schedule: { ...sched, timezone: a.timezone || 'Asia/Taipei' },
    tools: a.skills || [],
    llmConfig: { provider: a.llm_provider || 'none', model: a.llm_model || '', temperature: a.llm_config?.temperature || 0.7 },
    metrics: {
      tasksCompleted: a.llm_config?.tasks_completed || 0,
      avgResponseTime: a.llm_config?.avg_response_time || '0s',
      reliability: a.llm_config?.reliability || 100,
      weeklyTasks: a.llm_config?.weekly_tasks || [0,0,0,0]
    },
    taskQueue: [],
    activityLog: [{ time: new Date().toISOString(), type: 'info', message: 'Loaded from cloud' }],
    createdAt: a.created_at ? a.created_at.split('T')[0] : new Date().toISOString().split('T')[0],
    updatedAt: a.updated_at ? a.updated_at.split('T')[0] : new Date().toISOString().split('T')[0]
  };
}

function dbWorkflowToFE(w) {
  return {
    id: w.id, name: w.name, description: w.description || '',
    trigger: { type: w.trigger_type, ...(w.trigger_config || {}) },
    steps: w.steps || [], status: w.status,
    lastRun: w.last_run || '', nextRun: w.trigger_config?.next_run || 'on-event'
  };
}

function feProjectToDb(p) {
  return {
    id: p.id, code: p.code, name: p.name, status: p.status, progress: p.progress,
    owner: p.owner || '',
    start_date: p.startDate ? (p.startDate.length === 7 ? p.startDate + '-01' : p.startDate) : null,
    end_date: p.endDate ? (p.endDate.length === 7 ? p.endDate + '-28' : p.endDate) : null,
    color: p.color || '#3b82f6',
    metadata: { description: p.description || '', lead: p.lead || '' }
  };
}

function feActionToDb(a, projectId) {
  return {
    id: a.id, project_id: projectId, title: a.name,
    status: a.status, priority: a.priority, owner: a.owner || '',
    due_date: a.endMonth ? ('2026-' + String(a.endMonth).padStart(2,'0') + '-28') : null,
    notes: (a.breakdown || '') + ' [M' + (a.startMonth||1) + '-M' + (a.endMonth||12) + ']',
    category: a.ownerUnit || ''
  };
}

function feAgentToDb(a) {
  const sched = { ...a.schedule }; const tz = sched.timezone || 'Asia/Taipei'; delete sched.timezone;
  return {
    id: a.id, name: a.name, emoji: a.emoji || '',
    role: a.role || '', description: a.description || '',
    status: a.status, autonomy: AUTO_FE2DB[a.autonomy] || 'supervised',
    llm_provider: a.llmConfig?.provider || 'none',
    llm_model: a.llmConfig?.model || '',
    llm_config: {
      temperature: a.llmConfig?.temperature || 0.7,
      tasks_completed: a.metrics?.tasksCompleted || 0,
      avg_response_time: a.metrics?.avgResponseTime || '0s',
      reliability: a.metrics?.reliability || 100,
      weekly_tasks: a.metrics?.weeklyTasks || [0,0,0,0]
    },
    skills: a.tools || [], mcp_servers: [],
    assigned_projects: a.assignedProjects || [],
    schedule: JSON.stringify(sched), timezone: tz
  };
}

function feWorkflowToDb(w) {
  const tc = { ...w.trigger }; delete tc.type;
  return {
    id: w.id, name: w.name, description: w.description || '',
    trigger_type: w.trigger?.type || 'manual', trigger_config: tc,
    steps: w.steps || [], status: w.status || 'active',
    last_run: w.lastRun || null
  };
}

// ==================== CLOUD SYNC ====================
let _syncTimer = null;
function scheduleCloudSync() {
  if (!sb) return;
  if (_syncTimer) clearTimeout(_syncTimer);
  _syncTimer = setTimeout(() => syncToCloud(), 2000);
}

async function syncToCloud() {
  if (!sb) return;
  try {
    const dbP = state.projects.map(feProjectToDb);
    if (dbP.length) await sb.from('projects').upsert(dbP, { onConflict: 'id' });
    const dbA = [];
    state.projects.forEach(p => (p.actionItems||[]).forEach(a => dbA.push(feActionToDb(a, p.id))));
    if (dbA.length) await sb.from('action_items').upsert(dbA, { onConflict: 'id' });
    const dbAg = state.agents.map(feAgentToDb);
    if (dbAg.length) await sb.from('agents').upsert(dbAg, { onConflict: 'id' });
    const dbW = state.workflows.map(feWorkflowToDb);
    if (dbW.length) await sb.from('workflows').upsert(dbW, { onConflict: 'id' });
    console.log('[Cloud]  Synced');
  } catch (err) { console.warn('[Cloud] Sync error:', err.message); }
}

async function deleteFromCloud(table, id) {
  if (!sb) return;
  try { await sb.from(table).delete().eq('id', id); } catch(e) { console.warn('[Cloud] Delete error:', e.message); }
}

async function loadFromCloud() {
  if (!sb) return false;
  try {
    const load = Promise.all([
      sb.from('projects').select('*').order('code'),
      sb.from('action_items').select('*'),
      sb.from('agents').select('*').order('created_at'),
      sb.from('workflows').select('*').order('created_at')
    ]);
    const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 5000));
    const [pR, aR, agR, wR] = await Promise.race([load, timeout]);
    if (pR.error) throw pR.error;
    state.projects = (pR.data||[]).map(p => dbProjectToFE(p, aR.data||[]));
    state.agents = (agR.data||[]).map(dbAgentToFE);
    state.workflows = (wR.data||[]).map(dbWorkflowToFE);
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { try { const ps = JSON.parse(saved); state.llmConfig = ps.llmConfig || {...llmConfig}; state.theme = ps.theme || 'system'; state.sidebarCollapsed = ps.sidebarCollapsed || false; } catch(e) {} }
    console.log('[Cloud]  Loaded:', state.projects.length, 'projects,', state.agents.length, 'agents,', state.workflows.length, 'workflows');
    return true;
  } catch (err) {
    console.warn('[Cloud] Load failed, using localStorage:', err.message);
    return false;
  }
}

// LLM Configuration (reserved for future AI integration)
let llmConfig = {
  provider: 'none', // 'openai' | 'anthropic' | 'local' | 'none'
  apiEndpoint: '',
  apiKey: '',
  modelName: '',
  localModelPath: '',
  maxTokens: 4096,
  temperature: 0.7
};

const defaultProjects = [
  {
    id: 1, name: "", code: "P1",
    description: "",
    owner: "", lead: "IT",
    startDate: "2026-01", endDate: "2026-12",
    status: "on_track", progress: 35,
    actionItems: [
      { id: 1, name: "", breakdown: "", ownerUnit: "", owner: "IT-PM", status: "completed", priority: "high", startMonth: 1, endMonth: 2 },
      { id: 2, name: "", breakdown: " BI/AI (Power BI, Tableau, Superset)", ownerUnit: "", owner: "IT", status: "in_progress", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 3, name: "POC ", breakdown: "", ownerUnit: "", owner: "IT-PM", status: "pending", priority: "high", startMonth: 3, endMonth: 4 },
      { id: 4, name: "", breakdown: " ERP/MES/HR ", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 4, endMonth: 6 },
      { id: 5, name: "Dashboard ", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 5, endMonth: 8 },
      { id: 6, name: "", breakdown: "", ownerUnit: "", owner: "IT-PM", status: "pending", priority: "low", startMonth: 8, endMonth: 9 },
      { id: 7, name: "", breakdown: "", ownerUnit: "", owner: "IT", status: "pending", priority: "high", startMonth: 9, endMonth: 10 },
      { id: 49, name: "AI ", breakdown: " AI ", ownerUnit: "", owner: "AI", status: "pending", priority: "medium", startMonth: 7, endMonth: 10 }
    ]
  },
  {
    id: 2, name: "", code: "P2",
    description: "RPA",
    owner: "", lead: "",
    startDate: "2026-01", endDate: "2026-12",
    status: "on_track", progress: 25,
    actionItems: [
      { id: 8, name: "", breakdown: "", ownerUnit: "", owner: "IE", status: "completed", priority: "high", startMonth: 1, endMonth: 2 },
      { id: 9, name: "RPA ", breakdown: " UiPath/Power Automate/", ownerUnit: "", owner: "IT", status: "in_progress", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 10, name: "Pilot ", breakdown: " 3  RPA ", ownerUnit: "", owner: "", status: "pending", priority: "high", startMonth: 3, endMonth: 5 },
      { id: 11, name: "", breakdown: " ROI ", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 5, endMonth: 6 },
      { id: 12, name: "", breakdown: " 10+ ", ownerUnit: "", owner: "RPA", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 13, name: "", breakdown: " RPA ", ownerUnit: "", owner: "IT", status: "pending", priority: "medium", startMonth: 9, endMonth: 11 },
      { id: 14, name: "", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "low", startMonth: 11, endMonth: 12 },
      { id: 50, name: "", breakdown: " Process Mining ", ownerUnit: "", owner: "IE", status: "pending", priority: "low", startMonth: 8, endMonth: 11 }
    ]
  },
  {
    id: 3, name: "API/ETL", code: "P3",
    description: "",
    owner: "", lead: "",
    startDate: "2026-02", endDate: "2026-11",
    status: "at_risk", progress: 15,
    actionItems: [
      { id: 15, name: "", breakdown: "", ownerUnit: "", owner: "", status: "completed", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 16, name: "API Gateway ", breakdown: " Kong/AWS API GW/", ownerUnit: "", owner: "", status: "in_progress", priority: "high", startMonth: 3, endMonth: 4 },
      { id: 17, name: "ETL Pipeline ", breakdown: " Airflow/dbt ", ownerUnit: "", owner: "", status: "pending", priority: "high", startMonth: 4, endMonth: 7 },
      { id: 18, name: "API ", breakdown: " RESTful API ", ownerUnit: "", owner: "", status: "in_progress", priority: "medium", startMonth: 3, endMonth: 4 },
      { id: 19, name: " API ", breakdown: " ERP/MES/HR  API", ownerUnit: "", owner: "", status: "pending", priority: "high", startMonth: 4, endMonth: 8 },
      { id: 20, name: "", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 7, endMonth: 9 },
      { id: 21, name: "", breakdown: "API ", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 9, endMonth: 11 },
      { id: 51, name: "Data Catalog", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 8, endMonth: 10 }
    ]
  },
  {
    id: 4, name: "", code: "P4",
    description: "",
    owner: "", lead: "",
    startDate: "2026-01", endDate: "2026-12",
    status: "on_track", progress: 30,
    actionItems: [
      { id: 22, name: "", breakdown: "", ownerUnit: "", owner: "", status: "completed", priority: "high", startMonth: 1, endMonth: 2 },
      { id: 23, name: "Zero Trust ", breakdown: "", ownerUnit: "", owner: "", status: "in_progress", priority: "high", startMonth: 2, endMonth: 5 },
      { id: 24, name: "SIEM ", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "high", startMonth: 3, endMonth: 6 },
      { id: 25, name: "", breakdown: "()", ownerUnit: "", owner: "", status: "in_progress", priority: "medium", startMonth: 2, endMonth: 4 },
      { id: 26, name: "", breakdown: " EDR/MDR ", ownerUnit: "", owner: "", status: "pending", priority: "high", startMonth: 5, endMonth: 7 },
      { id: 27, name: "", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 7, endMonth: 9 },
      { id: 28, name: "ISO 27001 ", breakdown: " ISO 27001 ", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 9, endMonth: 12 },
      { id: 29, name: "", breakdown: " DR/BCP ", ownerUnit: "", owner: "IT", status: "pending", priority: "high", startMonth: 6, endMonth: 8 },
      { id: 53, name: "", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 }
    ]
  },
  {
    id: 5, name: "", code: "P5",
    description: "",
    owner: "", lead: "HR",
    startDate: "2026-02", endDate: "2026-12",
    status: "on_track", progress: 20,
    actionItems: [
      { id: 30, name: "", breakdown: "", ownerUnit: "", owner: "", status: "completed", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 31, name: "", breakdown: " LMS ", ownerUnit: "", owner: "HR-IT", status: "in_progress", priority: "high", startMonth: 3, endMonth: 5 },
      { id: 32, name: "", breakdown: " AI/Data/RPA ", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 4, endMonth: 7 },
      { id: 33, name: "", breakdown: "", ownerUnit: "", owner: "HR", status: "pending", priority: "medium", startMonth: 5, endMonth: 8 },
      { id: 34, name: "", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 35, name: "", breakdown: "", ownerUnit: "", owner: "HR", status: "pending", priority: "low", startMonth: 8, endMonth: 12 },
      { id: 52, name: "AI ", breakdown: " AI ", ownerUnit: "", owner: "", status: "pending", priority: "high", startMonth: 4, endMonth: 6 }
    ]
  },
  {
    id: 6, name: "", code: "P6",
    description: "",
    owner: "", lead: "",
    startDate: "2026-03", endDate: "2026-12",
    status: "delayed", progress: 10,
    actionItems: [
      { id: 36, name: "", breakdown: "", ownerUnit: "", owner: "", status: "in_progress", priority: "high", startMonth: 3, endMonth: 4 },
      { id: 37, name: "CRM ", breakdown: " CRM ", ownerUnit: "", owner: "IT", status: "pending", priority: "high", startMonth: 4, endMonth: 7 },
      { id: 38, name: " Chatbot", breakdown: " AI ", ownerUnit: "", owner: "AI", status: "pending", priority: "medium", startMonth: 5, endMonth: 8 },
      { id: 39, name: "", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 40, name: "NPS/CSAT ", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "low", startMonth: 8, endMonth: 10 },
      { id: 41, name: "", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 10, endMonth: 12 }
    ]
  },
  {
    id: 7, name: "", code: "P7",
    description: "",
    owner: "", lead: "",
    startDate: "2026-03", endDate: "2026-12",
    status: "on_track", progress: 15,
    actionItems: [
      { id: 42, name: "IoT ", breakdown: " IoT ", ownerUnit: "", owner: "", status: "in_progress", priority: "high", startMonth: 3, endMonth: 5 },
      { id: 43, name: "", breakdown: "", ownerUnit: "", owner: "IoT", status: "pending", priority: "high", startMonth: 4, endMonth: 6 },
      { id: 44, name: "", breakdown: "", ownerUnit: "", owner: "AI", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 45, name: "", breakdown: "", ownerUnit: "", owner: "MES", status: "pending", priority: "medium", startMonth: 5, endMonth: 7 },
      { id: 46, name: "AI", breakdown: " AI ", ownerUnit: "", owner: "", status: "pending", priority: "medium", startMonth: 7, endMonth: 10 },
      { id: 47, name: "MES ", breakdown: "MES  IoT ", ownerUnit: "", owner: "MES", status: "pending", priority: "high", startMonth: 8, endMonth: 11 },
      { id: 48, name: " POC", breakdown: "", ownerUnit: "", owner: "", status: "pending", priority: "low", startMonth: 10, endMonth: 12 }
    ]
  }
];

// ==================== AGENT DATA ====================
const defaultAgents = [
  {
    id: "agent-001", name: "Jarvis", emoji: "",
    role: "Lead Orchestrator",
    description: "",
    status: "active", autonomy: "lead",
    assignedProjects: [1, 2, 3, 4, 5, 6, 7],
    schedule: { type: "daily", time: "08:00", timezone: "Asia/Taipei" },
    tools: ["kpi-monitor", "report-gen", "notification", "task-assign"],
    llmConfig: { provider: "anthropic", model: "claude-sonnet-4-5-20250929", temperature: 0.7 },
    metrics: { tasksCompleted: 42, avgResponseTime: "2.3s", reliability: 98.5, weeklyTasks: [8, 12, 10, 12] },
    taskQueue: [
      { id: "t1", title: "", status: "pending", priority: "high", dueDate: "2026-02-10" },
      { id: "t2", title: "3", status: "in_progress", priority: "high", dueDate: "2026-02-09" },
      { id: "t3", title: "", status: "completed", priority: "medium", completedAt: "2026-02-07" }
    ],
    activityLog: [
      { time: "2026-02-08 09:30", type: "info", message: "" },
      { time: "2026-02-08 09:15", type: "alert", message: "6" },
      { time: "2026-02-07 17:00", type: "success", message: "" },
      { time: "2026-02-07 09:00", type: "info", message: "" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-002", name: "Analyst", emoji: "",
    role: "Data & KPI Specialist",
    description: " KPI ",
    status: "active", autonomy: "specialist",
    assignedProjects: [1, 3, 7],
    schedule: { type: "weekly", day: "monday", time: "09:00", timezone: "Asia/Taipei" },
    tools: ["kpi-monitor", "trend-analysis", "report-gen", "data-viz"],
    llmConfig: { provider: "openai", model: "gpt-4o", temperature: 0.3 },
    metrics: { tasksCompleted: 28, avgResponseTime: "5.1s", reliability: 96.2, weeklyTasks: [5, 7, 8, 8] },
    taskQueue: [
      { id: "t4", title: "KPI", status: "pending", priority: "high", dueDate: "2026-02-10" },
      { id: "t5", title: "1", status: "completed", priority: "medium", completedAt: "2026-02-07" }
    ],
    activityLog: [
      { time: "2026-02-08 10:00", type: "info", message: " KPI " },
      { time: "2026-02-07 14:00", type: "success", message: "1" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-003", name: "Tracker", emoji: "",
    role: "PM & Deadline Monitor",
    description: "",
    status: "active", autonomy: "specialist",
    assignedProjects: [1, 2, 3, 4, 5, 6, 7],
    schedule: { type: "daily", time: "07:00", timezone: "Asia/Taipei" },
    tools: ["deadline-check", "progress-calc", "notification", "calendar-sync"],
    llmConfig: { provider: "none", model: "", temperature: 0 },
    metrics: { tasksCompleted: 156, avgResponseTime: "0.8s", reliability: 99.1, weeklyTasks: [35, 42, 38, 41] },
    taskQueue: [
      { id: "t6", title: "", status: "in_progress", priority: "high", dueDate: "2026-02-08" },
      { id: "t7", title: "", status: "pending", priority: "medium", dueDate: "2026-02-09" }
    ],
    activityLog: [
      { time: "2026-02-08 07:30", type: "alert", message: "315%" },
      { time: "2026-02-08 07:15", type: "info", message: "" },
      { time: "2026-02-07 07:00", type: "info", message: "2" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-004", name: "Sentinel", emoji: "",
    role: "Risk Detection",
    description: "",
    status: "active", autonomy: "specialist",
    assignedProjects: [3, 4, 6],
    schedule: { type: "continuous", interval: "30min" },
    tools: ["risk-scorer", "dependency-map", "anomaly-detect", "notification"],
    llmConfig: { provider: "local", model: "llama-3.1-8b", temperature: 0.2 },
    metrics: { tasksCompleted: 89, avgResponseTime: "1.2s", reliability: 97.8, weeklyTasks: [20, 22, 25, 22] },
    taskQueue: [
      { id: "t8", title: "6", status: "in_progress", priority: "high", dueDate: "2026-02-08" },
      { id: "t9", title: "", status: "pending", priority: "medium", dueDate: "2026-02-10" }
    ],
    activityLog: [
      { time: "2026-02-08 08:45", type: "alert", message: "6" },
      { time: "2026-02-08 08:00", type: "warning", message: "3 API" },
      { time: "2026-02-07 16:00", type: "info", message: "21" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-005", name: "Scribe", emoji: "",
    role: "Documentation & Reports",
    description: "",
    status: "idle", autonomy: "intern",
    assignedProjects: [1, 2, 5],
    schedule: { type: "weekly", day: "friday", time: "16:00", timezone: "Asia/Taipei" },
    tools: ["report-gen", "template-engine", "doc-format", "summary-gen"],
    llmConfig: { provider: "anthropic", model: "claude-sonnet-4-5-20250929", temperature: 0.5 },
    metrics: { tasksCompleted: 15, avgResponseTime: "8.5s", reliability: 94.0, weeklyTasks: [3, 4, 4, 4] },
    taskQueue: [
      { id: "t10", title: "", status: "pending", priority: "high", dueDate: "2026-02-14" }
    ],
    activityLog: [
      { time: "2026-02-07 16:30", type: "success", message: "" },
      { time: "2026-02-07 16:00", type: "info", message: "6" }
    ],
    createdAt: "2026-01-20", updatedAt: "2026-02-07"
  },
  {
    id: "agent-006", name: "Connector", emoji: "",
    role: "Integration & Data Sync",
    description: " API ",
    status: "paused", autonomy: "specialist",
    assignedProjects: [3, 7],
    schedule: { type: "hourly", interval: "1h" },
    tools: ["api-sync", "webhook-manager", "data-transform", "health-check"],
    llmConfig: { provider: "none", model: "", temperature: 0 },
    metrics: { tasksCompleted: 312, avgResponseTime: "1.5s", reliability: 95.3, weeklyTasks: [70, 78, 82, 82] },
    taskQueue: [
      { id: "t11", title: " Google Sheets ", status: "pending", priority: "high", dueDate: "2026-02-09" },
      { id: "t12", title: " Jira webhook", status: "pending", priority: "medium", dueDate: "2026-02-12" }
    ],
    activityLog: [
      { time: "2026-02-08 06:00", type: "error", message: "Google Sheets API " },
      { time: "2026-02-07 23:00", type: "info", message: "" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  }
];

const defaultWorkflows = [
  {
    id: "wf-001", name: "", description: "",
    trigger: { type: "schedule", cron: "0 9 * * 1", label: " 09:00" },
    steps: [
      { agent: "Analyst", action: " KPI ", output: "KPI " },
      { agent: "Tracker", action: "", output: "" },
      { agent: "Scribe", action: "", output: "" },
      { agent: "Jarvis", action: "", output: "" }
    ],
    status: "active", lastRun: "2026-02-03 09:00", nextRun: "2026-02-10 09:00"
  },
  {
    id: "wf-002", name: "", description: "",
    trigger: { type: "event", event: "status_change_to_risk", label: "/" },
    steps: [
      { agent: "Sentinel", action: "", output: "" },
      { agent: "Analyst", action: "", output: "" },
      { agent: "Jarvis", action: "", output: "" },
      { agent: "Connector", action: "", output: "" }
    ],
    status: "active", lastRun: "2026-02-08 08:45", nextRun: "on-event"
  },
  {
    id: "wf-003", name: "", description: "",
    trigger: { type: "event", event: "data_change", label: "" },
    steps: [
      { agent: "Tracker", action: "", output: "" },
      { agent: "Analyst", action: " KPI", output: "" },
      { agent: "Scribe", action: "", output: "" },
      { agent: "Connector", action: "", output: "" }
    ],
    status: "active", lastRun: "2026-02-08 10:00", nextRun: "on-event"
  }
];

// ==================== STATE MANAGEMENT ====================
let state = {
  projects: [],
  agents: [],
  workflows: [],
  llmConfig: {...llmConfig},
  currentRoute: '/',
  sidebarCollapsed: false,
  theme: 'system',
  editingItem: null,
  searchQuery: '',
  agentDetailTab: 'queue',
  chatMessages: [],
  talkPanelOpen: false
};

function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      state.projects = parsed.projects || JSON.parse(JSON.stringify(defaultProjects));
      state.agents = parsed.agents || JSON.parse(JSON.stringify(defaultAgents));
      state.workflows = parsed.workflows || JSON.parse(JSON.stringify(defaultWorkflows));
      state.llmConfig = parsed.llmConfig || {...llmConfig};
      state.theme = parsed.theme || 'system';
      state.sidebarCollapsed = parsed.sidebarCollapsed || false;
    } catch(e) {
      resetToDefaults();
    }
  } else {
    resetToDefaults();
  }
}

function resetToDefaults() {
  state.projects = JSON.parse(JSON.stringify(defaultProjects));
  state.agents = JSON.parse(JSON.stringify(defaultAgents));
  state.workflows = JSON.parse(JSON.stringify(defaultWorkflows));
  state.llmConfig = {...llmConfig};
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    projects: state.projects,
    agents: state.agents,
    workflows: state.workflows,
    llmConfig: state.llmConfig,
    theme: state.theme,
    sidebarCollapsed: state.sidebarCollapsed
  }));
  scheduleCloudSync();
}

// ==================== ROUTER ====================
const routes = {
  '/': renderOverview,
  '/projects': renderProjectsList,
  '/projects/:id': renderProjectDetail,
  '/projects/:id/actions/:aid': renderActionDetail,
  '/timeline': renderTimeline,
  '/agents': renderAgentSquad,
  '/agents/workflows': renderWorkflows,
  '/agents/activity': renderAgentActivity,
  '/agents/:id': renderAgentDetail,
  '/team': renderTeam,
  '/team/:name': renderTeamMemberDetail,
  '/actions': renderAllActions,
  '/settings': renderSettings
};

function navigateTo(path) {
  window.location.hash = path;
}

function parseRoute(hash) {
  const path = hash.replace('#', '') || '/';
  if (routes[path]) return { handler: routes[path], params: {} };

  for (const [pattern, handler] of Object.entries(routes)) {
    const patternParts = pattern.split('/');
    const pathParts = path.split('/');
    if (patternParts.length !== pathParts.length) continue;

    const params = {};
    let match = true;
    for (let i = 0; i < patternParts.length; i++) {
      if (patternParts[i].startsWith(':')) {
        params[patternParts[i].slice(1)] = decodeURIComponent(pathParts[i]);
      } else if (patternParts[i] !== pathParts[i]) {
        match = false;
        break;
      }
    }
    if (match) return { handler, params };
  }
  return { handler: renderOverview, params: {} };
}

function handleRoute() {
  const { handler, params } = parseRoute(window.location.hash);
  state.currentRoute = window.location.hash.replace('#', '') || '/';
  updateSidebarActive();
  updateBreadcrumb();
  const container = document.getElementById('view-container');
  container.innerHTML = '';
  container.className = 'view-container fade-in';
  handler(container, params);
}

window.addEventListener('hashchange', handleRoute);

// ==================== THEME SYSTEM ====================
function initTheme() {
  const saved = state.theme || 'system';
  setTheme(saved);

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (state.theme === 'system') {
      document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
    }
  });
}

function setTheme(theme) {
  state.theme = theme;
  if (theme === 'system') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  } else {
    document.documentElement.setAttribute('data-theme', theme);
  }
  const btn = document.getElementById('theme-toggle');
  if (btn) {
    const current = document.documentElement.getAttribute('data-theme');
    btn.textContent = current === 'dark' ? '' : '';
  }
  saveState();
}

function cycleTheme() {
  const themes = ['light', 'dark', 'system'];
  const idx = themes.indexOf(state.theme);
  setTheme(themes[(idx + 1) % themes.length]);
  showToast(`: ${state.theme === 'system' ? '' : state.theme === 'dark' ? '' : ''}`);
}

// ==================== UTILITY FUNCTIONS ====================
function updateSidebarActive() {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
    const route = item.getAttribute('data-route');
    const currentPath = state.currentRoute || '/';
    if (route === 'overview' && currentPath === '/') {
      item.classList.add('active');
    } else if (route !== 'overview' && currentPath.startsWith('/' + route)) {
      item.classList.add('active');
    }
  });
}

function updateBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  if (!bc) return;
  const parts = state.currentRoute.split('/').filter(Boolean);
  let html = '<a href="#/" class="bc-link"> </a>';
  const routeMap = {
    'projects': '', 'timeline': '', 'agents': '',
    'team': '', 'actions': 'Action Items', 'settings': '',
    'workflows': '', 'activity': ''
  };

  let path = '';
  parts.forEach((part, i) => {
    path += '/' + part;
    const label = routeMap[part] || (isNaN(part) ? decodeURIComponent(part) : getNameById(parts, part));
    if (i === parts.length - 1) {
      html += ` <span class="bc-sep"></span> <span class="bc-current">${label}</span>`;
    } else {
      html += ` <span class="bc-sep"></span> <a href="#${path}" class="bc-link">${label}</a>`;
    }
  });
  bc.innerHTML = html;
}

function getNameById(parts, id) {
  if (parts.includes('projects')) {
    const p = state.projects.find(p => p.id == id);
    return p ? p.name : ` ${id}`;
  }
  if (parts.includes('agents')) {
    const a = state.agents.find(a => a.id === id || a.id === `agent-${id.padStart(3,'0')}`);
    return a ? a.name : `Agent ${id}`;
  }
  return id;
}

function toggleSidebar() {
  state.sidebarCollapsed = !state.sidebarCollapsed;
  document.body.classList.toggle('sidebar-collapsed', state.sidebarCollapsed);
  saveState();
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function getStatusBadge(status) {
  const map = {
    'completed': '<span class="badge badge-success"></span>',
    'in_progress': '<span class="badge badge-info"></span>',
    'pending': '<span class="badge badge-warning"></span>',
    'on_track': '<span class="badge badge-success"></span>',
    'at_risk': '<span class="badge badge-warning"></span>',
    'delayed': '<span class="badge badge-danger"></span>',
    'active': '<span class="badge badge-success"></span>',
    'idle': '<span class="badge badge-warning"></span>',
    'paused': '<span class="badge badge-secondary"></span>',
    'error': '<span class="badge badge-danger"></span>'
  };
  return map[status] || `<span class="badge">${status}</span>`;
}

function getPriorityBadge(priority) {
  const map = {
    'high': '<span class="badge badge-danger"></span>',
    'medium': '<span class="badge badge-warning"></span>',
    'low': '<span class="badge badge-info"></span>'
  };
  return map[priority] || '';
}

function getAllActionItems() {
  const items = [];
  state.projects.forEach(p => {
    p.actionItems.forEach(a => {
      items.push({ ...a, projectId: p.id, projectName: p.name, projectCode: p.code });
    });
  });
  return items;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  return dateStr;
}

function openEditPanel(projectId, actionId) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const action = project.actionItems.find(a => a.id === actionId);
  if (!action) return;

  state.editingItem = { projectId, actionId };

  const body = document.getElementById('edit-panel-body');
  body.innerHTML = `
    <div class="form-group">
      <label class="form-label"></label>
      <input class="form-input" value="${project.name}" disabled>
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <input class="form-input" id="edit-name" value="${action.name}">
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <textarea class="form-textarea" id="edit-breakdown" rows="3">${action.breakdown}</textarea>
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <input class="form-input" id="edit-unit" value="${action.ownerUnit}">
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <input class="form-input" id="edit-owner" value="${action.owner}">
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <select class="form-select" id="edit-status">
        <option value="pending" ${action.status==='pending'?'selected':''}></option>
        <option value="in_progress" ${action.status==='in_progress'?'selected':''}></option>
        <option value="completed" ${action.status==='completed'?'selected':''}></option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <select class="form-select" id="edit-priority">
        <option value="high" ${action.priority==='high'?'selected':''}></option>
        <option value="medium" ${action.priority==='medium'?'selected':''}></option>
        <option value="low" ${action.priority==='low'?'selected':''}></option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <input type="number" class="form-input" id="edit-start" value="${action.startMonth}" min="1" max="12">
    </div>
    <div class="form-group">
      <label class="form-label"></label>
      <input type="number" class="form-input" id="edit-end" value="${action.endMonth}" min="1" max="12">
    </div>
  `;

  document.getElementById('edit-overlay').classList.remove('hidden');
  document.getElementById('edit-panel').classList.remove('hidden');

  document.addEventListener('keydown', editPanelEscHandler);
}

function editPanelEscHandler(e) {
  if (e.key === 'Escape') closeEditPanel();
}

function closeEditPanel() {
  document.getElementById('edit-overlay').classList.add('hidden');
  document.getElementById('edit-panel').classList.add('hidden');
  state.editingItem = null;
  document.removeEventListener('keydown', editPanelEscHandler);
}

function saveEdit() {
  if (!state.editingItem) return;
  const { projectId, actionId } = state.editingItem;
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const action = project.actionItems.find(a => a.id === actionId);
  if (!action) return;

  action.name = document.getElementById('edit-name').value;
  action.breakdown = document.getElementById('edit-breakdown').value;
  action.ownerUnit = document.getElementById('edit-unit').value;
  action.owner = document.getElementById('edit-owner').value;
  action.status = document.getElementById('edit-status').value;
  action.priority = document.getElementById('edit-priority').value;
  action.startMonth = parseInt(document.getElementById('edit-start').value);
  action.endMonth = parseInt(document.getElementById('edit-end').value);

  const total = project.actionItems.length;
  const completed = project.actionItems.filter(a => a.status === 'completed').length;
  project.progress = Math.round((completed / total) * 100);

  const hasDelayed = project.actionItems.some(a => a.status === 'delayed');
  const hasAtRisk = project.actionItems.some(a => {
    const now = new Date().getMonth() + 1;
    return a.status === 'pending' && a.startMonth <= now;
  });
  if (hasDelayed) project.status = 'delayed';
  else if (hasAtRisk) project.status = 'at_risk';
  else project.status = 'on_track';

  saveState();
  closeEditPanel();
  handleRoute();
  showToast('', 'success');
}

function handleSearch(query) {
  state.searchQuery = query.toLowerCase();
  if (!query) {
    handleRoute();
    return;
  }
  navigateTo('/actions');
}

function exportData() {
  const data = {
    version: APP_VERSION,
    exportDate: new Date().toISOString(),
    projects: state.projects,
    agents: state.agents,
    workflows: state.workflows,
    llmConfig: state.llmConfig
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dto_dashboard_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('', 'success');
}

function importData(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.projects) state.projects = data.projects;
      if (data.agents) state.agents = data.agents;
      if (data.workflows) state.workflows = data.workflows;
      if (data.llmConfig) state.llmConfig = data.llmConfig;
      saveState();
      handleRoute();
      showToast('', 'success');
    } catch(err) {
      showToast('', 'error');
    }
  };
  reader.readAsText(file);
}

function exportCSV() {
  const items = getAllActionItems();
  const headers = ['','','ID','','','','','','','',''];
  const rows = items.map(i => [i.projectCode, i.projectName, i.id, i.name, i.breakdown, i.ownerUnit, i.owner, i.status, i.priority, i.startMonth, i.endMonth]);
  const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dto_action_items_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV ', 'success');
}

function showModal(titleOrHtml, contentHtml, options) {
  const mc = document.getElementById('modal-content');
  if (contentHtml) {
    mc.innerHTML = '<div style="padding:20px"><h3 style="margin:0 0 16px">' + titleOrHtml + '</h3>' + contentHtml + '</div>';
  } else {
    mc.innerHTML = titleOrHtml;
  }
  if (options && options.width) mc.style.maxWidth = options.width;
  else mc.style.maxWidth = '600px';
  document.getElementById('modal-overlay').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
  document.getElementById('modal-content').style.maxWidth = '';
}
/**
 * DTO Dashboard v3.0 - Main View Render Functions
 * Renders HTML for all primary views into container elements
 * References global state object and utility functions
 */

/**
 * renderOverview(container, params)
 * Command Center / Dashboard overview page
 */
function renderOverview(container, params) {
  const allItems = getAllActionItems();
  const completedCount = allItems.filter(i => i.status === 'completed').length;
  const completionPercent = allItems.length > 0 ? Math.round((completedCount / allItems.length) * 100) : 0;
  const riskCount = state.projects.filter(p => p.status === 'at_risk' || p.status === 'delayed').length;

  // Collect and sort activity logs
  const activityLogs = [];
  state.projects.forEach(p => {
    if (p.activityLog && Array.isArray(p.activityLog)) {
      p.activityLog.forEach(log => {
        activityLogs.push({...log, projectCode: p.code});
      });
    }
  });
  activityLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  const recentActivity = activityLogs.slice(0, 8);

  const today = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });

  let html = `
    <div class="view-overview">
      <div class="view-header">
        <h1> DTO Command Center</h1>
        <span class="text-muted">${today}</span>
      </div>

      <!-- Quick Stats Row -->
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-icon"></div>
          <div class="stat-content">
            <div class="stat-label"></div>
            <div class="stat-value">${state.projects.length}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"></div>
          <div class="stat-content">
            <div class="stat-label">Action Items</div>
            <div class="stat-value">${allItems.length}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"></div>
          <div class="stat-content">
            <div class="stat-label"></div>
            <div class="stat-value">${completionPercent}%</div>
            <div class="progress-bar" style="height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 8px;">
              <div style="height: 100%; background: #22c55e; width: ${completionPercent}%; border-radius: 2px;"></div>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"></div>
          <div class="stat-content">
            <div class="stat-label"></div>
            <div class="stat-value">${riskCount}</div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="chart-grid">
        <div class="card">
          <h3>Project Progress</h3>
          <div style="position:relative;height:250px;max-height:250px;overflow:hidden;">
            <canvas id="chart-progress"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>Status Distribution</h3>
          <div style="position:relative;height:250px;max-height:250px;overflow:hidden;">
            <canvas id="chart-status"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>Monthly Timeline</h3>
          <div style="position:relative;height:250px;max-height:250px;overflow:hidden;">
            <canvas id="chart-timeline"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>Owner Workload</h3>
          <div style="position:relative;height:250px;max-height:250px;overflow:hidden;">
            <canvas id="chart-workload"></canvas>
          </div>
        </div>
      </div>

      <!-- Agent Squad Quick Panel -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3> Agent Squad </h3>
          <a onclick="navigateTo('/agents')" style="cursor:pointer;color:var(--accent);font-size:13px;"> </a>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;">
          ${(state.agents || []).map(ag => {
            const statusColor = ag.status === 'active' ? '#22c55e' : ag.status === 'paused' ? '#94a3b8' : '#f59e0b';
            const qLen = ag.taskQueue?.filter(t => t.status !== 'completed').length || 0;
            return '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-secondary);border-radius:8px;border-left:3px solid ' + statusColor + ';">' +
              '<span style="font-size:20px;">' + (ag.emoji || '') + '</span>' +
              '<div style="flex:1;min-width:0;">' +
                '<div style="font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + ag.name + '</div>' +
                '<div style="font-size:11px;color:var(--text-secondary);">' + (ag.currentTask ? ag.currentTask.substring(0, 25) : '') + '</div>' +
              '</div>' +
              '<span style="background:' + (qLen > 0 ? 'var(--accent)' : 'var(--bg-tertiary)') + ';color:' + (qLen > 0 ? '#fff' : 'var(--text-secondary)') + ';font-size:11px;padding:2px 7px;border-radius:10px;">' + qLen + '</span>' +
            '</div>';
          }).join('')}
        </div>
      </div>

      <!-- Recent Activity Section (combined project + agent) -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3> </h3>
          <a onclick="navigateTo('/agents/activity')" style="cursor:pointer;color:var(--accent);font-size:13px;"> </a>
        </div>
        <div class="activity-list" id="overview-activity-feed">
          ${recentActivity.length > 0 ? recentActivity.map(log => {
            const time = new Date(log.timestamp).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
            const emoji = log.agent === 'system' ? '' : '';
            return '<div class="activity-item">' +
              '<span>' + emoji + ' <strong>' + (log.agent || 'System') + '</strong> ' + log.message + '</span>' +
              '<span class="text-muted">' + time + '</span>' +
            '</div>';
          }).join('') : '<div class="text-muted">   Talk AI  Agent </div>'}
        </div>
      </div>

      <!-- Upcoming Deadlines -->
      <div class="card">
        <h3> </h3>
        <div class="activity-list">
          ${(() => {
            const now = new Date().getMonth() + 1;
            const upcoming = [];
            state.projects.forEach(p => {
              (p.actionItems || []).forEach(a => {
                if (a.status !== 'completed' && a.endMonth && a.endMonth >= now && a.endMonth <= now + 2) {
                  upcoming.push({ name: a.name, owner: a.owner, endMonth: a.endMonth, project: p.code, status: a.status, priority: a.priority });
                }
              });
            });
            upcoming.sort((a, b) => a.endMonth - b.endMonth);
            if (upcoming.length === 0) return '<div class="text-muted"></div>';
            return upcoming.slice(0, 8).map(u => {
              const urgency = u.endMonth === now ? 'color:#ef4444;font-weight:600;' : u.endMonth === now + 1 ? 'color:#f59e0b;' : 'color:var(--text-secondary);';
              return '<div class="activity-item">' +
                '<span style="' + urgency + '">M' + u.endMonth + '</span> ' +
                '<span class="tag" style="font-size:10px;padding:1px 6px;">' + u.project + '</span> ' +
                '<span>' + u.name + '</span>' +
                '<span class="text-muted" style="margin-left:auto;">' + (u.owner || '-') + '</span>' +
              '</div>';
            }).join('');
          })()}
        </div>
      </div>

      <!-- Quick Actions Row -->
      <div class="action-buttons">
        <button onclick="exportData()" class="btn btn-secondary"> JSON</button>
        <button onclick="exportCSV()" class="btn btn-secondary"> CSV</button>
        <button onclick="toggleTalkPanel()" class="btn btn-primary"> Talk AI</button>
      </div>
    </div>
  `;

  container.innerHTML = html;

  // Initialize charts after DOM is ready
  setTimeout(() => {
    initOverviewCharts();
  }, 100);
}

// Store chart instances for cleanup
let chartInstances = [];

function destroyAllCharts() {
  chartInstances.forEach(c => { try { c.destroy(); } catch(e) {} });
  chartInstances = [];
}

function initOverviewCharts() {
  // Destroy previous charts to prevent infinite growth
  destroyAllCharts();

  // Chart 1: Project Progress (horizontal bar)
  const ctx1 = document.getElementById('chart-progress');
  if (ctx1 && typeof Chart !== 'undefined') {
    chartInstances.push(new Chart(ctx1.getContext('2d'), {
      type: 'bar',
      data: {
        labels: state.projects.map(p => p.code),
        datasets: [{
          label: ' %',
          data: state.projects.map(p => p.progress || 0),
          backgroundColor: state.projects.map(p => {
            if (p.status === 'delayed') return '#ef4444';
            if (p.status === 'at_risk') return '#f59e0b';
            return '#22c55e';
          }),
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            max: 100,
            ticks: { callback: v => v + '%' }
          }
        }
      }
    }));
  }

  // Chart 2: Status Distribution (doughnut)
  const ctx2 = document.getElementById('chart-status');
  if (ctx2 && typeof Chart !== 'undefined') {
    const statuses = {};
    state.projects.forEach(p => {
      statuses[p.status] = (statuses[p.status] || 0) + 1;
    });
    chartInstances.push(new Chart(ctx2.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(statuses),
        datasets: [{
          data: Object.values(statuses),
          backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    }));
  }

  // Chart 3: Monthly Timeline (stacked bar)
  const ctx3 = document.getElementById('chart-timeline');
  if (ctx3 && typeof Chart !== 'undefined') {
    const monthCounts = Array(12).fill(0);
    getAllActionItems().forEach(item => {
      for (let m = (item.startMonth || 1) - 1; m < (item.endMonth || 12); m++) {
        if (m >= 0 && m < 12) monthCounts[m]++;
      }
    });
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    chartInstances.push(new Chart(ctx3.getContext('2d'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [{
          label: 'Active Items',
          data: monthCounts,
          backgroundColor: '#3b82f6',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    }));
  }

  // Chart 4: Owner Workload (bar)
  const ctx4 = document.getElementById('chart-workload');
  if (ctx4 && typeof Chart !== 'undefined') {
    const ownerCounts = {};
    getAllActionItems().forEach(item => {
      const owner = item.owner || 'Unassigned';
      ownerCounts[owner] = (ownerCounts[owner] || 0) + 1;
    });
    const topOwners = Object.entries(ownerCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
    chartInstances.push(new Chart(ctx4.getContext('2d'), {
      type: 'bar',
      data: {
        labels: topOwners.map(o => o[0]),
        datasets: [{
          label: 'Items',
          data: topOwners.map(o => o[1]),
          backgroundColor: '#8b5cf6',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    }));
  }
}

/**
 * renderProjectsList(container, params)
 * Project list page with card/table toggle
 */
function renderProjectsList(container, params) {
  const viewMode = state.viewMode || 'card';
  let filteredProjects = state.projects;

  if (state.filterStatus) {
    filteredProjects = filteredProjects.filter(p => p.status === state.filterStatus);
  }
  if (state.searchQuery) {
    const q = state.searchQuery.toLowerCase();
    filteredProjects = filteredProjects.filter(p =>
      p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q)
    );
  }

  let html = `
    <div class="view-projects-list">
      <div class="view-header">
        <h1> </h1>
      </div>

      <div class="controls-row">
        <div class="control-group">
          <label>:</label>
          <button onclick="state.viewMode='card'; handleRoute()" class="btn ${viewMode==='card' ? 'btn-primary' : 'btn-secondary'}"> </button>
          <button onclick="state.viewMode='table'; handleRoute()" class="btn ${viewMode==='table' ? 'btn-primary' : 'btn-secondary'}"> </button>
        </div>

        <div class="control-group">
          <label>:</label>
          <select onchange="state.filterStatus = this.value; handleRoute()" class="input-select">
            <option value=""></option>
            <option value="planning">Planning</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="at_risk">At Risk</option>
            <option value="delayed">Delayed</option>
          </select>
        </div>

        <input type="text" placeholder="..." onchange="state.searchQuery = this.value; handleRoute()" class="input-text" style="flex: 1;">
      </div>
  `;

  if (viewMode === 'card') {
    html += `<div class="card-grid">`;
    filteredProjects.forEach(project => {
      const itemCount = (project.actionItems || []).length;
      const completedCount = (project.actionItems || []).filter(i => i.status === 'completed').length;
      html += `
        <div class="card" onclick="navigateTo('/projects/${project.id}')">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <span class="badge">${project.code}</span>
            ${getStatusBadge(project.status)}
          </div>
          <h3>${project.name}</h3>
          <p class="text-muted" style="margin: 8px 0;">${project.description || 'No description'}</p>
          <div class="progress-bar" style="margin: 12px 0;">
            <div style="background: #3b82f6; width: ${project.progress || 0}%; height: 100%;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 8px;">
            <span class="text-muted">${project.owner || '-'}</span>
            <span>${project.progress || 0}%</span>
          </div>
          <div class="text-muted" style="font-size: 0.85em;"> ${completedCount}/${itemCount} completed</div>
        </div>
      `;
    });
    html += `</div>`;
  } else {
    html += `
      <table class="data-table">
        <thead>
          <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th>Action Items</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
    `;
    filteredProjects.forEach(project => {
      const itemCount = (project.actionItems || []).length;
      const completedCount = (project.actionItems || []).filter(i => i.status === 'completed').length;
      html += `
        <tr>
          <td><span class="badge">${project.code}</span></td>
          <td>${project.name}</td>
          <td>${project.owner || '-'}</td>
          <td><div class="progress-bar" style="width: 100px;"><div style="background: #3b82f6; width: ${project.progress || 0}%; height: 100%;"></div></div></td>
          <td>${getStatusBadge(project.status)}</td>
          <td>${completedCount}/${itemCount}</td>
          <td><button onclick="navigateTo('/projects/${project.id}')" class="btn btn-sm">Edit</button></td>
        </tr>
      `;
    });
    html += `
        </tbody>
      </table>
    `;
  }

  html += `
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderProjectDetail(container, params)
 * Project detail page
 */
function renderProjectDetail(container, params) {
  const project = state.projects.find(p => p.id === params.id);
  if (!project) {
    container.innerHTML = '<div class="error">Project not found</div>';
    return;
  }

  const allItems = project.actionItems || [];
  const completedCount = allItems.filter(i => i.status === 'completed').length;
  const inProgressCount = allItems.filter(i => i.status === 'in_progress').length;
  const pendingCount = allItems.filter(i => i.status === 'pending').length;

  const activeTab = state.projectDetailTab || 'items';

  let html = `
    <div class="view-project-detail">
      <a href="#" onclick="event.preventDefault(); navigateTo('/projects')" class="link"> </a>

      <div class="detail-header">
        <div>
          <h1>${project.name}</h1>
          <div style="margin-top: 8px;">
            <span class="badge">${project.code}</span>
            ${getStatusBadge(project.status)}
          </div>
        </div>
      </div>

      <p class="text-muted" style="margin: 16px 0;">${project.description}</p>

      <div class="stats-row">
        <div class="stat-mini">
          <div class="stat-label"></div>
          <div class="stat-value">${project.progress || 0}%</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label"> Items</div>
          <div class="stat-value">${allItems.length}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label"></div>
          <div class="stat-value">${completedCount}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label"></div>
          <div class="stat-value">${inProgressCount}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label"></div>
          <div class="stat-value">${pendingCount}</div>
        </div>
      </div>

      <div class="tabs">
        <button onclick="state.projectDetailTab='items'; handleRoute()" class="tab ${activeTab==='items' ? 'active' : ''}">Action Items</button>
        <button onclick="state.projectDetailTab='timeline'; handleRoute()" class="tab ${activeTab==='timeline' ? 'active' : ''}"></button>
        <button onclick="state.projectDetailTab='team'; handleRoute()" class="tab ${activeTab==='team' ? 'active' : ''}"></button>
      </div>

      <div class="tab-content">
  `;

  if (activeTab === 'items') {
    html += renderProjectDetailItems(project);
  } else if (activeTab === 'timeline') {
    html += renderProjectDetailTimeline(project);
  } else if (activeTab === 'team') {
    html += renderProjectDetailTeam(project);
  }

  html += `
      </div>
    </div>
  `;

  container.innerHTML = html;
}

function renderProjectDetailItems(project) {
  let items = project.actionItems || [];
  if (state.filterActionStatus) {
    items = items.filter(i => i.status === state.filterActionStatus);
  }
  if (state.filterActionPriority) {
    items = items.filter(i => i.priority === state.filterActionPriority);
  }

  let html = `
    <div class="filter-row">
      <select onchange="state.filterActionStatus = this.value; handleRoute()" class="input-select">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
      </select>
      <select onchange="state.filterActionPriority = this.value; handleRoute()" class="input-select">
        <option value="">All Priority</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>

    <table class="data-table">
      <thead>
        <tr>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
  `;

  items.forEach(item => {
    const timeline = item.startMonth && item.endMonth ? `M${item.startMonth}-M${item.endMonth}` : '-';
    const itemIdx = items.indexOf(item) + 1;
    html += `
      <tr>
        <td>${project.code}-${String(itemIdx).padStart(2, '0')}</td>
        <td>${item.name}</td>
        <td>${item.owner || '-'}</td>
        <td>${getStatusBadge(item.status)}</td>
        <td>${getPriorityBadge(item.priority)}</td>
        <td>${timeline}</td>
        <td><button onclick="openEditPanel('${project.id}', '${item.id}')" class="btn btn-sm">Edit</button></td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>
  `;

  return html;
}

function renderProjectDetailTimeline(project) {
  const items = project.actionItems || [];
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  let html = `
    <div class="gantt-container">
      <table class="gantt-table">
        <thead>
          <tr>
            <th style="width: 200px;">Action Item</th>
            ${months.map(m => `<th style="width: 30px;">${m}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
  `;

  items.forEach(item => {
    html += `<tr>
      <td>${item.name}</td>
    `;
    for (let m = 1; m <= 12; m++) {
      const isActive = item.startMonth && item.endMonth && m >= item.startMonth && m <= item.endMonth;
      const bgColor = !isActive ? 'transparent' :
        item.status === 'completed' ? '#22c55e' :
        item.status === 'in_progress' ? '#3b82f6' :
        item.status === 'delayed' ? '#ef4444' : '#94a3b8';
      html += `<td style="background: ${bgColor}; cursor: pointer;" onclick="navigateTo('/projects/${project.id}/actions/${item.id}')"></td>`;
    }
    html += `</tr>`;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  return html;
}

function renderProjectDetailTeam(project) {
  const items = project.actionItems || [];
  const ownerMap = {};

  items.forEach(item => {
    const owner = item.owner || 'Unassigned';
    if (!ownerMap[owner]) {
      ownerMap[owner] = [];
    }
    ownerMap[owner].push(item);
  });

  let html = `<div class="team-overview">`;

  Object.entries(ownerMap).forEach(([owner, ownerItems]) => {
    const completed = ownerItems.filter(i => i.status === 'completed').length;
    const inProgress = ownerItems.filter(i => i.status === 'in_progress').length;
    const pending = ownerItems.filter(i => i.status === 'pending').length;

    html += `
      <div class="card">
        <h3>${owner}</h3>
        <div class="stats-row">
          <div class="stat-mini">
            <div class="stat-label">Total</div>
            <div class="stat-value">${ownerItems.length}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label"></div>
            <div class="stat-value">${completed}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label"></div>
            <div class="stat-value">${inProgress}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label"></div>
            <div class="stat-value">${pending}</div>
          </div>
        </div>
      </div>
    `;
  });

  html += `</div>`;
  return html;
}

/**
 * renderActionDetail(container, params)
 * Single action item detail
 */
function renderActionDetail(container, params) {
  const project = state.projects.find(p => p.id === params.id);
  if (!project) {
    container.innerHTML = '<div class="error">Project not found</div>';
    return;
  }

  const action = (project.actionItems || []).find(a => a.id === params.aid);
  if (!action) {
    container.innerHTML = '<div class="error">Action item not found</div>';
    return;
  }

  let html = `
    <div class="view-action-detail">
      <a href="#" onclick="event.preventDefault(); navigateTo('/projects/${project.id}')" class="link">  ${project.name}</a>

      <div class="card" style="margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <h2>${action.name}</h2>
          <button onclick="openEditPanel('${project.id}', '${action.id}')" class="btn btn-primary"> Edit</button>
        </div>

        <table class="detail-table">
          <tr>
            <td class="label"></td>
            <td>${project.code}</td>
          </tr>
          <tr>
            <td class="label"></td>
            <td>${project.code} - ${project.name}</td>
          </tr>
          <tr>
            <td class="label">Breakdown</td>
            <td>${action.breakdown || '-'}</td>
          </tr>
          <tr>
            <td class="label">Owner Unit</td>
            <td>${action.ownerUnit || '-'}</td>
          </tr>
          <tr>
            <td class="label">Owner</td>
            <td>${action.owner || '-'}</td>
          </tr>
          <tr>
            <td class="label">Status</td>
            <td>${getStatusBadge(action.status)}</td>
          </tr>
          <tr>
            <td class="label">Priority</td>
            <td>${getPriorityBadge(action.priority)}</td>
          </tr>
          <tr>
            <td class="label">Timeline</td>
            <td>Month ${action.startMonth || '-'} to Month ${action.endMonth || '-'}</td>
          </tr>
        </table>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderTimeline(container, params)
 * Full year Gantt chart for all projects
 */
function renderTimeline(container, params) {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const currentMonth = new Date().getMonth() + 1;

  const allItems = [];
  state.projects.forEach(project => {
    (project.actionItems || []).forEach(item => {
      allItems.push({...item, projectId: project.id, projectCode: project.code, projectName: project.name});
    });
  });

  let html = `
    <div class="view-timeline">
      <div class="view-header">
        <h1> </h1>
      </div>

      <div style="display: flex; gap: 16px; margin: 16px 0;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 3px;"></div>
          <span>Completed</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 3px;"></div>
          <span>In Progress</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #94a3b8; border-radius: 3px;"></div>
          <span>Pending</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 3px;"></div>
          <span>Delayed</span>
        </div>
      </div>

      <div class="gantt-container">
        <table class="gantt-table">
          <thead>
            <tr>
              <th style="width: 250px;">Item</th>
              ${months.map((m, i) => `<th style="width: 40px; background: ${i+1===currentMonth ? '#fef3c7' : 'transparent'};">${m}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
  `;

  allItems.forEach(item => {
    html += `<tr>
      <td style="padding: 8px; font-size: 0.9em;">
        <div>${item.projectCode}</div>
        <div style="color: #666; font-size: 0.85em;">${item.name}</div>
      </td>
    `;

    for (let m = 1; m <= 12; m++) {
      const isActive = item.startMonth && item.endMonth && m >= item.startMonth && m <= item.endMonth;
      const bgColor = !isActive ? 'transparent' :
        item.status === 'completed' ? '#22c55e' :
        item.status === 'in_progress' ? '#3b82f6' :
        item.status === 'delayed' ? '#ef4444' : '#94a3b8';
      const cursor = isActive ? 'pointer' : 'default';

      html += `<td style="background: ${bgColor}; cursor: ${cursor}; border-right: 1px solid #e5e7eb;" onclick="if(this.style.background) navigateTo('/projects/${item.projectId}/actions/${item.id}')"></td>`;
    }
    html += `</tr>`;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderTeam(container, params)
 * Team workload overview
 */
function renderTeam(container, params) {
  const allItems = getAllActionItems();
  const ownerMap = {};

  allItems.forEach(item => {
    const owner = item.owner || 'Unassigned';
    if (!ownerMap[owner]) {
      ownerMap[owner] = [];
    }
    ownerMap[owner].push(item);
  });

  let html = `
    <div class="view-team">
      <div class="view-header">
        <h1> </h1>
      </div>

      <div class="card-grid">
  `;

  Object.entries(ownerMap).forEach(([owner, items]) => {
    const completed = items.filter(i => i.status === 'completed').length;
    const inProgress = items.filter(i => i.status === 'in_progress').length;
    const pending = items.filter(i => i.status === 'pending').length;
    const completionPercent = items.length > 0 ? Math.round((completed / items.length) * 100) : 0;

    html += `
      <div class="card" onclick="navigateTo('/team/${encodeURIComponent('${owner}')}')">
        <h3>${owner}</h3>

        <div class="stats-row">
          <div class="stat-mini">
            <div class="stat-label">Total</div>
            <div class="stat-value">${items.length}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">Done</div>
            <div class="stat-value">${completed}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">In Progress</div>
            <div class="stat-value">${inProgress}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">Pending</div>
            <div class="stat-value">${pending}</div>
          </div>
        </div>

        <div class="progress-bar" style="margin: 12px 0;">
          <div style="background: #22c55e; width: ${completionPercent}%; height: 100%;"></div>
        </div>
        <div class="text-muted" style="font-size: 0.9em;">${completionPercent}% complete</div>
      </div>
    `;
  });

  html += `
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderTeamMemberDetail(container, params)
 * Individual team member detail
 */
function renderTeamMemberDetail(container, params) {
  const ownerName = decodeURIComponent(params.name);
  const allItems = getAllActionItems().filter(i => (i.owner || 'Unassigned') === ownerName);

  const completed = allItems.filter(i => i.status === 'completed').length;
  const inProgress = allItems.filter(i => i.status === 'in_progress').length;
  const pending = allItems.filter(i => i.status === 'pending').length;

  let html = `
    <div class="view-team-member">
      <a href="#" onclick="event.preventDefault(); navigateTo('/team')" class="link"> </a>

      <h1>${ownerName}</h1>

      <div class="stats-row">
        <div class="stat-mini">
          <div class="stat-label">Total Items</div>
          <div class="stat-value">${allItems.length}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">Completed</div>
          <div class="stat-value">${completed}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">In Progress</div>
          <div class="stat-value">${inProgress}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">Pending</div>
          <div class="stat-value">${pending}</div>
        </div>
      </div>

      <h2 style="margin-top: 24px;">Action Items</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Project</th>
            <th>Item Name</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Timeline</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
  `;

  // Map items back to projects
  allItems.forEach(item => {
    const project = state.projects.find(p => p.actionItems && p.actionItems.some(a => a.id === item.id));
    const timeline = item.startMonth && item.endMonth ? `M${item.startMonth}-M${item.endMonth}` : '-';
    const projectId = project ? project.id : '';

    html += `
      <tr>
        <td>${project ? project.code : '-'}</td>
        <td>${item.name}</td>
        <td>${getStatusBadge(item.status)}</td>
        <td>${getPriorityBadge(item.priority)}</td>
        <td>${timeline}</td>
        <td><button class="btn btn-sm" onclick="openEditPanel('${projectId}', '${item.id}')"> </button></td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderAllActions(container, params)
 * Full action items table with filters
 */
function renderAllActions(container, params) {
  let allItems = getAllActionItems().map(item => {
    const project = state.projects.find(p => p.actionItems && p.actionItems.some(a => a.id === item.id));
    return {...item, projectId: project ? project.id : null, projectCode: project ? project.code : '-'};
  });

  if (state.filterProject) {
    allItems = allItems.filter(i => i.projectId === state.filterProject);
  }
  if (state.filterActionStatus) {
    allItems = allItems.filter(i => i.status === state.filterActionStatus);
  }
  if (state.filterActionPriority) {
    allItems = allItems.filter(i => i.priority === state.filterActionPriority);
  }
  if (state.searchQuery) {
    const q = state.searchQuery.toLowerCase();
    allItems = allItems.filter(i => i.name.toLowerCase().includes(q) || i.breakdown?.toLowerCase().includes(q));
  }

  const sortField = state.sortField || 'name';
  const sortOrder = state.sortOrder || 'asc';
  allItems.sort((a, b) => {
    const aVal = a[sortField];
    const bVal = b[sortField];
    if (sortOrder === 'asc') return aVal > bVal ? 1 : -1;
    return aVal < bVal ? 1 : -1;
  });

  const completedCount = allItems.filter(i => i.status === 'completed').length;
  const completionPercent = allItems.length > 0 ? Math.round((completedCount / allItems.length) * 100) : 0;

  let html = `
    <div class="view-all-actions">
      <div class="view-header">
        <h1>  Action Items</h1>
      </div>

      <div class="filter-row">
        <select onchange="state.filterProject = this.value; handleRoute()" class="input-select">
          <option value="">All Projects</option>
          ${state.projects.map(p => `<option value="${p.id}">${p.code}</option>`).join('')}
        </select>

        <select onchange="state.filterActionStatus = this.value; handleRoute()" class="input-select">
          <option value="">All Status</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>

        <select onchange="state.filterActionPriority = this.value; handleRoute()" class="input-select">
          <option value="">All Priority</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>

        <input type="text" placeholder="..." onchange="state.searchQuery = this.value; handleRoute()" class="input-text" style="flex: 1;">
      </div>

      <table class="data-table">
        <thead>
          <tr>
            <th onclick="state.sortField='projectCode'; state.sortOrder=state.sortOrder==='asc'?'desc':'asc'; handleRoute()">#</th>
            <th onclick="state.sortField='projectCode'; state.sortOrder=state.sortOrder==='asc'?'desc':'asc'; handleRoute()"></th>
            <th onclick="state.sortField='name'; state.sortOrder=state.sortOrder==='asc'?'desc':'asc'; handleRoute()"></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
  `;

  allItems.forEach((item, idx) => {
    const timeline = item.startMonth && item.endMonth ? `M${item.startMonth}-M${item.endMonth}` : '-';
    html += `
      <tr>
        <td>${idx + 1}</td>
        <td>${item.projectCode}</td>
        <td>${item.name}</td>
        <td>${item.breakdown || '-'}</td>
        <td>${item.owner || '-'}</td>
        <td>${getStatusBadge(item.status)}</td>
        <td>${getPriorityBadge(item.priority)}</td>
        <td>${timeline}</td>
        <td>
          <button onclick="openEditPanel('${item.projectId}', '${item.id}')" class="btn btn-sm">Edit</button>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>

      <div style="padding: 16px; background: #f3f4f6; border-radius: 8px; margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; font-size: 0.95em;">
          <span><strong>:</strong> ${allItems.length} items</span>
          <span><strong>:</strong> ${completedCount} (${completionPercent}%)</span>
        </div>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderSettings(container, params)
 * Settings page
 */
function renderSettings(container, params) {
  const theme = localStorage.getItem('theme') || 'light';
  const llmConfig = state.llmConfig || {provider: 'None', apiEndpoint: '', apiKey: '', modelName: '', localPath: '', maxTokens: 2000, temperature: 0.7};

  let html = `
    <div class="view-settings">
      <div class="view-header">
        <h1> </h1>
      </div>

      <!-- Theme Section -->
      <div class="card">
        <h2></h2>
        <div class="setting-group">
          <label>
            <input type="radio" name="theme" value="light" ${theme === 'light' ? 'checked' : ''} onchange="setTheme('light')"> 
          </label>
          <label>
            <input type="radio" name="theme" value="dark" ${theme === 'dark' ? 'checked' : ''} onchange="setTheme('dark')"> 
          </label>
          <label>
            <input type="radio" name="theme" value="system" ${theme === 'system' ? 'checked' : ''} onchange="setTheme('system')"> 
          </label>
        </div>
      </div>

      <!-- LLM Configuration Section -->
      <div class="card">
        <h2> AI </h2>
        <p class="text-muted">  Talk UI </p>

        <div class="setting-group">
          <label>Provider</label>
          <select id="llm-provider" class="input-select">
            <option value="None" ${llmConfig.provider === 'None' || llmConfig.provider === 'none' ? 'selected' : ''}>None</option>
            <option value="OpenAI" ${llmConfig.provider === 'OpenAI' || llmConfig.provider === 'openai' ? 'selected' : ''}>OpenAI</option>
            <option value="Anthropic" ${llmConfig.provider === 'Anthropic' || llmConfig.provider === 'anthropic' ? 'selected' : ''}>Anthropic (Claude)</option>
            <option value="Local" ${llmConfig.provider === 'Local' || llmConfig.provider === 'local' || llmConfig.provider === 'ollama' ? 'selected' : ''}>Local Model (Ollama)</option>
          </select>
        </div>

        <div class="setting-group">
          <label>API Endpoint <span class="text-muted" style="font-size:11px;"></span></label>
          <input type="text" id="llm-endpoint" class="input-text" value="${llmConfig.apiEndpoint || ''}" placeholder="https://api.openai.com/v1/chat/completions">
        </div>

        <div class="setting-group">
          <label>API Key</label>
          <input type="password" id="llm-key" class="input-text" value="${llmConfig.apiKey || ''}" placeholder="sk-...  anthropic key">
        </div>

        <div class="setting-group">
          <label>Model Name</label>
          <input type="text" id="llm-model" class="input-text" value="${llmConfig.modelName || ''}" placeholder="gpt-4o-mini, claude-sonnet-4-20250514, llama3...">
        </div>

        <div class="setting-group" id="llm-local-group" style="display: ${(llmConfig.provider || '').toLowerCase() === 'local' || (llmConfig.provider || '').toLowerCase() === 'ollama' ? 'block' : 'none'};">
          <label>Local Model Path / Ollama Endpoint</label>
          <input type="text" id="llm-local-path" class="input-text" value="${llmConfig.localPath || ''}" placeholder="http://localhost:11434">
        </div>

        <div class="setting-group">
          <label>Max Tokens</label>
          <input type="number" id="llm-tokens" class="input-text" value="${llmConfig.maxTokens || 2000}" min="100" max="10000" step="100">
        </div>

        <div class="setting-group">
          <label>Temperature (${llmConfig.temperature || 0.7})</label>
          <input type="range" id="llm-temp" class="input-range" min="0" max="1" step="0.1" value="${llmConfig.temperature || 0.7}">
        </div>

        <div style="display: flex; gap: 8px; margin-top: 12px;">
          <button onclick="testLLMConnection()" class="btn btn-secondary"> </button>
          <button onclick="saveLLMConfig()" class="btn btn-primary"> </button>
        </div>
        <div id="llm-test-result"></div>
      </div>

      <!-- Talk UI Guide Section -->
      <div class="card">
        <h2> Talk UI </h2>
        <p class="text-muted">   AI </p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
          <div>
            <h3 style="font-size: 13px; margin: 0 0 8px; color: var(--text-primary);"> </h3>
            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.8;">
              <code></code>  <br>
              <code></code>  <br>
              <code></code>  <br>
              <code>Agent </code>  AI Agent <br>
              <code>P3</code>  <br>
              <code> </code>  
            </div>
          </div>
          <div>
            <h3 style="font-size: 13px; margin: 0 0 8px; color: var(--text-primary);"> </h3>
            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.8;">
              <code> P3  50%</code><br>
              <code> </code><br>
              <code> Agent</code><br>
              <code> </code><br>
              <code></code>  
            </div>
          </div>
        </div>
        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px;">
            LLM API Talk UI 
        </p>
      </div>

      <!-- Data Section -->
      <div class="card">
        <h2> </h2>

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="exportData()" class="btn btn-secondary">  JSON</button>
          <button onclick="exportCSV()" class="btn btn-secondary">  CSV</button>
          <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(this.files[0])">
          <button onclick="document.getElementById('import-file').click()" class="btn btn-secondary">  JSON</button>
          <button onclick="if(confirm('')) { resetData(); }" class="btn btn-danger"> </button>
        </div>
      </div>

      <!-- About Section -->
      <div class="card">
        <h2> </h2>
        <p><strong>Version:</strong> ${window.APP_VERSION || 'v3.0.0'}</p>
        <p><a href="https://github.com/glen200392/dto-dashboard" target="_blank" class="link"> GitHub Repository</a></p>
      </div>
    </div>
  `;

  container.innerHTML = html;

  // Setup provider select change
  const providerSelect = document.getElementById('llm-provider');
  if (providerSelect) {
    providerSelect.onchange = function() {
      const localGroup = document.getElementById('llm-local-group');
      if (this.value === 'Local' && localGroup) {
        localGroup.style.display = 'block';
      } else if (localGroup) {
        localGroup.style.display = 'none';
      }
    };
  }
}

async function testLLMConnection() {
  const resultDiv = document.getElementById('llm-test-result');
  if (!resultDiv) return;

  // Save first so callLLM reads current values
  saveLLMConfig();

  const prov = (state.llmConfig.provider || '').toLowerCase();
  if (prov === 'none') {
    resultDiv.innerHTML = '<div style="margin-top:8px;padding:8px 12px;background:#fef3c7;border-radius:8px;font-size:12px;"> Provider  None Provider</div>';
    return;
  }
  if (!state.llmConfig.apiKey && prov !== 'local') {
    resultDiv.innerHTML = '<div style="margin-top:8px;padding:8px 12px;background:#fef3c7;border-radius:8px;font-size:12px;">  API Key</div>';
    return;
  }

  resultDiv.innerHTML = '<div style="margin-top:8px;padding:8px 12px;background:#f1f5f9;border-radius:8px;font-size:12px;"> ...</div>';
  try {
    const reply = await callLLM('');
    resultDiv.innerHTML = '<div style="margin-top:8px;padding:8px 12px;background:#dcfce7;border-radius:8px;font-size:12px;"> ' + (reply || '').substring(0, 100) + '</div>';
    // Update Talk UI status
    const statusEl = document.getElementById('talk-status-text');
    if (statusEl) statusEl.textContent = prov + ' ';
  } catch (err) {
    resultDiv.innerHTML = '<div style="margin-top:8px;padding:8px 12px;background:#fee2e2;border-radius:8px;font-size:12px;"> ' + err.message.substring(0, 200) + '</div>';
  }
}

function saveLLMConfig() {
  state.llmConfig = {
    provider: document.getElementById('llm-provider')?.value || 'None',
    apiEndpoint: document.getElementById('llm-endpoint')?.value || '',
    apiKey: document.getElementById('llm-key')?.value || '',
    modelName: document.getElementById('llm-model')?.value || '',
    localPath: document.getElementById('llm-local-path')?.value || '',
    maxTokens: parseInt(document.getElementById('llm-tokens')?.value || '2000'),
    temperature: parseFloat(document.getElementById('llm-temp')?.value || '0.7')
  };
  saveState();
  showToast('LLM Configuration saved', 'success');
}

function resetData() {
  state.projects = [];
  saveState();
  showToast('Data reset to default', 'info');
  location.reload();
}
/**
 * DTO Dashboard v3.0 - Agent Management Views
 * Render functions for AI Agent Squad Control Center
 */

/**
 * 1. renderAgentSquad(container, params)
 * Main hub for AI agent management - displays overview, stats, and agent cards
 */
function renderAgentSquad(container, params) {
  const agents = state.agents || [];
  const workflows = state.workflows || [];

  // Calculate global stats
  const activeCount = agents.filter(a => a.status === 'active').length;
  const totalTasks = agents.reduce((sum, a) => sum + (a.taskQueue?.length || 0), 0);
  const completedToday = agents.reduce((sum, a) => {
    const todayCompleted = a.taskQueue?.filter(t => t.status === 'completed').length || 0;
    return sum + todayCompleted;
  }, 0);
  const pendingTasks = agents.reduce((sum, a) => {
    const pending = a.taskQueue?.filter(t => ['pending', 'in_progress'].includes(t.status)).length || 0;
    return sum + pending;
  }, 0);
  const alertCount = agents.reduce((sum, a) => {
    const todayAlerts = (a.activityLog || [])
      .filter(log => ['alert', 'warning', 'error'].includes(log.type))
      .length;
    return sum + todayAlerts;
  }, 0);

  container.innerHTML = `
    <div class="agent-squad-container">
      <!-- Header -->
      <div class="section-header">
        <h1> AI Agent </h1>
        <p class="subtitle">Digital Transformation Agent Squad</p>
      </div>

      <!-- Quick Actions Bar -->
      <div class="quick-actions-bar">
        <button class="btn btn-primary" onclick="handleAddNewAgent()">
            Agent
        </button>
        <button class="btn btn-secondary" onclick="handlePauseAllAgents()">
           
        </button>
        <button class="btn btn-secondary" onclick="handleActivateAllAgents()">
           
        </button>
        <button class="btn btn-secondary" onclick="handleStandupReport()">
           
        </button>
      </div>

      <!-- Global Stats Panel -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${activeCount}/${agents.length}</div>
          <div class="stat-label"> Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${completedToday}</div>
          <div class="stat-label"></div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${pendingTasks}</div>
          <div class="stat-label"></div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${alertCount}</div>
          <div class="stat-label"></div>
        </div>
      </div>

      <!-- Agent Table -->
      <div class="card" style="padding:0; overflow-x:auto;">
        <table class="agent-table">
          <thead>
            <tr>
              <th style="width:40px;"></th>
              <th>Agent</th>
              <th></th>
              <th></th>
              <th></th>
              <th></th>
              <th></th>
              <th style="text-align:center;"></th>
              <th></th>
              <th style="text-align:center;"></th>
              <th style="width:100px; text-align:center;"></th>
            </tr>
          </thead>
          <tbody>
            ${agents.map(agent => {
              const projCodes = (agent.assignedProjects || []).map(pid => { const p = state.projects.find(pr => pr.id === pid); return p ? p.code : null; }).filter(Boolean);
              const queueLen = agent.taskQueue?.length || 0;
              const reliPct = agent.metrics?.reliability || 0;
              const tasksDone = agent.metrics?.tasksCompleted || 0;
              const modelStr = agent.llmConfig && agent.llmConfig.provider !== 'none' ? (agent.llmConfig.model || agent.llmConfig.provider || '').split('/').pop().substring(0, 18) : '';
              return `
              <tr class="agent-row" onclick="navigateTo('/agents/${agent.id}')" style="cursor:pointer;">
                <td><span class="agent-emoji" style="font-size:20px;">${agent.emoji || ''}</span></td>
                <td><strong>${agent.name}</strong></td>
                <td style="color:var(--text-secondary);font-size:12px;">${agent.role}</td>
                <td><span class="badge badge-${agent.status}" style="font-size:11px;">${getStatusBadge(agent.status)}</span></td>
                <td><span style="font-size:11px;">${getAutonomyBadge(agent.autonomy)}</span></td>
                <td>${projCodes.length > 0 ? projCodes.map(c => '<span class="tag" style="font-size:10px;padding:1px 6px;">' + c + '</span>').join(' ') : '<span style="color:var(--text-secondary);font-size:11px;"></span>'}</td>
                <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;">${agent.currentTask || '<span style="color:var(--text-secondary);"></span>'}</td>
                <td style="text-align:center;"><span class="badge" style="font-size:11px;background:${queueLen > 0 ? 'var(--accent,#6366f1)' : 'var(--bg-secondary,#f1f5f9)'};color:${queueLen > 0 ? '#fff' : 'var(--text-secondary)'};padding:2px 8px;border-radius:10px;">${queueLen}</span></td>
                <td style="font-size:11px;color:var(--text-secondary);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${modelStr}</td>
                <td style="text-align:center;font-size:12px;"><span style="color:${reliPct >= 80 ? '#22c55e' : reliPct >= 50 ? '#f59e0b' : 'var(--text-secondary)'};">${tasksDone > 0 ? reliPct + '%' : ''}</span></td>
                <td style="text-align:center;" onclick="event.stopPropagation();">
                  <button class="btn-icon" onclick="handleToggleAgentStatus('${agent.id}')" title="${agent.status === 'active' ? '' : ''}" style="font-size:14px;">${agent.status === 'active' ? '' : ''}</button>
                  <button class="btn-icon" onclick="navigateTo('/agents/${agent.id}')" title="" style="font-size:14px;"></button>
                  <button class="btn-icon" onclick="handleQuickTaskAssign('${agent.id}')" title="" style="font-size:14px;"></button>
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>

      <!-- Quick Activity Feed -->
      <div class="activity-feed-section">
        <div class="feed-header">
          <h3></h3>
          <div class="feed-nav">
            <a onclick="navigateTo('/agents/workflows')" class="feed-link"></a>
            <span class="divider">|</span>
            <a onclick="navigateTo('/agents/activity')" class="feed-link"></a>
          </div>
        </div>
        <div class="activity-list">
          ${getRecentActivities(agents, 10).map(item => `
            <div class="activity-item">
              <span class="time">${item.time}</span>
              <span class="agent">${item.emoji} ${item.agent}</span>
              <span class="type-badge badge-${item.type}">${getActivityTypeIcon(item.type)}</span>
              <span class="message">${item.message}</span>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  // Initialize any charts if needed
  setTimeout(() => {
    // Placeholder for chart initialization
  }, 100);
}

/**
 * 2. renderAgentDetail(container, params)
 * Agent detail page with full CRUD and multiple tabs
 */
function renderAgentDetail(container, params) {
  const agentId = params.id;
  const agent = state.agents.find(a => a.id === agentId);

  if (!agent) {
    container.innerHTML = '<p>Agent not found</p>';
    return;
  }

  const projects = state.projects || [];
  const activeTab = state.agentDetailTab || 'queue';

  const renderTabs = () => {
    const tabContent = {
      queue: renderTaskQueueTab(agent),
      metrics: renderMetricsTab(agent),
      activity: renderActivityHistoryTab(agent)
    };
    return tabContent[activeTab] || tabContent.queue;
  };

  container.innerHTML = `
    <div class="agent-detail-container">
      <!-- Back Link -->
      <div class="back-link">
        <a onclick="navigateTo('/agents')">  Agent </a>
      </div>

      <!-- Agent Identity Section -->
      <div class="agent-identity-section">
        <div class="identity-header">
          <div class="emoji-name">
            <input type="text" class="emoji-input" id="agentEmoji" value="${agent.emoji}" maxlength="2" style="width: 60px;">
            <input type="text" class="name-input" id="agentName" value="${agent.name}" placeholder="Agent Name">
          </div>
          <div class="role-description">
            <input type="text" class="role-input" id="agentRole" value="${agent.role}" placeholder="Role">
            <textarea class="description-input" id="agentDescription" placeholder="Description">${agent.description || ''}</textarea>
          </div>
        </div>

        <!-- Status & Autonomy Controls -->
        <div class="controls-grid">
          <div class="control-group">
            <label>Status</label>
            <div class="status-buttons">
              <button class="btn-toggle ${agent.status === 'active' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {status: 'active'})">Active</button>
              <button class="btn-toggle ${agent.status === 'idle' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {status: 'idle'})">Idle</button>
              <button class="btn-toggle ${agent.status === 'paused' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {status: 'paused'})">Paused</button>
            </div>
          </div>

          <div class="control-group">
            <label>Autonomy Level</label>
            <div class="autonomy-selector">
              <button class="btn-toggle ${agent.autonomy === 'intern' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {autonomy: 'intern'})"> Intern</button>
              <button class="btn-toggle ${agent.autonomy === 'specialist' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {autonomy: 'specialist'})"> Specialist</button>
              <button class="btn-toggle ${agent.autonomy === 'lead' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {autonomy: 'lead'})"> Lead</button>
            </div>
          </div>
        </div>

        <!-- Schedule -->
        <div class="control-group">
          <label>Schedule</label>
          <div class="schedule-display">
            <span>${agent.schedule?.type || 'N/A'} at ${agent.schedule?.time || 'N/A'}</span>
            <span class="tz">${agent.schedule?.timezone || 'UTC'}</span>
            <button class="btn-icon" onclick="handleEditSchedule('${agentId}')"></button>
          </div>
        </div>

        <!-- Assigned Projects -->
        <div class="control-group">
          <label>Assigned Projects</label>
          <div class="projects-checkboxes">
            ${projects.map((proj, idx) => `
              <label class="checkbox-label">
                <input type="checkbox" ${agent.assignedProjects?.includes(proj.id) ? 'checked' : ''}
                       onchange="handleUpdateAgent('${agentId}', {assignedProjects: getSelectedProjects()})">
                ${proj.name || ('Project ' + (idx + 1))}
              </label>
            `).join('')}
          </div>
        </div>

        <!-- Tools -->
        <div class="control-group">
          <label>Tools</label>
          <div class="tools-tags">
            ${(agent.tools || []).map(tool => `<span class="tag">${tool}</span>`).join('')}
          </div>
        </div>

        <!-- LLM Config -->
        <div class="llm-config-section">
          <h3> AI </h3>
          <p class="note">    AI CrewAI / LangGraph / Swarm / Ollama</p>

          <div class="control-group">
            <label>Provider</label>
            <select id="llmProvider" onchange="handleLLMConfigChange('${agentId}')">
              <option value="none" ${agent.llmConfig?.provider === 'none' ? 'selected' : ''}>None</option>
              <option value="openai" ${agent.llmConfig?.provider === 'openai' ? 'selected' : ''}>OpenAI</option>
              <option value="anthropic" ${agent.llmConfig?.provider === 'anthropic' ? 'selected' : ''}>Anthropic</option>
              <option value="local" ${agent.llmConfig?.provider === 'local' ? 'selected' : ''}>Local</option>
            </select>
          </div>

          <div class="control-group">
            <label>Model</label>
            <input type="text" id="llmModel" value="${agent.llmConfig?.model || ''}" placeholder="e.g., claude-opus-4-6">
          </div>

          <div class="control-group">
            <label>Temperature (0.0 - 1.0)</label>
            <input type="range" id="llmTemp" min="0" max="1" step="0.1" value="${agent.llmConfig?.temperature || 0.7}">
            <span id="tempValue">${agent.llmConfig?.temperature || 0.7}</span>
          </div>

          <label class="checkbox-label">
            <input type="checkbox" onchange="handleUseGlobalConfig('${agentId}')">
            Use Global Config
          </label>
        </div>

        <!-- Save & Delete -->
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="handleSaveAgentChanges('${agentId}')"> Save Changes</button>
          <button class="btn btn-danger" onclick="handleDeleteAgent('${agentId}')"> Delete Agent</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs-container">
        <div class="tab-nav">
          <button class="tab-btn ${activeTab === 'queue' ? 'active' : ''}" onclick="switchAgentTab('queue', '${agentId}')"></button>
          <button class="tab-btn ${activeTab === 'metrics' ? 'active' : ''}" onclick="switchAgentTab('metrics', '${agentId}')"></button>
          <button class="tab-btn ${activeTab === 'activity' ? 'active' : ''}" onclick="switchAgentTab('activity', '${agentId}')"></button>
        </div>
        <div class="tab-content" id="tabContent">
          ${renderTabs()}
        </div>
      </div>
    </div>
  `;

  // Initialize event listeners
  document.getElementById('llmTemp')?.addEventListener('input', (e) => {
    document.getElementById('tempValue').textContent = e.target.value;
  });
}

function renderTaskQueueTab(agent) {
  const taskQueue = agent.taskQueue || [];
  const pending = taskQueue.filter(t => t.status === 'pending');
  const inProgress = taskQueue.filter(t => t.status === 'in_progress');
  const completed = taskQueue.filter(t => t.status === 'completed');

  return `
    <div class="task-queue-tab">
      <div class="task-section">
        <h4> (${inProgress.length})</h4>
        <div class="task-list">
          ${inProgress.map(task => renderTaskItem(agent.id, task)).join('')}
        </div>
      </div>

      <div class="task-section">
        <h4> (${pending.length})</h4>
        <div class="task-list">
          ${pending.map(task => renderTaskItem(agent.id, task)).join('')}
        </div>
      </div>

      <div class="task-section collapsible">
        <h4> (${completed.length})</h4>
        <div class="task-list" style="display:none;">
          ${completed.map(task => renderTaskItem(agent.id, task)).join('')}
        </div>
      </div>

      <div style="display:flex;gap:8px;margin:12px 0;">
        <button class="btn btn-primary" onclick="executeAllAgentTasks('${agent.id}')" style="font-size:13px;"> </button>
      </div>

      <div class="add-task-form">
        <h4> </h4>
        <input type="text" id="newTaskTitle" placeholder="">
        <select id="newTaskPriority">
          <option>low</option>
          <option selected>medium</option>
          <option>high</option>
        </select>
        <input type="date" id="newTaskDueDate">
        <button class="btn btn-primary" onclick="handleAddTaskToAgent('${agent.id}')"></button>
      </div>
    </div>
  `;
}

function renderTaskItem(agentId, task) {
  const statusIcon = {pending: '', in_progress: '', completed: ''}[task.status] || '?';
  const priorityColor = {high: '#e74c3c', medium: '#f39c12', low: '#95a5a6'}[task.priority] || '#95a5a6';
  const hasResult = task.result && task.result.length > 0;
  const isRunning = task._executing;
  const canExecute = task.status !== 'completed' && !isRunning;
  const hasLLM = (() => {
    const agent = state.agents.find(a => a.id === agentId);
    const cfg = agent?.llmConfig || state.llmConfig || {};
    const prov = (cfg.provider || '').toLowerCase();
    return prov && prov !== 'none' && (cfg.apiKey || prov === 'local' || prov === 'ollama');
  })();

  return `
    <div class="task-item" style="border-left: 4px solid ${priorityColor}">
      <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">
        <span onclick="handleTaskStatusChange('${agentId}', '${task.id}')" style="cursor:pointer;flex-shrink:0;" title="">
          ${statusIcon}
        </span>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${task.title}</div>
          ${hasResult ? '<div class="task-result-preview" onclick="showTaskResult(\'' + agentId + '\',\'' + task.id + '\')" style="font-size:11px;color:var(--accent);cursor:pointer;margin-top:2px;">  AI  </div>' : ''}
          ${isRunning ? '<div style="font-size:11px;color:#f59e0b;margin-top:2px;"> AI ...</div>' : ''}
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;flex-shrink:0;">
        <span class="priority-badge" style="background-color: ${priorityColor};">${task.priority}</span>
        <span class="due-date" style="font-size:11px;">${task.dueDate || ''}</span>
        ${canExecute && hasLLM ? '<button class="btn-icon" onclick="event.stopPropagation();executeAgentTask(\'' + agentId + '\',\'' + task.id + '\')" title="AI " style="font-size:14px;background:var(--accent-light,#eff6ff);border-radius:6px;padding:2px 6px;"></button>' : ''}
      </div>
    </div>
  `;
}

function renderMetricsTab(agent) {
  const metrics = agent.metrics || {};

  return `
    <div class="metrics-tab">
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-num">${metrics.tasksCompleted || 0}</div>
          <div class="stat-lbl">Tasks Completed</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${metrics.avgResponseTime || '0s'}</div>
          <div class="stat-lbl">Avg Response Time</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${metrics.reliability || 0}%</div>
          <div class="stat-lbl">Reliability Score</div>
        </div>
      </div>

      <div class="chart-container">
        <h4>Weekly Task Trend</h4>
        <canvas id="weeklyChart"></canvas>
      </div>

      <button class="btn btn-secondary" onclick="handleGeneratePerformanceReport('${agent.id}')">
         Generate Performance Report
      </button>
    </div>
  `;
}

function renderActivityHistoryTab(agent) {
  const activityLog = agent.activityLog || [];

  return `
    <div class="activity-tab">
      <div class="activity-filters">
        <select id="activityTypeFilter" onchange="filterActivityLog()">
          <option value="">All Types</option>
          <option value="info">Info</option>
          <option value="alert">Alert</option>
          <option value="warning">Warning</option>
          <option value="success">Success</option>
          <option value="error">Error</option>
        </select>
      </div>

      <div class="activity-timeline">
        ${activityLog.slice().reverse().map(entry => `
          <div class="activity-entry">
            <span class="time">${entry.time}</span>
            <span class="type-badge badge-${entry.type}">${getActivityTypeIcon(entry.type)}</span>
            <span class="message">${entry.message}</span>
          </div>
        `).join('')}
      </div>

      <div class="export-buttons">
        <button class="btn btn-secondary" onclick="handleExportActivityLog('${agent.id}')">  Log</button>
        <button class="btn btn-secondary" onclick="handleClearActivityLog('${agent.id}')"> </button>
      </div>
    </div>
  `;
}

/**
 * 3. renderWorkflows(container, params)
 * Workflow management page
 */
function renderWorkflows(container, params) {
  const workflows = state.workflows || [];
  const agents = state.agents || [];

  container.innerHTML = `
    <div class="workflows-container">
      <div class="breadcrumb">
        <a onclick="navigateTo('/agents')">Agent </a> > 
      </div>

      <div class="section-header">
        <h1> </h1>
      </div>

      <!-- Create Workflow Button -->
      <button class="btn btn-primary" onclick="handleCreateWorkflow()">
         
      </button>

      <!-- Workflow Cards -->
      <div class="card-grid">
        ${workflows.map(workflow => `
          <div class="workflow-card">
            <div class="workflow-header">
              <h3>${workflow.name}</h3>
              <span class="badge badge-${workflow.status}">${workflow.status === 'active' ? ' Active' : ' Paused'}</span>
            </div>
            <p class="description">${workflow.description || 'No description'}</p>

            <!-- Trigger Info -->
            <div class="trigger-info">
              <span> ${workflow.trigger?.label || 'On-demand'}</span>
            </div>

            <!-- Visual Flow -->
            <div class="workflow-steps">
              <div class="workflow-step">
                <div class="step-content"></div>
                <div class="step-label">Trigger</div>
              </div>
              ${(workflow.steps || []).map((step, idx) => `
                <div class="workflow-arrow"></div>
                <div class="workflow-step">
                  <div class="step-content"></div>
                  <div class="step-label">${step.agent}</div>
                  <small>${step.action}</small>
                </div>
              `).join('')}
              <div class="workflow-arrow"></div>
              <div class="workflow-step">
                <div class="step-content"></div>
                <div class="step-label">Output</div>
              </div>
            </div>

            <!-- Run Info -->
            <div class="run-info">
              <small>Last: ${workflow.lastRun || 'Never'}</small>
              <small>Next: ${workflow.nextRun || 'N/A'}</small>
            </div>

            <!-- Actions -->
            <div class="card-actions">
              <button class="btn-icon" onclick="handleToggleWorkflow('${workflow.id}')" title="Toggle">
                ${workflow.status === 'active' ? '' : ''}
              </button>
              <button class="btn-icon" onclick="handleEditWorkflow('${workflow.id}')" title="Edit">
                
              </button>
              <button class="btn-icon" onclick="handleManualTrigger('${workflow.id}')" title="Run Now">
                
              </button>
              <button class="btn-icon" onclick="handleDeleteWorkflow('${workflow.id}')" title="Delete">
                
              </button>
            </div>
          </div>
        `).join('')}
      </div>

      <!-- Integration Info -->
      <div class="info-box">
        <h4> Future Integration</h4>
        <p></p>
        <ul>
          <li><strong>CrewAI Backend</strong> - </li>
          <li><strong>LangGraph</strong> - </li>
          <li><strong>OpenAI Swarm</strong> - </li>
          <li><strong>Local LLM</strong> -  Ollama / vLLM </li>
        </ul>
        <p style="font-size: 0.9em; color: #666;"> API  LLM </p>
      </div>
    </div>
  `;
}

/**
 * 4. renderAgentActivity(container, params)
 * Global activity log page for all agents
 */
function renderAgentActivity(container, params) {
  const agents = state.agents || [];
  const allActivities = mergeAgentActivities(agents);

  container.innerHTML = `
    <div class="activity-container">
      <div class="breadcrumb">
        <a onclick="navigateTo('/agents')">Agent </a> > 
      </div>

      <div class="section-header">
        <h1> </h1>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <select id="filterAgent" onchange="reloadActivityPage()">
          <option value="">All Agents</option>
          ${agents.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
        </select>

        <select id="filterType" onchange="reloadActivityPage()">
          <option value="">All Types</option>
          <option value="info">Info</option>
          <option value="alert">Alert</option>
          <option value="warning">Warning</option>
          <option value="success">Success</option>
          <option value="error">Error</option>
        </select>

        <select id="filterDateRange" onchange="reloadActivityPage()">
          <option value="today">Today</option>
          <option value="3days">3 Days</option>
          <option value="7days">7 Days</option>
          <option value="all">All</option>
        </select>

        <input type="text" id="searchActivity" placeholder="Search..." onkeyup="reloadActivityPage()">
      </div>

      <!-- Summary Stats -->
      <div class="summary-stats">
        <div class="stat-box">
          <div class="stat-num">${allActivities.length}</div>
          <div class="stat-lbl">Total Events</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${allActivities.filter(a => ['alert', 'warning', 'error'].includes(a.type)).length}</div>
          <div class="stat-lbl">Alerts</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${getMostActiveAgent(agents)}</div>
          <div class="stat-lbl">Most Active Agent</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${allActivities[0]?.time || 'N/A'}</div>
          <div class="stat-lbl">Last Event</div>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="activity-timeline-full">
        ${groupActivitiesByDate(allActivities).map(group => `
          <div class="date-group">
            <h3 class="date-header">${group.date}</h3>
            ${group.activities.map(activity => `
              <div class="activity-item">
                <span class="time">${activity.time}</span>
                <span class="agent">${activity.emoji} ${activity.agent}</span>
                <span class="type-badge badge-${activity.type}">${getActivityTypeIcon(activity.type)}</span>
                <span class="message">${activity.message}</span>
              </div>
            `).join('')}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

/* ============================================================
   HELPER FUNCTIONS
   ============================================================ */

function getStatusIndicatorStyle(status) {
  const colors = {
    active: '#27ae60',
    idle: '#f39c12',
    paused: '#95a5a6',
    error: '#e74c3c'
  };
  return `background-color: ${colors[status] || '#95a5a6'}; width: 12px; height: 12px; border-radius: 50%; position: absolute; top: 10px; right: 10px;`;
}

function getAutonomyBadge(level) {
  const badges = {
    intern: ' Intern',
    specialist: ' Specialist',
    lead: ' Lead'
  };
  return badges[level] || '?';
}

function getActivityTypeIcon(type) {
  const icons = {
    info: '',
    alert: '',
    warning: '',
    success: '',
    error: ''
  };
  return icons[type] || '';
}

function getRecentActivities(agents, limit) {
  const activities = [];
  agents.forEach(agent => {
    (agent.activityLog || []).slice(-3).forEach(log => {
      activities.push({
        ...log,
        emoji: agent.emoji,
        agent: agent.name
      });
    });
  });
  return activities.sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, limit);
}

function mergeAgentActivities(agents) {
  const activities = [];
  agents.forEach(agent => {
    (agent.activityLog || []).forEach(log => {
      activities.push({
        ...log,
        emoji: agent.emoji,
        agent: agent.name,
        agentId: agent.id
      });
    });
  });
  return activities.sort((a, b) => new Date(b.time) - new Date(a.time));
}

function groupActivitiesByDate(activities) {
  const grouped = {};
  activities.forEach(activity => {
    const date = activity.time?.split(' ')[0] || 'Unknown';
    if (!grouped[date]) grouped[date] = [];
    grouped[date].push(activity);
  });

  return Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).map(date => ({
    date,
    activities: grouped[date]
  }));
}

function getMostActiveAgent(agents) {
  if (agents.length === 0) return 'N/A';
  const mostActive = agents.reduce((prev, current) =>
    (prev.activityLog?.length || 0) > (current.activityLog?.length || 0) ? prev : current
  );
  return mostActive.name || 'N/A';
}

/* ============================================================
   EVENT HANDLERS
   ============================================================ */

function handleAddNewAgent() {
  showModal('New Agent', renderNewAgentForm(), { width: '500px' });
}

function renderNewAgentForm() {
  return `
    <div class="form-group">
      <label>Emoji</label>
      <input type="text" id="formEmoji" maxlength="2" value="">
    </div>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="formName" placeholder="Agent Name">
    </div>
    <div class="form-group">
      <label>Role</label>
      <input type="text" id="formRole" placeholder="Role">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="formDesc" placeholder="Description"></textarea>
    </div>
    <div class="form-group">
      <label>Autonomy</label>
      <select id="formAutonomy">
        <option value="intern">Intern</option>
        <option value="specialist">Specialist</option>
        <option value="lead">Lead</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="handleSaveNewAgent()">Create Agent</button>
  `;
}

function handleSaveNewAgent() {
  const newAgent = {
    id: crypto.randomUUID(),
    emoji: document.getElementById('formEmoji').value || '',
    name: document.getElementById('formName').value,
    role: document.getElementById('formRole').value,
    description: document.getElementById('formDesc').value,
    autonomy: document.getElementById('formAutonomy').value,
    status: 'active',
    assignedProjects: [],
    schedule: { type: 'daily', time: '08:00', timezone: 'Asia/Taipei' },
    tools: [],
    llmConfig: { provider: 'none', model: '', temperature: 0.7 },
    metrics: { tasksCompleted: 0, avgResponseTime: '0s', reliability: 100, weeklyTasks: [0, 0, 0, 0] },
    taskQueue: [],
    activityLog: [{ time: new Date().toISOString(), type: 'success', message: 'Agent created' }],
    createdAt: new Date().toISOString().split('T')[0],
    updatedAt: new Date().toISOString().split('T')[0]
  };

  state.agents.push(newAgent);
  saveState();
  closeModal();
  showToast('Agent created successfully');
  navigateTo('/agents/' + newAgent.id);
}

function handlePauseAllAgents() {
  state.agents.forEach(a => a.status = 'paused');
  saveState();
  showToast('All agents paused');
  handleRoute(window.location.hash);
}

function handleActivateAllAgents() {
  state.agents.forEach(a => a.status = 'active');
  saveState();
  showToast('All agents activated');
  handleRoute(window.location.hash);
}

function handleStandupReport() {
  const report = generateStandupReport(state.agents);
  showModal('Daily Standup Report', `<pre>${report}</pre>`, { width: '600px' });
}

function generateStandupReport(agents) {
  const today = new Date().toLocaleDateString();
  let report = `DAILY STANDUP REPORT - ${today}\n\n`;

  agents.forEach(agent => {
    const completed = agent.taskQueue?.filter(t => t.status === 'completed').length || 0;
    const pending = agent.taskQueue?.filter(t => t.status === 'pending').length || 0;
    const inProgress = agent.taskQueue?.filter(t => t.status === 'in_progress').length || 0;

    report += `${agent.emoji} ${agent.name} (${agent.role})\n`;
    report += `  Status: ${agent.status}\n`;
    report += `  Completed: ${completed} | In Progress: ${inProgress} | Pending: ${pending}\n`;
    report += `  Reliability: ${agent.metrics?.reliability || 0}%\n\n`;
  });

  return report;
}

function handleToggleAgentStatus(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.status = agent.status === 'active' ? 'paused' : 'active';
    saveState();
    handleRoute(window.location.hash);
  }
}

function handleQuickTaskAssign(agentId) {
  showModal('Quick Task Assign', `
    <input type="text" id="quickTaskTitle" placeholder="Task Title">
    <select id="quickTaskPriority"><option>low</option><option selected>medium</option><option>high</option></select>
    <button class="btn btn-primary" onclick="handleSaveQuickTask('${agentId}')">Add</button>
  `, { width: '400px' });
}

function handleSaveQuickTask(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.taskQueue.push({
      id: 't' + Date.now(),
      title: document.getElementById('quickTaskTitle').value,
      status: 'pending',
      priority: document.getElementById('quickTaskPriority').value,
      dueDate: new Date().toISOString().split('T')[0]
    });
    saveState();
    closeModal();
    showToast('Task assigned');
  }
}

function handleUpdateAgent(agentId, updates) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    Object.assign(agent, updates);
    agent.updatedAt = new Date().toISOString().split('T')[0];
    saveState();
    handleRoute(window.location.hash);
  }
}

function handleSaveAgentChanges(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.emoji = document.getElementById('agentEmoji').value;
    agent.name = document.getElementById('agentName').value;
    agent.role = document.getElementById('agentRole').value;
    agent.description = document.getElementById('agentDescription').value;
    agent.llmConfig.provider = document.getElementById('llmProvider').value;
    agent.llmConfig.model = document.getElementById('llmModel').value;
    agent.llmConfig.temperature = parseFloat(document.getElementById('llmTemp').value);
    agent.updatedAt = new Date().toISOString().split('T')[0];
    saveState();
    showToast('Agent updated');
  }
}

function handleDeleteAgent(agentId) {
  if (confirm('Delete this agent? This action cannot be undone.')) {
    state.agents = state.agents.filter(a => a.id !== agentId);
    saveState();
    showToast('Agent deleted');
    navigateTo('/agents');
  }
}

function handleAddTaskToAgent(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    const title = document.getElementById('newTaskTitle').value;
    const priority = document.getElementById('newTaskPriority').value;
    const dueDate = document.getElementById('newTaskDueDate').value;

    if (title) {
      agent.taskQueue.push({
        id: 't' + Date.now(),
        title,
        status: 'pending',
        priority,
        dueDate
      });
      saveState();
      document.getElementById('newTaskTitle').value = '';
      handleRoute(window.location.hash);
      showToast('Task added');
    }
  }
}

function handleTaskStatusChange(agentId, taskId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    const task = agent.taskQueue.find(t => t.id === taskId);
    if (task) {
      const statuses = ['pending', 'in_progress', 'completed'];
      const currentIdx = statuses.indexOf(task.status);
      task.status = statuses[(currentIdx + 1) % statuses.length];
      saveState();
      handleRoute(window.location.hash);
    }
  }
}

function handleEditSchedule(agentId) {
  showModal('Edit Schedule', `
    <input type="text" id="schedType" value="${state.agents.find(a => a.id === agentId)?.schedule?.type || ''}">
    <input type="time" id="schedTime" value="${state.agents.find(a => a.id === agentId)?.schedule?.time || ''}">
    <button class="btn btn-primary" onclick="handleSaveSchedule('${agentId}')">Save</button>
  `);
}

function handleSaveSchedule(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.schedule.type = document.getElementById('schedType').value;
    agent.schedule.time = document.getElementById('schedTime').value;
    saveState();
    closeModal();
    handleRoute(window.location.hash);
  }
}

function handleGeneratePerformanceReport(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  const report = `Performance Report: ${agent?.name}\n\nTasks Completed: ${agent?.metrics?.tasksCompleted}\nReliability: ${agent?.metrics?.reliability}%\nAvg Response Time: ${agent?.metrics?.avgResponseTime}`;
  showModal('Performance Report', `<pre>${report}</pre>`);
}

function handleExportActivityLog(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  const json = JSON.stringify(agent?.activityLog, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${agent?.name}_activity.json`;
  a.click();
  showToast('Log exported');
}

function handleClearActivityLog(agentId) {
  if (confirm('Clear all activity history? This cannot be undone.')) {
    const agent = state.agents.find(a => a.id === agentId);
    if (agent) {
      agent.activityLog = [];
      saveState();
      handleRoute(window.location.hash);
      showToast('Activity log cleared');
    }
  }
}

function switchAgentTab(tabName, agentId) {
  state.agentDetailTab = tabName;
  const container = document.getElementById('view-container');
  const agent = state.agents.find(a => a.id === agentId);
  if (!agent || !container) return;
  renderAgentDetail(container, { id: agentId });
}

function handleCreateWorkflow() {
  showModal('New Workflow', renderWorkflowForm());
}

function renderWorkflowForm() {
  return `
    <input type="text" id="wfName" placeholder="Workflow Name">
    <textarea id="wfDesc" placeholder="Description"></textarea>
    <select id="wfTrigger"><option value="schedule">Schedule</option><option value="event">Event</option></select>
    <button class="btn btn-primary" onclick="handleSaveWorkflow()">Create</button>
  `;
}

function handleSaveWorkflow() {
  const newWorkflow = {
    id: crypto.randomUUID(),
    name: document.getElementById('wfName').value,
    description: document.getElementById('wfDesc').value,
    trigger: { type: document.getElementById('wfTrigger').value, label: 'Weekly' },
    steps: [],
    status: 'active',
    lastRun: '',
    nextRun: ''
  };
  state.workflows.push(newWorkflow);
  saveState();
  closeModal();
  showToast('Workflow created');
  handleRoute('#/workflows');
}

function handleToggleWorkflow(workflowId) {
  const wf = state.workflows.find(w => w.id === workflowId);
  if (wf) {
    wf.status = wf.status === 'active' ? 'paused' : 'active';
    saveState();
    handleRoute('#/workflows');
  }
}

function handleDeleteWorkflow(workflowId) {
  if (confirm('Delete workflow?')) {
    state.workflows = state.workflows.filter(w => w.id !== workflowId);
    deleteFromCloud('workflows', workflowId);
    saveState();
    handleRoute('#/workflows');
  }
}

async function handleManualTrigger(workflowId) {
  const wf = state.workflows.find(w => w.id === workflowId);
  if (!wf) { showToast('Workflow not found', 'error'); return; }
  if (wf.status !== 'active') { showToast('', 'warning'); return; }

  const steps = wf.steps || [];
  wf.lastRun = new Date().toISOString().replace('T', ' ').substring(0, 16);
  if (!wf.runCount) wf.runCount = 0;
  wf.runCount++;

  // Distribute tasks to agents
  const newTaskIds = [];
  steps.forEach(step => {
    const agent = state.agents.find(a => a.name.toLowerCase().includes(step.agent.toLowerCase()));
    if (agent) {
      if (!agent.taskQueue) agent.taskQueue = [];
      const taskId = crypto.randomUUID();
      agent.taskQueue.push({
        id: taskId, title: `[${wf.name}] ${step.action}`,
        status: 'pending', priority: 'high', assignedAt: new Date().toISOString(), workflowId: wf.id
      });
      agent.currentTask = `[${wf.name}] ${step.action}`;
      agent.status = 'active';
      newTaskIds.push({ agentId: agent.id, taskId });
    }
  });

  saveState();
  logActivity('workflow', wf.id, 'workflow_triggered', { name: wf.name, steps: steps.length });
  pushNotification('', `${wf.name}  ${steps.length} `);
  handleRoute(window.location.hash);

  // Auto-execute if LLM is configured  ask user first
  const hasLLM = (() => {
    const cfg = state.llmConfig || {};
    const prov = (cfg.provider || '').toLowerCase();
    return prov && prov !== 'none' && (cfg.apiKey || prov === 'local' || prov === 'ollama');
  })();

  if (hasLLM && newTaskIds.length > 0) {
    const doExec = confirm(` ${newTaskIds.length} \n AI Agent `);
    if (doExec) {
      for (const { agentId, taskId } of newTaskIds) {
        await executeAgentTask(agentId, taskId);
      }
      showToast(` ${wf.name}`, 'success');
    }
  }
}

function handleEditWorkflow(workflowId) {
  const wf = state.workflows.find(w => w.id === workflowId);
  if (!wf) return;
  const agents = state.agents || [];
  const stepsHtml = (wf.steps || []).map((step, idx) => `
    <div class="form-group" style="display:flex;gap:8px;align-items:center;">
      <span style="font-weight:600;min-width:24px;">${idx + 1}.</span>
      <select id="wfEditAgent${idx}" style="flex:1;">
        ${agents.map(a => `<option value="${a.name}" ${a.name === step.agent ? 'selected' : ''}>${a.emoji} ${a.name}</option>`).join('')}
      </select>
      <input type="text" id="wfEditAction${idx}" value="${step.action}" placeholder="Action" style="flex:2;">
      <button class="btn-icon" onclick="this.parentElement.remove()" title=""></button>
    </div>
  `).join('');

  showModal('  ' + wf.name, `
    <div class="form-group">
      <label></label>
      <input type="text" id="wfEditName" value="${wf.name}">
    </div>
    <div class="form-group">
      <label></label>
      <textarea id="wfEditDesc">${wf.description || ''}</textarea>
    </div>
    <div class="form-group">
      <label></label>
      <select id="wfEditTrigger">
        <option value="schedule" ${wf.trigger?.type === 'schedule' ? 'selected' : ''}></option>
        <option value="event" ${wf.trigger?.type === 'event' ? 'selected' : ''}></option>
        <option value="manual" ${wf.trigger?.type === 'manual' ? 'selected' : ''}></option>
      </select>
    </div>
    <div class="form-group">
      <label></label>
      <div id="wfEditSteps">${stepsHtml}</div>
      <button class="btn btn-secondary" style="margin-top:8px;font-size:12px;" onclick="addWorkflowStep()">+ </button>
    </div>
    <button class="btn btn-primary" onclick="handleSaveEditedWorkflow('${workflowId}')"></button>
  `, { width: '550px' });
}

function addWorkflowStep() {
  const container = document.getElementById('wfEditSteps');
  if (!container) return;
  const agents = state.agents || [];
  const idx = container.children.length;
  const div = document.createElement('div');
  div.className = 'form-group';
  div.style = 'display:flex;gap:8px;align-items:center;';
  div.innerHTML = `
    <span style="font-weight:600;min-width:24px;">${idx + 1}.</span>
    <select id="wfEditAgent${idx}" style="flex:1;">
      ${agents.map(a => '<option value="' + a.name + '">' + a.emoji + ' ' + a.name + '</option>').join('')}
    </select>
    <input type="text" id="wfEditAction${idx}" placeholder="Action" style="flex:2;">
    <button class="btn-icon" onclick="this.parentElement.remove()" title=""></button>
  `;
  container.appendChild(div);
}

function handleSaveEditedWorkflow(workflowId) {
  const wf = state.workflows.find(w => w.id === workflowId);
  if (!wf) return;
  wf.name = document.getElementById('wfEditName')?.value || wf.name;
  wf.description = document.getElementById('wfEditDesc')?.value || '';
  wf.trigger = { type: document.getElementById('wfEditTrigger')?.value || 'manual', label: document.getElementById('wfEditTrigger')?.selectedOptions[0]?.textContent || 'Manual' };
  // Collect steps
  const stepsContainer = document.getElementById('wfEditSteps');
  const newSteps = [];
  if (stepsContainer) {
    Array.from(stepsContainer.children).forEach((el, idx) => {
      const agentSel = el.querySelector('select');
      const actionInput = el.querySelector('input[type="text"]');
      if (agentSel && actionInput && actionInput.value.trim()) {
        newSteps.push({ agent: agentSel.value, action: actionInput.value.trim() });
      }
    });
  }
  wf.steps = newSteps;
  saveState();
  closeModal();
  showToast('');
  handleRoute(window.location.hash);
}

function handleUseGlobalConfig(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent && state.llmConfig) {
    agent.llmConfig = { ...state.llmConfig };
    saveState();
    handleRoute(window.location.hash);
  }
}

function handleLLMConfigChange(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (!agent) return;
  if (!agent.llmConfig) agent.llmConfig = {};
  const provEl = document.getElementById('llmProvider');
  const modelEl = document.getElementById('llmModel');
  const tempEl = document.getElementById('llmTemp');
  if (provEl) agent.llmConfig.provider = provEl.value;
  if (modelEl) agent.llmConfig.model = modelEl.value;
  if (tempEl) agent.llmConfig.temperature = parseFloat(tempEl.value);
  saveState();
}

function reloadActivityPage() {
  const container = document.getElementById('view-container');
  if (container) renderAgentActivity(container, {});
}

function filterActivityLog() {
  reloadActivityPage();
}

function getSelectedProjects() {
  const checkboxes = document.querySelectorAll('.checkbox-label input[type="checkbox"]');
  const ids = [];
  checkboxes.forEach((cb, idx) => {
    if (cb.checked && state.projects[idx]) ids.push(state.projects[idx].id);
  });
  return ids;
}

    
function toggleTheme() {
  const themes = ['light', 'dark', 'system'];
  const current = state.theme || 'system';
  const idx = themes.indexOf(current);
  const next = themes[(idx + 1) % themes.length];
  setTheme(next);
}

// ==================== TALK UI ENGINE ====================

// --- Panel toggle ---
function toggleTalkPanel() {
  const panel = document.getElementById('talk-panel');
  const fab = document.getElementById('talk-fab');
  const fabIcon = document.getElementById('talk-fab-icon');
  state.talkPanelOpen = !state.talkPanelOpen;
  panel.classList.toggle('visible', state.talkPanelOpen);
  fab.classList.toggle('open', state.talkPanelOpen);
  fabIcon.textContent = state.talkPanelOpen ? '' : '';
  fab.classList.remove('has-unread');
  if (state.talkPanelOpen) {
    if (state.chatMessages.length === 0) initChatWelcome();
    const input = document.getElementById('talk-input');
    setTimeout(() => input && input.focus(), 300);
  }
}

function initChatWelcome() {
  appendBotMessage('  DTO Assistant\n\n ****  \n **Agent**  Agent \n ****  \n ****  \n\n');
}

// --- Message rendering ---
function renderChatMessages() {
  const container = document.getElementById('talk-messages');
  if (!container) return;
  container.innerHTML = state.chatMessages.map(m => {
    const timeStr = new Date(m.ts).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    if (m.role === 'system') {
      return `<div class="talk-msg system">${m.text}</div>`;
    }
    const cls = m.role === 'user' ? 'user' : 'bot';
    const actionsHtml = m.actions ? `<div class="msg-actions">${m.actions.map(a => `<button onclick="sendSuggestion('${a.replace(/'/g, "\\'")}')">${a}</button>`).join('')}</div>` : '';
    return `<div class="talk-msg ${cls}">${formatMsgText(m.text)}<span class="msg-time">${timeStr}</span>${actionsHtml}</div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function formatMsgText(text) {
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.+?)`/g, '<code style="background:rgba(99,102,241,0.1);padding:1px 4px;border-radius:3px;font-size:12px;">$1</code>');
}

function appendUserMessage(text) {
  state.chatMessages.push({ role: 'user', text, ts: Date.now() });
  renderChatMessages();
}

function appendBotMessage(text, actions) {
  state.chatMessages.push({ role: 'bot', text, ts: Date.now(), actions: actions || null });
  renderChatMessages();
}

function appendSystemMessage(text) {
  state.chatMessages.push({ role: 'system', text, ts: Date.now() });
  renderChatMessages();
}

function showTyping(show) {
  const el = document.getElementById('talk-typing');
  if (el) el.classList.toggle('show', !!show);
}

// --- Input handling ---
function handleTalkKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendTalkMessage();
  }
}

function autoResizeTalkInput(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 80) + 'px';
}

function sendSuggestion(text) {
  const input = document.getElementById('talk-input');
  if (input) input.value = text;
  sendTalkMessage();
}

async function sendTalkMessage() {
  const input = document.getElementById('talk-input');
  const text = (input.value || '').trim();
  if (!text) return;
  input.value = '';
  input.style.height = 'auto';
  appendUserMessage(text);
  showTyping(true);

  // Check if LLM is configured (provider values may be capitalized from Settings UI)
  const prov = (state.llmConfig && state.llmConfig.provider || '').toLowerCase();
  const hasLLM = prov && prov !== 'none' && state.llmConfig.apiKey;

  await new Promise(r => setTimeout(r, 400 + Math.random() * 400));

  // Try local command first
  const localResult = parseAndExecuteCommand(text);
  if (localResult) {
    // Handle async commands
    if (localResult.reply === '__ASYNC_ACTIVITY__') {
      const asyncResult = await cmdRecentActivity();
      showTyping(false);
      appendBotMessage(asyncResult.reply, asyncResult.actions || null);
      return;
    }
    showTyping(false);
    appendBotMessage(localResult.reply, localResult.actions || null);
    return;
  }

  // If LLM configured, route to LLM
  if (hasLLM) {
    try {
      const llmReply = await callLLM(text);
      showTyping(false);
      appendBotMessage(llmReply);
    } catch (err) {
      showTyping(false);
      appendBotMessage(' LLM ' + err.message + '\n\n');
    }
    return;
  }

  // Fallback: no LLM, not a recognized command
  showTyping(false);
  appendBotMessage(' \n\n ****  \n ** PX  N%**  \n ****  \n ****  \n **Agent **   Agent\n **/ Agent XXX**\n ** **\n\n LLM API Key', ['', '', '']);
}

function clearChatHistory() {
  state.chatMessages = [];
  renderChatMessages();
  initChatWelcome();
}

// ==================== LOCAL COMMAND PARSER ====================

function parseAndExecuteCommand(text) {
  const t = text.trim();

  // ---  ---
  if (/^(|||project\s*(list|overview)?|dashboard)/i.test(t)) {
    return cmdProjectOverview();
  }

  // ---  /  ---
  if (/^(||weekly\s*summary|summary)/i.test(t)) {
    return cmdWeeklySummary();
  }

  // ---  ---
  if (/^(||overdue||)/i.test(t)) {
    return cmdOverdueItems();
  }

  // --- Agent  ---
  if (/^(agent\s*(|status||list)?|\s*agent)/i.test(t)) {
    return cmdAgentStatus();
  }

  // --- : " P3  50%" or "P3  50" ---
  const progressMatch = t.match(/(?:||set)?\s*(P\d+)\s*(?:|progress)?\s*(?:||to|=||:)?\s*(\d+)\s*%?/i);
  if (progressMatch) {
    return cmdUpdateProgress(progressMatch[1].toUpperCase(), parseInt(progressMatch[2]));
  }

  // --- : " XXX" ---
  const completeMatch = t.match(/^(?:||mark\s*done|done|close)\s+(.+)/i);
  if (completeMatch) {
    return cmdCompleteAction(completeMatch[1].trim());
  }

  // ---  Agent ---
  const activateMatch = t.match(/^(?:|activate|start|)\s+(?:agent\s*)?(.+)/i);
  if (activateMatch) {
    return cmdToggleAgent(activateMatch[1].trim(), 'active');
  }

  // ---  Agent ---
  const pauseMatch = t.match(/^(?:|pause|stop|)\s+(?:agent\s*)?(.+)/i);
  if (pauseMatch) {
    return cmdToggleAgent(pauseMatch[1].trim(), 'paused');
  }

  // --- : "P3 " or " P3" ---
  const queryProjMatch = t.match(/^(?:|query|look\s*up)?\s*(P\d+)\s*(?:|status||detail|)?$/i);
  if (queryProjMatch) {
    return cmdProjectDetail(queryProjMatch[1].toUpperCase());
  }

  // --- : " XXX" ---
  const searchMatch = t.match(/^(?:||search|find|)\s+(.+)/i);
  if (searchMatch) {
    return cmdSearch(searchMatch[1].trim());
  }

  // ---  Agent ---
  const assignMatch = t.match(/^(?:|assign|)\s+(.+?)\s+(?:|task|)\s+(.+)/i);
  if (assignMatch) {
    return cmdAssignTask(t);
  }

  // ---  Agent  ---
  const viewTaskMatch = t.match(/^(?:|view|show|)\s+(.+?)(?:\s*(?:||tasks))$/i);
  if (viewTaskMatch) {
    return cmdViewAgentTasks(t);
  }

  // ---  ---
  if (/^(||workflows?||)/i.test(t)) {
    return cmdWorkflowList();
  }

  // ---  ---
  const triggerWfMatch = t.match(/^(?:||trigger|run|)\s+(.+)/i);
  if (triggerWfMatch) {
    // Check if it's a workflow name vs agent name
    const wfName = triggerWfMatch[1].trim();
    const wf = state.workflows.find(w => w.name.toLowerCase().includes(wfName.toLowerCase()));
    if (wf) return cmdTriggerWorkflow(wfName);
    // If starts with "", parse differently
    if (/^/.test(t)) {
      return cmdToggleWorkflow(t.replace(/^\s*/, ''), 'active');
    }
  }

  // ---  ---
  const pauseWfMatch = t.match(/^\s+(.+)/i);
  if (pauseWfMatch) {
    return cmdToggleWorkflow(pauseWfMatch[1].trim(), 'paused');
  }

  // ---  ---
  if (/^(|notifications?|)/i.test(t)) {
    return cmdNotifications();
  }

  // ---  ---
  if (/^(||activity\s*log|recent\s*activity|)/i.test(t)) {
    return { reply: '__ASYNC_ACTIVITY__' };
  }

  // ---  Agent : " AgentName " or "run AgentName" ---
  const execAgentMatch = t.match(/^(?:|run||)\s+(.+?)(?:\s*(?:|all||)?(?:|tasks?|))?$/i);
  if (execAgentMatch) {
    const name = execAgentMatch[1].trim();
    const agent = state.agents.find(a => a.name.toLowerCase().includes(name.toLowerCase()));
    if (agent) {
      const pending = (agent.taskQueue || []).filter(t => t.status === 'pending' || t.status === 'in_progress');
      if (pending.length === 0) return { reply: `${agent.emoji} ${agent.name} ` };
      // Trigger async execution
      executeAllAgentTasks(agent.id);
      return { reply: `  ${agent.emoji} **${agent.name}**  ${pending.length} ...\n\n` };
    }
    // Check if it's a workflow name (handled above), else fall through
  }

  // --- : " AgentName" ---
  const resultMatch = t.match(/^(?:|result||)\s+(.+)/i);
  if (resultMatch) {
    return cmdAgentResults(resultMatch[1].trim());
  }

  // --- : " AgentName" ---
  const perfMatch = t.match(/^(?:|performance||)\s+(.+)/i);
  if (perfMatch) {
    return cmdAgentPerformance(perfMatch[1].trim());
  }

  // ---  ---
  if (/^(help|||commands|||\/help)/i.test(t)) {
    return cmdHelp();
  }

  // Not matched
  return null;
}

// ==================== COMMAND EXECUTORS ====================

function cmdProjectOverview() {
  const lines = state.projects.map(p => {
    const bar = progressBar(p.progress);
    return `**${p.code}** ${p.name}\n${bar} ${p.progress}%`;
  });
  return { reply: ' ****\n\n' + lines.join('\n\n') };
}

function progressBar(pct) {
  const filled = Math.round(pct / 10);
  return ''.repeat(filled) + ''.repeat(10 - filled);
}

function cmdWeeklySummary() {
  const totalProjects = state.projects.length;
  const avgProgress = Math.round(state.projects.reduce((s, p) => s + p.progress, 0) / totalProjects);
  const totalActions = state.projects.reduce((s, p) => s + (p.actions || []).length, 0);
  const completedActions = state.projects.reduce((s, p) => s + (p.actions || []).filter(a => a.status === 'completed').length, 0);
  const overdueActions = state.projects.reduce((s, p) => s + (p.actions || []).filter(a => a.status !== 'completed' && a.dueDate && new Date(a.dueDate) < new Date()).length, 0);
  const activeAgents = state.agents.filter(a => a.status === 'active').length;

  let risk = state.projects.filter(p => p.progress < 30).map(p => ` ${p.code} ${p.name}${p.progress}%`).join('\n');

  let reply = ` ****\n\n`;
  reply += `****${totalProjects}  ${avgProgress}%\n`;
  reply += `**** ${totalActions}  ${completedActions} \n`;
  reply += `****${overdueActions} \n`;
  reply += `**AI Agents**${activeAgents}/${state.agents.length} \n`;
  if (risk) reply += `\n ****\n${risk}`;

  return { reply, actions: ['', '', 'Agent '] };
}

function cmdOverdueItems() {
  const now = new Date();
  const items = [];
  state.projects.forEach(p => {
    (p.actions || []).forEach(a => {
      if (a.status !== 'completed' && a.dueDate && new Date(a.dueDate) < now) {
        const days = Math.floor((now - new Date(a.dueDate)) / 86400000);
        items.push({ project: p.code, name: a.name, days, priority: a.priority || '-' });
      }
    });
  });

  if (items.length === 0) {
    return { reply: ' ', actions: ['', ''] };
  }

  items.sort((a, b) => b.days - a.days);
  const lines = items.slice(0, 15).map(i =>
    ` **${i.project}** ${i.name}   ${i.days}  [${i.priority}]`
  );
  return { reply: ` **${items.length} **\n\n${lines.join('\n')}${items.length > 15 ? `\n\n... ${items.length - 15} ` : ''}` };
}

function cmdAgentStatus() {
  const lines = state.agents.map(a => {
    const emoji = a.status === 'active' ? '' : a.status === 'paused' ? '' : '';
    return `${emoji} **${a.name}** (${a.role})  ${a.status}\n   : ${a.currentTask || ''}`;
  });
  return { reply: ' **Agent **\n\n' + lines.join('\n\n'), actions: [' Agent', ' Agent'] };
}

function cmdUpdateProgress(code, pct) {
  const pctClamped = Math.max(0, Math.min(100, pct));
  const proj = state.projects.find(p => p.code === code);
  if (!proj) return { reply: `  **${code}**${state.projects.map(p => p.code).join(', ')}` };
  const oldPct = proj.progress;
  proj.progress = pctClamped;
  saveState();
  handleRoute(window.location.hash);
  logActivity('project', proj.id, 'progress_updated', { code: proj.code, from: oldPct, to: pctClamped });
  pushNotification('', `${proj.code} ${proj.name}: ${oldPct}%  ${pctClamped}%`);
  return { reply: `  **${proj.code} ${proj.name}** ${oldPct}%  **${pctClamped}%**\n${progressBar(pctClamped)} ${pctClamped}%` };
}

function cmdCompleteAction(name) {
  let found = null;
  let projCode = '';
  for (const p of state.projects) {
    for (const a of (p.actions || [])) {
      if (a.name && a.name.includes(name)) {
        found = a;
        projCode = p.code;
        break;
      }
    }
    if (found) break;
  }
  if (!found) return { reply: ` ${name}`, actions: [''] };
  if (found.status === 'completed') return { reply: ` **${found.name}** ` };
  found.status = 'completed';
  saveState();
  handleRoute(window.location.hash);
  logActivity('action_item', null, 'action_completed', { name: found.name, project: projCode });
  pushNotification('', `${projCode}: ${found.name}`);
  return { reply: `  **${projCode}** ${found.name}` };
}

function cmdToggleAgent(name, targetStatus) {
  // Handle "" (all) agents
  if (/^(|all)$/i.test(name)) {
    state.agents.forEach(a => a.status = targetStatus);
    saveState();
    handleRoute(window.location.hash);
    const verb = targetStatus === 'active' ? '' : '';
    return { reply: ` ${verb} Agent${state.agents.length} ` };
  }

  const agent = state.agents.find(a =>
    a.name.toLowerCase().includes(name.toLowerCase()) ||
    a.role.toLowerCase().includes(name.toLowerCase())
  );
  if (!agent) return { reply: ` ${name} Agent\n\n Agent${state.agents.map(a => a.name).join(', ')}` };

  const oldStatus = agent.status;
  agent.status = targetStatus;
  saveState();
  handleRoute(window.location.hash);
  logActivity('agent', agent.id, 'agent_status_changed', { name: agent.name, from: oldStatus, to: targetStatus });
  const verb = targetStatus === 'active' ? '' : '';
  return { reply: ` ${verb} **${agent.name}**${oldStatus}  **${targetStatus}**` };
}

function cmdProjectDetail(code) {
  const proj = state.projects.find(p => p.code === code);
  if (!proj) return { reply: `  **${code}**` };
  const actions = proj.actions || [];
  const completed = actions.filter(a => a.status === 'completed').length;
  const overdue = actions.filter(a => a.status !== 'completed' && a.dueDate && new Date(a.dueDate) < new Date()).length;

  let reply = ` **${proj.code} ${proj.name}**\n\n`;
  reply += `${progressBar(proj.progress)} **${proj.progress}%**\n`;
  reply += `${proj.owner || '-'}\n`;
  reply += `${actions.length}  ${completed} ${overdue}\n`;
  if (proj.startDate) reply += `${proj.startDate}\n`;
  if (proj.endDate) reply += `${proj.endDate}\n`;

  if (overdue > 0) {
    const overdueItems = actions.filter(a => a.status !== 'completed' && a.dueDate && new Date(a.dueDate) < new Date()).slice(0, 5);
    reply += `\n ****\n${overdueItems.map(a => ` ${a.name}`).join('\n')}`;
  }

  return { reply, actions: [` ${code}  ${proj.progress + 5}%`] };
}

function cmdSearch(query) {
  const q = query.toLowerCase();
  const results = [];

  // Search projects
  state.projects.forEach(p => {
    if ((p.name && p.name.toLowerCase().includes(q)) || (p.code && p.code.toLowerCase().includes(q))) {
      results.push(` **${p.code}** ${p.name} (${p.progress}%)`);
    }
    (p.actions || []).forEach(a => {
      if (a.name && a.name.toLowerCase().includes(q)) {
        results.push(` **${p.code}**  ${a.name} [${a.status}]`);
      }
    });
  });

  // Search agents
  state.agents.forEach(a => {
    if ((a.name && a.name.toLowerCase().includes(q)) || (a.role && a.role.toLowerCase().includes(q))) {
      results.push(` **${a.name}** (${a.role})  ${a.status}`);
    }
  });

  if (results.length === 0) return { reply: ` ${query}` };
  return { reply: ` **${query}${results.length} **\n\n${results.slice(0, 20).join('\n')}${results.length > 20 ? `\n\n... ${results.length - 20} ` : ''}` };
}

function cmdAgentResults(name) {
  const agent = state.agents.find(a => a.name.toLowerCase().includes(name.toLowerCase()));
  if (!agent) return { reply: `  Agent${name}` };
  const withResults = (agent.taskQueue || []).filter(t => t.result);
  if (withResults.length === 0) return { reply: `${agent.emoji} **${agent.name}**  AI \n\n  \` ${agent.name}\`  Agent ` };
  const lines = withResults.slice(-5).reverse().map(t => {
    const time = t.completedAt ? new Date(t.completedAt).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
    const preview = t.result.replace(/\n/g, ' ').substring(0, 80);
    return `**${t.title}** (${t.executionTime || ''}, ${time})\n   ${preview}...`;
  });
  return { reply: ` **${agent.emoji} ${agent.name} **\n\n${lines.join('\n\n')}\n\n  Agent ` };
}

function cmdAgentPerformance(name) {
  const agent = state.agents.find(a => a.name.toLowerCase().includes(name.toLowerCase()));
  if (!agent) return { reply: `  Agent${name}` };
  const m = agent.metrics || {};
  const queue = agent.taskQueue || [];
  const total = queue.length;
  const done = queue.filter(t => t.status === 'completed').length;
  const failed = queue.filter(t => t.error).length;
  const pending = queue.filter(t => t.status === 'pending').length;
  const inProg = queue.filter(t => t.status === 'in_progress').length;
  const withResults = queue.filter(t => t.result);
  const avgTime = withResults.length > 0 ? (withResults.reduce((s, t) => s + parseFloat(t.executionTime || '0'), 0) / withResults.length).toFixed(1) : '';

  return {
    reply: ` **${agent.emoji} ${agent.name} **\n\n` +
      `****\n` +
      `${agent.role}\n` +
      `${agent.status === 'active' ? ' ' : ' '}\n` +
      `${agent.autonomy}\n\n` +
      `****\n` +
      `${total} |  ${done} |  ${inProg} |  ${pending} |  ${failed}\n` +
      `${total > 0 ? Math.round((done / total) * 100) : 0}%\n` +
      `${avgTime}s\n` +
      `${m.reliability || 0}%\n\n` +
      `****\n` +
      `${(agent.assignedProjects || []).map(pid => { const p = state.projects.find(pr => pr.id === pid); return p ? p.code + ' ' + p.name : null; }).filter(Boolean).join('\n') || ''}`
  };
}

function cmdHelp() {
  return {
    reply: ` **DTO Assistant **\n\n` +
      `** **\n` +
      ` \`\`  \n` +
      ` \`\`  \n` +
      ` \`\`  \n` +
      ` \`Agent \`   AI Agent \n` +
      ` \`P3\`  \` P3\`  \n` +
      ` \` \`  \n` +
      ` \`\`  \n` +
      ` \`\`  \n` +
      ` \`\`  \n\n` +
      `** **\n` +
      ` \` P3  50%\`  \n` +
      ` \` \`  \n` +
      ` \`/ Agent\`   Agent \n\n` +
      `** Agent **\n` +
      ` \` Agent  \`\n` +
      ` \` Agent \`\n` +
      ` \` Agent\`   AI \n` +
      ` \` Agent\`   AI \n` +
      ` \` Agent\`   Agent \n\n` +
      `** **\n` +
      ` \` \`  \n` +
      ` \` \` / \` \`\n\n` +
      `  LLM API + AI `,
    actions: ['', ' Agent', ' Agent']
  };
}

// ==================== ACTIVITY LOG SYSTEM ====================

async function logActivity(entityType, entityId, action, details) {
  // Log to local agent activityLog
  const logEntry = {
    time: new Date().toISOString(),
    type: action.includes('error') || action.includes('fail') ? 'error' : action.includes('warn') ? 'warning' : 'info',
    message: `[${entityType}] ${action}: ${typeof details === 'string' ? details : JSON.stringify(details)}`
  };

  // Find relevant agent and append to its activityLog
  if (entityType === 'agent') {
    const agent = state.agents.find(a => a.id === entityId);
    if (agent) {
      if (!agent.activityLog) agent.activityLog = [];
      agent.activityLog.unshift(logEntry);
      if (agent.activityLog.length > 50) agent.activityLog = agent.activityLog.slice(0, 50);
    }
  }

  // Write to Supabase activity_logs table
  if (sb) {
    try {
      await sb.from('activity_logs').insert({
        entity_type: entityType,
        entity_id: entityId || null,
        action: action,
        details: typeof details === 'object' ? details : { message: details },
        performed_by: 'talk_ui'
      });
    } catch (e) {
      console.warn('[ActivityLog] Cloud write failed:', e);
    }
  }
}

// ==================== AGENT TASK MANAGEMENT ====================

function cmdAssignTask(text) {
  // Parse: " AgentName  TaskTitle" or "assign AgentName task Title"
  const match = text.match(/^(?:|assign|)\s+(.+?)\s+(?:|task|)\s+(.+)/i);
  if (!match) return null;

  const agentName = match[1].trim();
  const taskTitle = match[2].trim();

  const agent = state.agents.find(a =>
    a.name.toLowerCase().includes(agentName.toLowerCase()) ||
    a.role.toLowerCase().includes(agentName.toLowerCase())
  );
  if (!agent) return { reply: ` ${agentName} Agent\n${state.agents.map(a => a.name).join(', ')}` };

  const newTask = {
    id: crypto.randomUUID(),
    title: taskTitle,
    status: 'pending',
    priority: 'medium',
    assignedAt: new Date().toISOString()
  };

  if (!agent.taskQueue) agent.taskQueue = [];
  agent.taskQueue.push(newTask);
  saveState();

  // Also write to Supabase agent_tasks
  if (sb) {
    sb.from('agent_tasks').insert({
      agent_id: agent.id,
      task_type: 'manual',
      title: taskTitle,
      status: 'pending',
      priority: 'medium'
    }).then(() => {}).catch(e => console.warn('[AgentTask] Cloud insert failed:', e));
  }

  logActivity('agent', agent.id, 'task_assigned', { taskTitle, agentName: agent.name });
  handleRoute(window.location.hash);

  return {
    reply: `  **${agent.name}**\n ${taskTitle}\n\n${agent.name}  **${agent.taskQueue.length}** `,
    actions: [` ${agent.name} `]
  };
}

function cmdViewAgentTasks(text) {
  // Parse: " AgentName " or "AgentName tasks"
  const match = text.match(/^(?:|view|show|)\s+(.+?)(?:\s*(?:|||tasks))?$/i);
  if (!match) return null;

  const agentName = match[1].trim();
  const agent = state.agents.find(a =>
    a.name.toLowerCase().includes(agentName.toLowerCase()) ||
    a.role.toLowerCase().includes(agentName.toLowerCase())
  );
  if (!agent) return null;

  const tasks = agent.taskQueue || [];
  if (tasks.length === 0) {
    return { reply: ` **${agent.name}** `, actions: [` ${agent.name}  `] };
  }

  const statusEmoji = { pending: '', in_progress: '', completed: '', failed: '', running: '' };
  const lines = tasks.slice(0, 10).map(t =>
    `${statusEmoji[t.status] || ''} **${t.title || t.name}** [${t.status}]${t.priority ? ' P:' + t.priority : ''}`
  );

  return {
    reply: ` **${agent.name}** ${tasks.length} \n\n${lines.join('\n')}${tasks.length > 10 ? '\n...' : ''}`,
    actions: [` ${agent.name}  `]
  };
}

// ==================== WORKFLOW TRIGGER VIA TALK UI ====================

function cmdWorkflowList() {
  const wfs = state.workflows || [];
  if (wfs.length === 0) return { reply: '  Agent >  ' };

  const lines = wfs.map(w => {
    const emoji = w.status === 'active' ? '' : '';
    const stepsStr = (w.steps || []).map(s => s.agent).join('  ');
    return `${emoji} **${w.name}** [${w.status}]\n   ${stepsStr || ''}\n   ${w.lastRun || ''}`;
  });

  return {
    reply: ` **${wfs.length} **\n\n${lines.join('\n\n')}`,
    actions: wfs.filter(w => w.status === 'active').slice(0, 3).map(w => ` ${w.name}`)
  };
}

function cmdTriggerWorkflow(name) {
  const wf = state.workflows.find(w =>
    w.name.toLowerCase().includes(name.toLowerCase())
  );
  if (!wf) return { reply: ` ${name}\n\n${state.workflows.map(w => w.name).join(', ')}` };
  if (wf.status !== 'active') return { reply: ` ${wf.name}`, actions: [` ${wf.name}`] };

  // Simulate workflow execution
  const steps = wf.steps || [];
  wf.lastRun = new Date().toISOString().replace('T', ' ').substring(0, 16);
  if (!wf.runCount) wf.runCount = 0;
  wf.runCount++;
  saveState();

  // Log each step
  const stepLog = steps.map((s, i) => `  ${i + 1}.  **${s.agent}**  ${s.action}  ${s.output || ''}`).join('\n');

  // Create tasks for involved agents
  steps.forEach(step => {
    const agent = state.agents.find(a => a.name.toLowerCase().includes(step.agent.toLowerCase()));
    if (agent) {
      if (!agent.taskQueue) agent.taskQueue = [];
      agent.taskQueue.push({
        id: crypto.randomUUID(),
        title: `[${wf.name}] ${step.action}`,
        status: 'in_progress',
        priority: 'high',
        assignedAt: new Date().toISOString(),
        workflowId: wf.id
      });
      agent.currentTask = `[${wf.name}] ${step.action}`;
      agent.status = 'active';
    }
  });
  saveState();
  handleRoute(window.location.hash);

  logActivity('workflow', wf.id, 'workflow_triggered', { name: wf.name, steps: steps.length, runCount: wf.runCount });

  return {
    reply: ` **${wf.name}**\n\n\n${stepLog}\n\n ${wf.runCount}  | ${steps.length}  Agent`,
    actions: ['Agent ', '']
  };
}

function cmdToggleWorkflow(name, targetStatus) {
  const wf = state.workflows.find(w => w.name.toLowerCase().includes(name.toLowerCase()));
  if (!wf) return { reply: ` ${name}` };
  wf.status = targetStatus;
  saveState();
  handleRoute(window.location.hash);
  const verb = targetStatus === 'active' ? '' : '';
  return { reply: ` ${verb}${wf.name}` };
}

// ==================== NOTIFICATION SYSTEM ====================

let notificationQueue = [];

function pushNotification(title, body, type) {
  const notif = { id: Date.now(), title, body, type: type || 'info', ts: Date.now(), read: false };
  notificationQueue.push(notif);
  if (notificationQueue.length > 50) notificationQueue = notificationQueue.slice(-50);

  // Show toast
  showToast(title + (body ? ': ' + body.substring(0, 60) : ''), type === 'error' ? 'error' : 'success');

  // Update fab badge if panel is closed
  if (!state.talkPanelOpen) {
    const fab = document.getElementById('talk-fab');
    if (fab) fab.classList.add('has-unread');
  }
  // Update notification center badge
  updateNotifBadge();
  renderNotifList();
}

// --- Notification Center UI ---
function toggleNotifPanel() {
  const panel = document.getElementById('notif-panel');
  if (!panel) return;
  const isVisible = panel.classList.contains('visible');
  panel.classList.toggle('visible', !isVisible);
  if (!isVisible) renderNotifList();
}

function updateNotifBadge() {
  const badge = document.getElementById('notif-badge-count');
  if (!badge) return;
  const unread = notificationQueue.filter(n => !n.read).length;
  badge.textContent = unread > 9 ? '9+' : String(unread);
  badge.classList.toggle('visible', unread > 0);
}

function renderNotifList() {
  const container = document.getElementById('notif-list');
  if (!container) return;
  if (notificationQueue.length === 0) {
    container.innerHTML = '<div class="notif-empty"><br><small> Talk AI </small></div>';
    return;
  }
  const items = notificationQueue.slice().reverse();
  container.innerHTML = items.map(n => {
    const time = new Date(n.ts).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    return `<div class="notif-item ${n.read ? '' : 'unread'}" onclick="markNotifRead(${n.id})">
      <div class="notif-dot ${n.type || 'info'}"></div>
      <div class="notif-content">
        <div class="notif-title">${n.title}</div>
        ${n.body ? '<div class="notif-body">' + n.body.substring(0, 80) + '</div>' : ''}
      </div>
      <div class="notif-time">${time}</div>
    </div>`;
  }).join('');
}

function markNotifRead(notifId) {
  const n = notificationQueue.find(x => x.id === notifId);
  if (n) n.read = true;
  updateNotifBadge();
  renderNotifList();
}

function markAllNotifsRead() {
  notificationQueue.forEach(n => n.read = true);
  updateNotifBadge();
  renderNotifList();
}

function cmdNotifications() {
  if (notificationQueue.length === 0) return { reply: ' ' };
  const recent = notificationQueue.slice(-10).reverse();
  const lines = recent.map(n => {
    const emoji = n.type === 'error' ? '' : n.type === 'warning' ? '' : '';
    const time = new Date(n.ts).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    return `${emoji} [${time}] **${n.title}**${n.body ? '\n   ' + n.body : ''}`;
  });
  notificationQueue.forEach(n => n.read = true);
  return { reply: ` **${notificationQueue.length} **\n\n${lines.join('\n\n')}` };
}

// ==================== RECENT ACTIVITY LOG VIEW ====================

async function cmdRecentActivity() {
  if (!sb) return { reply: ' Supabase ' };
  try {
    const { data, error } = await sb.from('activity_logs')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(15);
    if (error) throw error;
    if (!data || data.length === 0) return { reply: '  Talk UI ' };

    const lines = data.map(log => {
      const time = new Date(log.created_at).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      const detail = log.details?.message || log.details?.taskTitle || log.details?.name || JSON.stringify(log.details).substring(0, 40);
      return ` [${time}] **${log.action}** (${log.entity_type})  ${detail}`;
    });

    return { reply: ` **${data.length} **\n\n${lines.join('\n')}` };
  } catch (e) {
    return { reply: ' ' + e.message };
  }
}

// ==================== LLM API HOOK ====================

async function callLLM(userMessage) {
  const config = state.llmConfig;
  if (!config || !config.apiKey) throw new Error(' API Key');

  const provider = (config.provider || '').toLowerCase();
  const modelName = config.modelName || config.model || '';
  const apiEndpoint = config.apiEndpoint || config.endpoint || '';
  const temp = config.temperature || 0.7;
  const maxTok = config.maxTokens || 1024;
  const systemPrompt = buildSystemPrompt();

  // Build messages
  const msgs = [
    { role: 'system', content: systemPrompt },
    ...state.chatMessages.filter(m => m.role !== 'system').slice(-10).map(m => ({
      role: m.role === 'bot' ? 'assistant' : 'user',
      content: m.text
    })),
    { role: 'user', content: userMessage }
  ];

  let endpoint = '';
  let headers = {};
  let body = {};

  if (provider === 'openai' || provider === 'chatgpt') {
    endpoint = apiEndpoint || 'https://api.openai.com/v1/chat/completions';
    headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + config.apiKey };
    body = { model: modelName || 'gpt-4o-mini', messages: msgs, temperature: temp, max_tokens: maxTok };
  } else if (provider === 'anthropic' || provider === 'claude') {
    endpoint = apiEndpoint || 'https://api.anthropic.com/v1/messages';
    headers = { 'Content-Type': 'application/json', 'x-api-key': config.apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' };
    body = { model: modelName || 'claude-sonnet-4-20250514', system: systemPrompt, messages: msgs.filter(m => m.role !== 'system'), max_tokens: maxTok };
  } else if (provider === 'ollama' || provider === 'local') {
    endpoint = apiEndpoint || 'http://localhost:11434/api/chat';
    headers = { 'Content-Type': 'application/json' };
    body = { model: modelName || 'llama3', messages: msgs, stream: false };
  } else {
    // Generic OpenAI-compatible endpoint
    endpoint = apiEndpoint || 'https://api.openai.com/v1/chat/completions';
    headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + config.apiKey };
    body = { model: modelName || 'gpt-4o-mini', messages: msgs, temperature: temp, max_tokens: maxTok };
  }

  const updateStatus = document.getElementById('talk-status-text');
  if (updateStatus) updateStatus.textContent = ` ${provider} ...`;

  const resp = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(body) });
  if (!resp.ok) {
    const err = await resp.text();
    if (updateStatus) updateStatus.textContent = '';
    throw new Error(`${resp.status}: ${err.substring(0, 200)}`);
  }

  const data = await resp.json();
  if (updateStatus) updateStatus.textContent = `${provider} `;

  // Extract reply based on provider format
  if (provider === 'anthropic' || provider === 'claude') {
    return (data.content && data.content[0] && data.content[0].text) || '(empty response)';
  } else if (provider === 'ollama' || provider === 'local') {
    return (data.message && data.message.content) || '(empty response)';
  } else {
    return (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '(empty response)';
  }
}

function buildSystemPrompt() {
  const projSummary = state.projects.map(p => `${p.code} ${p.name}: ${p.progress}%`).join('; ');
  const agentSummary = state.agents.map(a => `${a.name}(${a.role}): ${a.status}`).join('; ');
  return ` DTO Dashboard  AI 
${projSummary}
 Agent${agentSummary}
${state.projects.reduce((s, p) => s + (p.actions || []).length, 0)} 
 P3  50%`;
}

    // ==================== AGENT AUTO-EXECUTION ENGINE ====================

    /**
     * Execute a task using the Agent's LLM config (or fall back to global LLM config).
     * This is the core AI-powered execution: the Agent reads the task, generates a response,
     * and stores the result. The task status transitions: pending  in_progress  completed.
     */
    async function executeAgentTask(agentId, taskId) {
      const agent = state.agents.find(a => a.id === agentId);
      if (!agent) { showToast('Agent ', 'error'); return; }
      const task = (agent.taskQueue || []).find(t => t.id === taskId);
      if (!task) { showToast('', 'error'); return; }
      if (task._executing) { showToast('', 'warning'); return; }

      // Determine LLM config: agent-level > global
      const agentCfg = agent.llmConfig || {};
      const globalCfg = state.llmConfig || {};
      const prov = (agentCfg.provider && agentCfg.provider.toLowerCase() !== 'none') ? agentCfg : globalCfg;
      const provName = (prov.provider || '').toLowerCase();
      if (!provName || provName === 'none') {
        showToast(' LLM', 'warning');
        return;
      }

      // Mark task as executing
      task._executing = true;
      task.status = 'in_progress';
      task.startedAt = new Date().toISOString();
      agent.currentTask = task.title;
      agent.status = 'active';
      saveState();
      handleRoute(window.location.hash);

      // Build execution prompt
      const projContext = (agent.assignedProjects || []).map(pid => {
        const p = state.projects.find(pr => pr.id === pid);
        if (!p) return '';
        const items = (p.actionItems || []).map(a => `  - ${a.name} (${a.status}, ${a.priority})`).join('\n');
        return ` ${p.code} ${p.name} (: ${p.progress}%):\n${items}`;
      }).filter(Boolean).join('\n\n');

      const agentPrompt = ` AI Agent${agent.name}${agent.role}
${agent.description ? '' + agent.description : ''}


${projContext || ''}


**${task.title}**
${task.description || ''}


1. 
2. 
3. `;

      const startTime = Date.now();

      try {
        // Temporarily use agent's LLM config for the call
        const originalConfig = { ...state.llmConfig };
        if (agentCfg.provider && agentCfg.provider.toLowerCase() !== 'none') {
          state.llmConfig = {
            provider: agentCfg.provider,
            apiKey: agentCfg.apiKey || globalCfg.apiKey,
            apiEndpoint: agentCfg.apiEndpoint || agentCfg.endpoint || globalCfg.apiEndpoint || globalCfg.endpoint || '',
            modelName: agentCfg.model || agentCfg.modelName || globalCfg.modelName || '',
            temperature: agentCfg.temperature || 0.7,
            maxTokens: globalCfg.maxTokens || 2000
          };
        }

        const result = await callLLM(agentPrompt);

        // Restore global config
        state.llmConfig = originalConfig;

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        // Save result
        task.result = result;
        task.completedAt = new Date().toISOString();
        task.executionTime = elapsed + 's';
        task.status = 'completed';
        task._executing = false;
        agent.currentTask = '';

        // Update metrics
        if (!agent.metrics) agent.metrics = {};
        agent.metrics.tasksCompleted = (agent.metrics.tasksCompleted || 0) + 1;
        agent.metrics.avgResponseTime = elapsed + 's';
        const totalTasks = agent.taskQueue.length || 1;
        const completedTasks = agent.taskQueue.filter(t => t.status === 'completed').length;
        agent.metrics.reliability = Math.round((completedTasks / totalTasks) * 100);

        // Log activity
        logActivity('agent', agentId, 'task_completed', {
          taskTitle: task.title, result: result.substring(0, 200), executionTime: elapsed + 's'
        });
        pushNotification('', `${agent.emoji} ${agent.name} ${task.title}(${elapsed}s)`, 'success');

        // Write to Supabase agent_tasks
        if (sb) {
          try {
            await sb.from('agent_tasks').upsert({
              id: task.id, agent_id: agentId, title: task.title,
              status: 'completed', priority: task.priority,
              result: result.substring(0, 5000),
              completed_at: task.completedAt
            }, { onConflict: 'id' });
          } catch (e) { console.warn('agent_tasks upsert error:', e); }
        }

        saveState();
        handleRoute(window.location.hash);
        showToast(` ${agent.name}  (${elapsed}s)`, 'success');

      } catch (err) {
        // Restore global config on error too
        task._executing = false;
        task.status = 'pending';
        task.error = err.message;
        agent.currentTask = '';
        saveState();
        handleRoute(window.location.hash);
        logActivity('agent', agentId, 'task_failed', { taskTitle: task.title, error: err.message });
        pushNotification('', `${agent.emoji} ${agent.name}: ${err.message.substring(0, 80)}`, 'error');
        showToast(' : ' + err.message.substring(0, 100), 'error');
      }
    }

    /**
     * Show the full AI execution result in a modal
     */
    function showTaskResult(agentId, taskId) {
      const agent = state.agents.find(a => a.id === agentId);
      if (!agent) return;
      const task = (agent.taskQueue || []).find(t => t.id === taskId);
      if (!task || !task.result) return;

      const formatted = task.result
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');

      showModal(` ${agent.emoji} ${agent.name}  ${task.title}`, `
        <div style="max-height:500px;overflow-y:auto;">
          <div style="display:flex;gap:16px;margin-bottom:12px;font-size:12px;color:var(--text-secondary);">
            <span> : ${task.executionTime || ''}</span>
            <span> : ${task.completedAt ? new Date(task.completedAt).toLocaleString('zh-TW') : ''}</span>
          </div>
          <div style="padding:12px;background:var(--bg-secondary);border-radius:8px;font-size:13px;line-height:1.7;">
            ${formatted}
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="copyTaskResult('${agentId}','${taskId}')"> </button>
          <button class="btn btn-secondary" onclick="rerunAgentTask('${agentId}','${taskId}')"> </button>
        </div>
      `, { width: '600px' });
    }

    function copyTaskResult(agentId, taskId) {
      const agent = state.agents.find(a => a.id === agentId);
      const task = agent?.taskQueue?.find(t => t.id === taskId);
      if (task?.result) {
        navigator.clipboard.writeText(task.result).then(() => showToast(''));
      }
    }

    function rerunAgentTask(agentId, taskId) {
      const agent = state.agents.find(a => a.id === agentId);
      const task = agent?.taskQueue?.find(t => t.id === taskId);
      if (task) {
        task.status = 'pending';
        task.result = '';
        task.error = '';
        closeModal();
        saveState();
        executeAgentTask(agentId, taskId);
      }
    }

    /**
     * Execute ALL pending tasks for an agent sequentially
     */
    async function executeAllAgentTasks(agentId) {
      const agent = state.agents.find(a => a.id === agentId);
      if (!agent) return;
      const pending = (agent.taskQueue || []).filter(t => t.status === 'pending' || t.status === 'in_progress');
      if (pending.length === 0) { showToast('', 'info'); return; }
      showToast(` ${pending.length} ...`, 'info');
      for (const task of pending) {
        await executeAgentTask(agentId, task.id);
      }
      showToast(`${agent.name} `, 'success');
    }

    // ==================== SUPABASE REAL-TIME SYNC ====================
    let realtimeChannel = null;

    function initRealtimeSync() {
      if (!sb) return;
      try {
        realtimeChannel = sb.channel('dto-realtime')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, (payload) => {
            console.log('[Realtime] projects change:', payload.eventType);
            handleRealtimeProjectChange(payload);
          })
          .on('postgres_changes', { event: '*', schema: 'public', table: 'agents' }, (payload) => {
            console.log('[Realtime] agents change:', payload.eventType);
            handleRealtimeAgentChange(payload);
          })
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'activity_logs' }, (payload) => {
            console.log('[Realtime] new activity_log');
            handleRealtimeActivityInsert(payload);
          })
          .subscribe((status) => {
            console.log('[Realtime] subscription status:', status);
          });
      } catch (e) {
        console.warn('[Realtime] failed to init:', e.message);
      }
    }

    function handleRealtimeProjectChange(payload) {
      if (payload.eventType === 'UPDATE' && payload.new) {
        const idx = state.projects.findIndex(p => p.id === payload.new.id);
        if (idx !== -1) {
          // Only update if data is newer (avoid echo of our own writes)
          const incoming = payload.new;
          const local = state.projects[idx];
          if (incoming.updated_at && local.updatedAt && incoming.updated_at > local.updatedAt) {
            state.projects[idx] = dbProjectToFE(incoming);
            localStorage.setItem('dto_state', JSON.stringify(state));
            pushNotification('', ` ${incoming.code || incoming.name} `, 'info');
            handleRoute(window.location.hash);
          }
        }
      }
    }

    function handleRealtimeAgentChange(payload) {
      if (payload.eventType === 'UPDATE' && payload.new) {
        const idx = state.agents.findIndex(a => a.id === payload.new.id);
        if (idx !== -1) {
          const incoming = payload.new;
          const local = state.agents[idx];
          if (incoming.updated_at && local.updatedAt && incoming.updated_at > local.updatedAt) {
            state.agents[idx] = dbAgentToFE(incoming);
            localStorage.setItem('dto_state', JSON.stringify(state));
            handleRoute(window.location.hash);
          }
        }
      }
    }

    function handleRealtimeActivityInsert(payload) {
      if (payload.new) {
        const log = payload.new;
        const detail = log.details?.message || log.action || '';
        // Only notify if not from our current session (avoid echo)
        const age = Date.now() - new Date(log.created_at).getTime();
        if (age > 3000) { // older than 3s means from another tab/user
          pushNotification('', `${log.entity_type}: ${log.action}  ${detail.substring(0, 50)}`, 'info');
        }
      }
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async () => {
      const cloudOk = await loadFromCloud();
      if (!cloudOk) loadState();
      initTheme();
      if (state.sidebarCollapsed) {
        document.body.classList.add('sidebar-collapsed');
      }
      handleRoute();
      // Start real-time sync
      initRealtimeSync();
      // Close notif panel on outside click
      document.addEventListener('click', (e) => {
        const panel = document.getElementById('notif-panel');
        const bell = document.getElementById('notif-bell');
        if (panel && panel.classList.contains('visible') && !panel.contains(e.target) && !bell.contains(e.target)) {
          panel.classList.remove('visible');
        }
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="DTO Dashboard - Digital Transformation Office Management System">
  <title>DTO Dashboard</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ============================= */
    /* CSS VARIABLES & THEMING SYSTEM */
    /* ============================= */

    :root,
    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #eff6ff;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --sidebar-bg: #1e293b;
      --sidebar-text: #cbd5e1;
      --sidebar-active: #3b82f6;
      --sidebar-hover: #334155;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
      --accent: #60a5fa;
      --accent-hover: #3b82f6;
      --accent-light: #1e3a5f;
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #60a5fa;
      --sidebar-hover: #1e293b;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    /* ============================= */
    /* GLOBAL STYLES */
    /* ============================= */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ============================= */
    /* LAYOUT STRUCTURE */
    /* ============================= */

    #app {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 240px;
      height: 100vh;
      background-color: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: width 0.3s ease;
      overflow-y: auto;
      overflow-x: hidden;
    }

    #sidebar::-webkit-scrollbar {
      width: 6px;
    }

    #sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    #sidebar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    #sidebar::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    body.sidebar-collapsed #sidebar {
      width: 60px;
    }

    #main-content {
      margin-left: 240px;
      width: calc(100% - 240px);
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }

    body.sidebar-collapsed #main-content {
      margin-left: 60px;
      width: calc(100% - 60px);
    }

    #topbar {
      position: sticky;
      top: 0;
      background-color: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      z-index: 50;
      box-shadow: var(--card-shadow);
    }

    #view-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    #view-container::-webkit-scrollbar {
      width: 8px;
    }

    #view-container::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    #view-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    #view-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ============================= */
    /* SIDEBAR STYLES */
    /* ============================= */

    .sidebar-logo {
      padding: 20px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .sidebar-logo-text {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .sidebar-logo-subtitle {
      font-size: 11px;
      color: var(--sidebar-text);
      opacity: 0.8;
      white-space: nowrap;
    }

    body.sidebar-collapsed .sidebar-logo-subtitle,
    body.sidebar-collapsed .sidebar-logo-text {
      display: none;
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--sidebar-text);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
    }

    .nav-item:hover {
      background-color: var(--sidebar-hover);
      color: #ffffff;
    }

    .nav-item.active {
      background-color: var(--sidebar-active);
      color: #ffffff;
      font-weight: 600;
    }

    .nav-icon {
      font-size: 18px;
      min-width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .nav-label {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.sidebar-collapsed .nav-label {
      display: none;
    }

    .sidebar-footer {
      padding: 16px 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .collapse-btn {
      width: 100%;
      padding: 12px 16px;
      background-color: var(--sidebar-hover);
      color: var(--sidebar-text);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .collapse-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }

    /* ============================= */
    /* TOPBAR STYLES */
    /* ============================= */

    #breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .breadcrumb-separator {
      color: var(--border-color);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 24px;
      flex: 1;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    #global-search {
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      width: 250px;
      transition: all 0.2s ease;
      position: relative;
    }

    #global-search:focus {
      outline: none;
      border-color: var(--accent);
      background-color: var(--bg-primary);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .search-icon {
      position: absolute;
      left: 10px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .theme-toggle-btn,
    .user-menu-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 8px;
      border-radius: 6px;
    }

    .theme-toggle-btn:hover,
    .user-menu-btn:hover {
      background-color: var(--bg-secondary);
      color: var(--accent);
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--accent);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .avatar:hover {
      box-shadow: 0 0 0 2px var(--accent);
    }

    /* ============================= */
    /* CARD STYLES */
    /* ============================= */

    .card {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
    }

    .card:hover {
      box-shadow: var(--card-shadow-hover);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* ============================= */
    /* BUTTON STYLES */
    /* ============================= */

    .btn {
      padding: 10px 16px;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background-color: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }

    .btn-primary:hover:not(:disabled) {
      background-color: var(--accent-hover);
      border-color: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .btn-danger {
      background-color: var(--danger);
      color: #ffffff;
      border-color: var(--danger);
    }

    .btn-danger:hover:not(:disabled) {
      background-color: #dc2626;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--text-primary);
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s ease;
    }

    .btn-close:hover {
      color: var(--accent);
    }

    /* ============================= */
    /* BADGE STYLES */
    /* ============================= */

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    .badge-success {
      background-color: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .badge-warning {
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .badge-danger {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .badge-info {
      background-color: rgba(6, 182, 212, 0.1);
      color: var(--info);
    }

    /* ============================= */
    /* FORM STYLES */
    /* ============================= */

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* ============================= */
    /* TABLE STYLES */
    /* ============================= */

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table thead {
      background-color: var(--bg-secondary);
      border-bottom: 2px solid var(--border-color);
    }

    .data-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table tbody tr:hover {
      background-color: var(--bg-secondary);
    }

    /* ============================= */
    /* TABS STYLES */
    /* ============================= */

    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 12px 16px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ============================= */
    /* KPI CARD STYLES */
    /* ============================= */

    .kpi-card {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .kpi-icon {
      font-size: 28px;
    }

    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .kpi-trend.up {
      color: var(--success);
    }

    .kpi-trend.down {
      color: var(--danger);
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .kpi-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* ============================= */
    /* PROGRESS BAR STYLES */
    /* ============================= */

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* ============================= */
    /* CHART CONTAINER */
    /* ============================= */

    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin: 20px 0;
    }

    /* ============================= */
    /* GRID LAYOUTS */
    /* ============================= */

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    /* ============================= */
    /* EDIT PANEL & OVERLAY */
    /* ============================= */

    .edit-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 180;
      transition: opacity 0.3s ease;
    }

    .edit-overlay.hidden {
      display: none;
      opacity: 0;
    }

    .edit-panel {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: 400px;
      background-color: var(--bg-primary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      z-index: 200;
      box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
      animation: slideInRight 0.3s ease;
    }

    .edit-panel.hidden {
      display: none;
      animation: slideOutRight 0.3s ease;
    }

    .edit-panel-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .edit-panel-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .edit-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .edit-panel-body::-webkit-scrollbar {
      width: 6px;
    }

    .edit-panel-body::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .edit-panel-body::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .edit-panel-footer {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* ============================= */
    /* MODAL STYLES */
    /* ============================= */

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 250;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal-content {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
    }

    /* ============================= */
    /* TOAST STYLES */
    /* ============================= */

    #toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast-container {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      min-width: 300px;
      box-shadow: var(--card-shadow-hover);
      animation: slideUpAndFade 0.3s ease;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    .toast.info {
      border-left: 4px solid var(--info);
    }

    /* ============================= */
    /* AGENT CARD */
    /* ============================= */

    .agent-card {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      gap: 16px;
      align-items: center;
      transition: all 0.3s ease;
    }

    .agent-card:hover {
      box-shadow: var(--card-shadow-hover);
    }

    .agent-avatar {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      background-color: var(--accent);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .agent-info {
      flex: 1;
    }

    .agent-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .agent-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.active {
      background-color: var(--success);
    }

    .status-dot.idle {
      background-color: var(--warning);
    }

    .status-dot.paused {
      background-color: var(--text-muted);
    }

    .status-dot.error {
      background-color: var(--danger);
    }

    /* ============================= */
    /* WORKFLOW STEP */
    /* ============================= */

    .workflow-step {
      background-color: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      min-width: 150px;
      transition: all 0.3s ease;
    }

    .workflow-step:hover {
      border-color: var(--accent);
      box-shadow: var(--card-shadow-hover);
    }

    .workflow-step.active {
      border-color: var(--accent);
      background-color: var(--accent-light);
    }

    .workflow-step.completed {
      border-color: var(--success);
      background-color: rgba(34, 197, 94, 0.05);
    }

    .workflow-step-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .workflow-step-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ============================= */
    /* ACTIVITY ITEM */
    /* ============================= */

    .activity-item {
      display: flex;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      font-size: 20px;
      min-width: 32px;
      text-align: center;
      flex-shrink: 0;
    }

    .activity-content {
      flex: 1;
    }

    .activity-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ============================= */
    /* GANTT CHART */
    /* ============================= */

    .gantt-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }

    .gantt-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .gantt-label {
      min-width: 150px;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .gantt-track {
      flex: 1;
      height: 32px;
      background-color: var(--bg-secondary);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .gantt-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 4px;
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #ffffff;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .gantt-bar:hover {
      filter: brightness(1.1);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    /* ============================= */
    /* ANIMATIONS */
    /* ============================= */

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUpAndFade {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* ============================= */
    /* UTILITY CLASSES */
    /* ============================= */

    .hidden {
      display: none !important;
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .gap-4 {
      gap: 16px;
    }

    .gap-2 {
      gap: 8px;
    }

    .mb-4 {
      margin-bottom: 16px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .text-center {
      text-align: center;
    }

    /* ============================= */
    /* RESPONSIVE DESIGN */
    /* ============================= */

    @media (max-width: 768px) {
      #sidebar {
        width: 60px;
        transform: translateX(-100%);
      }

      body.sidebar-open #sidebar {
        transform: translateX(0);
      }

      #main-content {
        margin-left: 0;
        width: 100%;
      }

      .topbar-left {
        gap: 12px;
      }

      #global-search {
        width: auto;
        min-width: 200px;
      }

      .stat-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }

      .card-grid {
        grid-template-columns: 1fr;
      }

      .edit-panel {
        width: 100%;
        max-width: 100%;
      }

      .modal-content {
        width: 95%;
      }

      #toast-container {
        left: 12px;
        right: 12px;
        bottom: 12px;
      }

      .toast-container {
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      #topbar {
        padding: 12px 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      #breadcrumb {
        order: 3;
        width: 100%;
        font-size: 12px;
      }

      #global-search {
        width: 100%;
        min-width: unset;
      }

      .topbar-right {
        gap: 12px;
      }

      .stat-grid {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 8px 12px;
      }
    }
  
    /* Additional view elements and components */
    .workflow-card {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }

    .workflow-card:hover {
      box-shadow: var(--card-shadow-hover);
    }

    .workflow-step {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background-color: var(--bg-tertiary);
      border-radius: 6px;
    }

    .workflow-step.active {
      background-color: var(--accent-light);
      border-left: 4px solid var(--accent);
    }

    .agent-card {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .agent-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--card-shadow-hover);
    }

    .agent-status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }

    .agent-status-badge.active {
      background-color: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .agent-status-badge.idle {
      background-color: rgba(148, 163, 184, 0.2);
      color: var(--text-secondary);
    }

    .activity-timeline {
      position: relative;
      padding-left: 30px;
    }

    .activity-timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: var(--border-color);
    }

    .activity-item {
      position: relative;
      margin-bottom: 20px;
      padding-bottom: 20px;
    }

    .activity-item::before {
      content: '';
      position: absolute;
      left: -38px;
      top: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--accent);
      border: 3px solid var(--bg-primary);
    }

    .gantt-chart {
      width: 100%;
      overflow-x: auto;
      margin-top: 20px;
    }

    .gantt-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .gantt-label {
      width: 200px;
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .gantt-bar {
      flex-grow: 1;
      position: relative;
      height: 30px;
      background-color: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .gantt-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.pending {
      background-color: var(--warning);
    }

    .status-indicator.in-progress {
      background-color: var(--info);
    }

    .status-indicator.completed {
      background-color: var(--success);
    }

    .status-indicator.blocked {
      background-color: var(--danger);
    }

    /* Tab system */
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 20px;
      gap: 0;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      color: var(--text-secondary);
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Multi-select and filtering */
    .filter-group {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-tag {
      padding: 6px 12px;
      background-color: var(--accent-light);
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .filter-tag:hover {
      background-color: var(--accent);
      color: white;
    }

    .filter-tag.active {
      background-color: var(--accent);
      color: white;
    }

    /* Data table enhancements */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .data-table thead {
      background-color: var(--bg-tertiary);
    }

    .data-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table tr:hover {
      background-color: var(--bg-secondary);
    }

    /* Loading and empty states */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .loading-spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Panel and drawer styling */
    .edit-panel {
      position: fixed;
      right: -400px;
      top: 0;
      width: 400px;
      height: 100vh;
      background-color: var(--bg-primary);
      border-left: 1px solid var(--border-color);
      box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .edit-panel.open {
      right: 0;
    }

    /* Chart container */
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-bottom: 20px;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

  </style>
</head>

<body>
  <div id="app">
    <!-- SIDEBAR -->
    <aside id="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-text">DTO</div>
        <div class="sidebar-logo-subtitle">Digital Transformation Office</div>
      </div>

      <nav class="sidebar-nav">
        <a href="#/" class="nav-item active" data-route="overview">
          <span class="nav-icon">ğŸ“Š</span>
          <span class="nav-label">ç¸½è¦½</span>
        </a>
        <a href="#/projects" class="nav-item" data-route="projects">
          <span class="nav-icon">ğŸ“‹</span>
          <span class="nav-label">é …ç›®</span>
        </a>
        <a href="#/timeline" class="nav-item" data-route="timeline">
          <span class="nav-icon">ğŸ“…</span>
          <span class="nav-label">æ™‚ç¨‹</span>
        </a>
        <a href="#/agents" class="nav-item" data-route="agents">
          <span class="nav-icon">ğŸ¤–</span>
          <span class="nav-label">Agent</span>
        </a>
        <a href="#/team" class="nav-item" data-route="team">
          <span class="nav-icon">ğŸ‘¥</span>
          <span class="nav-label">åœ˜éšŠ</span>
        </a>
        <a href="#/actions" class="nav-item" data-route="actions">
          <span class="nav-icon">ğŸ“</span>
          <span class="nav-label">Actions</span>
        </a>
        <a href="#/settings" class="nav-item" data-route="settings">
          <span class="nav-icon">âš™ï¸</span>
          <span class="nav-label">è¨­å®š</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <button class="collapse-btn" title="Toggle Sidebar">â˜°</button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content">
      <!-- TOPBAR -->
      <header id="topbar">
        <div class="topbar-left">
          <div id="breadcrumb">
            <span class="breadcrumb-item">Dashboard</span>
          </div>
          <div style="position: relative; flex: 1; max-width: 300px;">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="global-search" placeholder="æœå°‹..." oninput="handleSearch(this.value)" />
          </div>
        </div>

        <div class="topbar-right">
          <button id="themeToggle" onclick="setTheme(state.theme === 'light' ? 'dark' : 'light')" class="theme-toggle-btn" title="Toggle Theme">ğŸŒ™</button>
          <button class="user-menu-btn" title="User Menu">â‹®</button>
          <div class="avatar">ç®¡</div>
        </div>
      </header>

      <!-- VIEW CONTAINER -->
      <div id="view-container">
        <!-- Dynamic content will be rendered here -->
      </div>
    </main>
  </div>

  <!-- EDIT PANEL OVERLAY -->
  <div id="edit-overlay" class="edit-overlay hidden"></div>

  <!-- EDIT PANEL -->
  <div id="edit-panel" class="edit-panel hidden">
    <div class="edit-panel-header">
      <h3 id="edit-panel-title">Edit Action Item</h3>
      <button class="btn-close">&times;</button>
    </div>
    <div id="edit-panel-body" class="edit-panel-body">
      <!-- Dynamic form content will be rendered here -->
    </div>
    <div class="edit-panel-footer">
      <button class="btn btn-secondary">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveEdit()">å„²å­˜</button>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toast-container"></div>

  <!-- MODAL OVERLAY -->
  <div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal()">
    <div id="modal-content" class="modal-content">
      <!-- Dynamic modal content will be rendered here -->
    </div>
  </div>
</body>


  <script>
// ==================== DATA LAYER ====================
const APP_VERSION = '3.0.0';
const STORAGE_KEY = 'dto_dashboard_v3';

// LLM Configuration (reserved for future AI integration)
let llmConfig = {
  provider: 'none', // 'openai' | 'anthropic' | 'local' | 'none'
  apiEndpoint: '',
  apiKey: '',
  modelName: '',
  localModelPath: '',
  maxTokens: 4096,
  temperature: 0.7
};

const defaultProjects = [
  {
    id: 1, name: "æ•¸ä½æ±ºç­–å¹³å°", code: "P1",
    description: "è³‡è¨Šç§‘æŠ€å°å…¥æ™ºæ…§æ±ºç­–å¹³å°",
    owner: "è³‡è¨Šè™•", lead: "ITä¸»ç®¡",
    startDate: "2026-01", endDate: "2026-12",
    status: "on_track", progress: 35,
    actionItems: [
      { id: 1, name: "éœ€æ±‚èª¿æŸ¥", breakdown: "ç¢ºèªå„éƒ¨é–€æ±ºç­–éœ€æ±‚åŠç—›é»", ownerUnit: "è³‡è¨Šè™•", owner: "IT-PM", status: "completed", priority: "high", startMonth: 1, endMonth: 2 },
      { id: 2, name: "å¹³å°è©•ä¼°", breakdown: "è©•ä¼° BI/AI å¹³å°é¸é …(Power BI, Tableau, Superset)", ownerUnit: "è³‡è¨Šè™•", owner: "ITæ¶æ§‹å¸«", status: "in_progress", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 3, name: "POC é©—è­‰", breakdown: "é¸å®šå¹³å°é€²è¡Œæ¦‚å¿µé©—è­‰", ownerUnit: "è³‡è¨Šè™•", owner: "IT-PM", status: "pending", priority: "high", startMonth: 3, endMonth: 4 },
      { id: 4, name: "è³‡æ–™æ•´åˆ", breakdown: "ä¸²æ¥ ERP/MES/HR ç³»çµ±è³‡æ–™", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡æ–™å·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 4, endMonth: 6 },
      { id: 5, name: "Dashboard é–‹ç™¼", breakdown: "é–‹ç™¼ç®¡ç†å±¤æ±ºç­–å„€è¡¨æ¿", ownerUnit: "è³‡è¨Šè™•", owner: "å‰ç«¯å·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 5, endMonth: 8 },
      { id: 6, name: "ä½¿ç”¨è€…åŸ¹è¨“", breakdown: "åŸ¹è¨“å„éƒ¨é–€ä½¿ç”¨è€…æ“ä½œå¹³å°", ownerUnit: "è³‡è¨Šè™•", owner: "IT-PM", status: "pending", priority: "low", startMonth: 8, endMonth: 9 },
      { id: 7, name: "æ­£å¼ä¸Šç·š", breakdown: "å¹³å°æ­£å¼ä¸Šç·šåŠç›£æ§", ownerUnit: "è³‡è¨Šè™•", owner: "ITä¸»ç®¡", status: "pending", priority: "high", startMonth: 9, endMonth: 10 },
      { id: 49, name: "AI åŠ©æ‰‹æ•´åˆ", breakdown: "æ•´åˆ AI åŠ©æ‰‹è‡³æ±ºç­–å¹³å°", ownerUnit: "è³‡è¨Šè™•", owner: "AIå·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 7, endMonth: 10 }
    ]
  },
  {
    id: 2, name: "æµç¨‹è‡ªå‹•åŒ–", code: "P2",
    description: "RPAå°å…¥æ ¸å¿ƒæ¥­å‹™æµç¨‹è‡ªå‹•åŒ–",
    owner: "è£½é€ è™•", lead: "æµç¨‹æ”¹å–„ç¶“ç†",
    startDate: "2026-01", endDate: "2026-12",
    status: "on_track", progress: 25,
    actionItems: [
      { id: 8, name: "æµç¨‹ç›¤é»", breakdown: "ç›¤é»å¯è‡ªå‹•åŒ–çš„é‡è¤‡æ€§æµç¨‹", ownerUnit: "è£½é€ è™•", owner: "IEå·¥ç¨‹å¸«", status: "completed", priority: "high", startMonth: 1, endMonth: 2 },
      { id: 9, name: "RPA å·¥å…·é¸å‹", breakdown: "è©•ä¼° UiPath/Power Automate/è‡ªå»ºæ–¹æ¡ˆ", ownerUnit: "è³‡è¨Šè™•", owner: "ITæ¶æ§‹å¸«", status: "in_progress", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 10, name: "Pilot å°å…¥", breakdown: "é¸å®š 3 å€‹æµç¨‹é€²è¡Œ RPA è©¦å°å…¥", ownerUnit: "è£½é€ è™•", owner: "æµç¨‹æ”¹å–„ç¶“ç†", status: "pending", priority: "high", startMonth: 3, endMonth: 5 },
      { id: 11, name: "æ•ˆç›Šè©•ä¼°", breakdown: "è¨ˆç®— ROI åŠæ™‚é–“ç¯€çœæ•ˆç›Š", ownerUnit: "è²¡å‹™è™•", owner: "è²¡å‹™åˆ†æå¸«", status: "pending", priority: "medium", startMonth: 5, endMonth: 6 },
      { id: 12, name: "è¦æ¨¡åŒ–éƒ¨ç½²", breakdown: "æ“´å±•è‡³ 10+ å€‹æ¥­å‹™æµç¨‹", ownerUnit: "è³‡è¨Šè™•", owner: "RPAé–‹ç™¼è€…", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 13, name: "ç¶­é‹æ©Ÿåˆ¶å»ºç«‹", breakdown: "å»ºç«‹ RPA ç›£æ§åŠä¾‹å¤–è™•ç†æ©Ÿåˆ¶", ownerUnit: "è³‡è¨Šè™•", owner: "ITç¶­é‹", status: "pending", priority: "medium", startMonth: 9, endMonth: 11 },
      { id: 14, name: "æˆæœå ±å‘Š", breakdown: "å½™æ•´å¹´åº¦è‡ªå‹•åŒ–æˆæœå ±å‘Š", ownerUnit: "è£½é€ è™•", owner: "æµç¨‹æ”¹å–„ç¶“ç†", status: "pending", priority: "low", startMonth: 11, endMonth: 12 },
      { id: 50, name: "æµç¨‹æŒ–æ˜", breakdown: "å°å…¥ Process Mining å·¥å…·", ownerUnit: "è£½é€ è™•", owner: "IEå·¥ç¨‹å¸«", status: "pending", priority: "low", startMonth: 8, endMonth: 11 }
    ]
  },
  {
    id: 3, name: "API/ETLå»ºç½®", code: "P3",
    description: "å»ºç«‹ä¼æ¥­ç´šè³‡æ–™æ•´åˆæ¶æ§‹",
    owner: "è³‡è¨Šè™•", lead: "è³‡æ–™æ¶æ§‹å¸«",
    startDate: "2026-02", endDate: "2026-11",
    status: "at_risk", progress: 15,
    actionItems: [
      { id: 15, name: "ç¾æ³æ¶æ§‹è©•ä¼°", breakdown: "è©•ä¼°ç¾æœ‰ç³»çµ±é–“è³‡æ–™æµåŠç“¶é ¸", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡æ–™æ¶æ§‹å¸«", status: "completed", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 16, name: "API Gateway é¸å‹", breakdown: "è©•ä¼° Kong/AWS API GW/è‡ªå»ºæ–¹æ¡ˆ", ownerUnit: "è³‡è¨Šè™•", owner: "å¾Œç«¯å·¥ç¨‹å¸«", status: "in_progress", priority: "high", startMonth: 3, endMonth: 4 },
      { id: 17, name: "ETL Pipeline å»ºç½®", breakdown: "å»ºç«‹ Airflow/dbt è³‡æ–™ç®¡ç·š", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡æ–™å·¥ç¨‹å¸«", status: "pending", priority: "high", startMonth: 4, endMonth: 7 },
      { id: 18, name: "API æ¨™æº–åˆ¶å®š", breakdown: "åˆ¶å®š RESTful API è¨­è¨ˆè¦ç¯„", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡æ–™æ¶æ§‹å¸«", status: "in_progress", priority: "medium", startMonth: 3, endMonth: 4 },
      { id: 19, name: "æ ¸å¿ƒ API é–‹ç™¼", breakdown: "é–‹ç™¼ ERP/MES/HR æ ¸å¿ƒ API", ownerUnit: "è³‡è¨Šè™•", owner: "å¾Œç«¯å·¥ç¨‹å¸«", status: "pending", priority: "high", startMonth: 4, endMonth: 8 },
      { id: 20, name: "è³‡æ–™å“è³ªç›£æ§", breakdown: "å»ºç«‹è³‡æ–™å“è³ªå„€è¡¨æ¿åŠå‘Šè­¦", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡æ–™å·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 7, endMonth: 9 },
      { id: 21, name: "æ–‡ä»¶åŠæ²»ç†", breakdown: "API æ–‡ä»¶åŒ–åŠè³‡æ–™æ²»ç†è¦ç¯„", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡æ–™æ¶æ§‹å¸«", status: "pending", priority: "medium", startMonth: 9, endMonth: 11 },
      { id: 51, name: "Data Catalog", breakdown: "å»ºç«‹ä¼æ¥­è³‡æ–™ç›®éŒ„", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡æ–™æ¶æ§‹å¸«", status: "pending", priority: "medium", startMonth: 8, endMonth: 10 }
    ]
  },
  {
    id: 4, name: "è³‡å®‰å¼·åŒ–", code: "P4",
    description: "å…¨é¢æå‡è³‡è¨Šå®‰å…¨é˜²è­·èƒ½åŠ›",
    owner: "è³‡è¨Šè™•", lead: "è³‡å®‰ä¸»ç®¡",
    startDate: "2026-01", endDate: "2026-12",
    status: "on_track", progress: 30,
    actionItems: [
      { id: 22, name: "è³‡å®‰ç¾æ³è©•ä¼°", breakdown: "åŸ·è¡Œå…¨é¢è³‡å®‰é¢¨éšªè©•ä¼°", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡å®‰ä¸»ç®¡", status: "completed", priority: "high", startMonth: 1, endMonth: 2 },
      { id: 23, name: "Zero Trust æ¶æ§‹", breakdown: "è¨­è¨ˆé›¶ä¿¡ä»»ç¶²è·¯æ¶æ§‹", ownerUnit: "è³‡è¨Šè™•", owner: "ç¶²è·¯å·¥ç¨‹å¸«", status: "in_progress", priority: "high", startMonth: 2, endMonth: 5 },
      { id: 24, name: "SIEM å»ºç½®", breakdown: "éƒ¨ç½²å®‰å…¨äº‹ä»¶ç®¡ç†å¹³å°", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡å®‰å·¥ç¨‹å¸«", status: "pending", priority: "high", startMonth: 3, endMonth: 6 },
      { id: 25, name: "å“¡å·¥è³‡å®‰è¨“ç·´", breakdown: "å…¨å“¡è³‡å®‰æ„è­˜åŸ¹è¨“(å«é‡£é­šæ¼”ç·´)", ownerUnit: "äººè³‡è™•", owner: "åŸ¹è¨“å°ˆå“¡", status: "in_progress", priority: "medium", startMonth: 2, endMonth: 4 },
      { id: 26, name: "ç«¯é»é˜²è­·å‡ç´š", breakdown: "å‡ç´š EDR/MDR ç«¯é»é˜²è­·æ–¹æ¡ˆ", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡å®‰å·¥ç¨‹å¸«", status: "pending", priority: "high", startMonth: 5, endMonth: 7 },
      { id: 27, name: "æ»²é€æ¸¬è©¦", breakdown: "å§”å¤–åŸ·è¡Œæ»²é€æ¸¬è©¦åŠä¿®è£œ", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡å®‰ä¸»ç®¡", status: "pending", priority: "medium", startMonth: 7, endMonth: 9 },
      { id: 28, name: "ISO 27001 æº–å‚™", breakdown: "æº–å‚™ ISO 27001 èªè­‰æ–‡ä»¶", ownerUnit: "è³‡è¨Šè™•", owner: "è³‡å®‰ä¸»ç®¡", status: "pending", priority: "medium", startMonth: 9, endMonth: 12 },
      { id: 29, name: "ç½é›£å¾©åŸæ¼”ç·´", breakdown: "å»ºç«‹åŠæ¼”ç·´ DR/BCP è¨ˆç•«", ownerUnit: "è³‡è¨Šè™•", owner: "ITç¶­é‹", status: "pending", priority: "high", startMonth: 6, endMonth: 8 },
      { id: 53, name: "ä¾›æ‡‰éˆè³‡å®‰", breakdown: "å»ºç«‹ä¾›æ‡‰éˆè³‡å®‰è©•ä¼°æ©Ÿåˆ¶", ownerUnit: "æ¡è³¼è™•", owner: "è³‡å®‰ä¸»ç®¡", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 }
    ]
  },
  {
    id: 5, name: "äººæ‰æ•¸ä½åŒ–", code: "P5",
    description: "å»ºç«‹æ•¸ä½äººæ‰åŸ¹è‚²èˆ‡ç™¼å±•é«”ç³»",
    owner: "äººè³‡è™•", lead: "HRä¸»ç®¡",
    startDate: "2026-02", endDate: "2026-12",
    status: "on_track", progress: 20,
    actionItems: [
      { id: 30, name: "æ•¸ä½èƒ½åŠ›ç›¤é»", breakdown: "è©•ä¼°å…¨å“¡æ•¸ä½æŠ€èƒ½ç¾æ³", ownerUnit: "äººè³‡è™•", owner: "åŸ¹è¨“å°ˆå“¡", status: "completed", priority: "high", startMonth: 2, endMonth: 3 },
      { id: 31, name: "å­¸ç¿’å¹³å°å»ºç½®", breakdown: "å°å…¥ LMS æ•¸ä½å­¸ç¿’å¹³å°", ownerUnit: "äººè³‡è™•", owner: "HR-IT", status: "in_progress", priority: "high", startMonth: 3, endMonth: 5 },
      { id: 32, name: "åŸ¹è¨“èª²ç¨‹é–‹ç™¼", breakdown: "é–‹ç™¼ AI/Data/RPA åŸ¹è¨“èª²ç¨‹", ownerUnit: "äººè³‡è™•", owner: "åŸ¹è¨“å°ˆå“¡", status: "pending", priority: "medium", startMonth: 4, endMonth: 7 },
      { id: 33, name: "æ•¸ä½èªè­‰åˆ¶åº¦", breakdown: "å»ºç«‹å…§éƒ¨æ•¸ä½æŠ€èƒ½èªè­‰é«”ç³»", ownerUnit: "äººè³‡è™•", owner: "HRä¸»ç®¡", status: "pending", priority: "medium", startMonth: 5, endMonth: 8 },
      { id: 34, name: "ç¨®å­æ•™å¸«åŸ¹é¤Š", breakdown: "åŸ¹é¤Šå„éƒ¨é–€æ•¸ä½ç¨®å­æ•™å¸«", ownerUnit: "äººè³‡è™•", owner: "åŸ¹è¨“å°ˆå“¡", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 35, name: "æˆæ•ˆè¿½è¹¤", breakdown: "è¿½è¹¤å­¸ç¿’æˆæ•ˆåŠæ•¸ä½æˆç†Ÿåº¦", ownerUnit: "äººè³‡è™•", owner: "HRæ•¸æ“šåˆ†æ", status: "pending", priority: "low", startMonth: 8, endMonth: 12 },
      { id: 52, name: "AI ç´ é¤Šèª²ç¨‹", breakdown: "é–‹ç™¼ AI æ‡‰ç”¨ç´ é¤Šå¿…ä¿®èª²ç¨‹", ownerUnit: "äººè³‡è™•", owner: "åŸ¹è¨“å°ˆå“¡", status: "pending", priority: "high", startMonth: 4, endMonth: 6 }
    ]
  },
  {
    id: 6, name: "å®¢æˆ¶é«”é©—å„ªåŒ–", code: "P6",
    description: "æ•¸ä½åŒ–å®¢æˆ¶æœå‹™èˆ‡é«”é©—æµç¨‹",
    owner: "æ¥­å‹™è™•", lead: "å®¢æœç¶“ç†",
    startDate: "2026-03", endDate: "2026-12",
    status: "delayed", progress: 10,
    actionItems: [
      { id: 36, name: "å®¢æˆ¶æ—…ç¨‹åœ°åœ–", breakdown: "ç¹ªè£½ç«¯åˆ°ç«¯å®¢æˆ¶æ—…ç¨‹åœ°åœ–", ownerUnit: "æ¥­å‹™è™•", owner: "å®¢æœç¶“ç†", status: "in_progress", priority: "high", startMonth: 3, endMonth: 4 },
      { id: 37, name: "CRM ç³»çµ±å°å…¥", breakdown: "è©•ä¼°åŠå°å…¥ CRM ç³»çµ±", ownerUnit: "æ¥­å‹™è™•", owner: "æ¥­å‹™IT", status: "pending", priority: "high", startMonth: 4, endMonth: 7 },
      { id: 38, name: "å®¢æœ Chatbot", breakdown: "é–‹ç™¼ AI å®¢æœèŠå¤©æ©Ÿå™¨äºº", ownerUnit: "è³‡è¨Šè™•", owner: "AIå·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 5, endMonth: 8 },
      { id: 39, name: "è‡ªåŠ©æœå‹™å…¥å£", breakdown: "å»ºç«‹å®¢æˆ¶è‡ªåŠ©æœå‹™ç¶²ç«™", ownerUnit: "è³‡è¨Šè™•", owner: "å‰ç«¯å·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 40, name: "NPS/CSAT ç³»çµ±", breakdown: "å»ºç«‹å®¢æˆ¶æ»¿æ„åº¦ç›£æ¸¬æ©Ÿåˆ¶", ownerUnit: "æ¥­å‹™è™•", owner: "å®¢æœç¶“ç†", status: "pending", priority: "low", startMonth: 8, endMonth: 10 },
      { id: 41, name: "æ•¸æ“šé©…å‹•å„ªåŒ–", breakdown: "å»ºç«‹å®¢æˆ¶è¡Œç‚ºåˆ†æåŠå„ªåŒ–å¾ªç’°", ownerUnit: "æ¥­å‹™è™•", owner: "æ¥­å‹™åˆ†æå¸«", status: "pending", priority: "medium", startMonth: 10, endMonth: 12 }
    ]
  },
  {
    id: 7, name: "æ™ºæ…§è£½é€ ", code: "P7",
    description: "æ¨å‹•è£½é€ ç¾å ´æ™ºæ…§åŒ–è½‰å‹",
    owner: "è£½é€ è™•", lead: "è£½é€ ç¶“ç†",
    startDate: "2026-03", endDate: "2026-12",
    status: "on_track", progress: 15,
    actionItems: [
      { id: 42, name: "IoT æ„Ÿæ¸¬å™¨éƒ¨ç½²", breakdown: "é—œéµç”¢ç·šéƒ¨ç½² IoT æ„Ÿæ¸¬å™¨", ownerUnit: "è£½é€ è™•", owner: "è¨­å‚™å·¥ç¨‹å¸«", status: "in_progress", priority: "high", startMonth: 3, endMonth: 5 },
      { id: 43, name: "æ•¸æ“šæ¡é›†å¹³å°", breakdown: "å»ºç«‹å³æ™‚æ•¸æ“šæ¡é›†å¹³å°", ownerUnit: "è³‡è¨Šè™•", owner: "IoTå·¥ç¨‹å¸«", status: "pending", priority: "high", startMonth: 4, endMonth: 6 },
      { id: 44, name: "é æ¸¬æ€§ç¶­è­·", breakdown: "é–‹ç™¼è¨­å‚™é æ¸¬æ€§ç¶­è­·æ¨¡å‹", ownerUnit: "è³‡è¨Šè™•", owner: "AIå·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 6, endMonth: 9 },
      { id: 45, name: "æ•¸ä½çœ‹æ¿", breakdown: "å»ºç«‹ç”¢ç·šå³æ™‚æ•¸ä½çœ‹æ¿", ownerUnit: "è£½é€ è™•", owner: "MESå·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 5, endMonth: 7 },
      { id: 46, name: "å“è³ªAIæª¢æ¸¬", breakdown: "å°å…¥ AI è¦–è¦ºå“è³ªæª¢æ¸¬", ownerUnit: "å“ä¿è™•", owner: "å“è³ªå·¥ç¨‹å¸«", status: "pending", priority: "medium", startMonth: 7, endMonth: 10 },
      { id: 47, name: "MES æ•´åˆ", breakdown: "MES ç³»çµ±èˆ‡ IoT å¹³å°æ•´åˆ", ownerUnit: "è³‡è¨Šè™•", owner: "MESå·¥ç¨‹å¸«", status: "pending", priority: "high", startMonth: 8, endMonth: 11 },
      { id: 48, name: "æ•¸ä½é›™èƒèƒ POC", breakdown: "é—œéµè£½ç¨‹æ•¸ä½é›™èƒèƒæ¦‚å¿µé©—è­‰", ownerUnit: "è£½é€ è™•", owner: "è£½é€ ç¶“ç†", status: "pending", priority: "low", startMonth: 10, endMonth: 12 }
    ]
  }
];

// ==================== AGENT DATA ====================
const defaultAgents = [
  {
    id: "agent-001", name: "Jarvis", emoji: "ğŸ¯",
    role: "Lead Orchestrator",
    description: "å”èª¿æ‰€æœ‰ä»£ç†äººï¼Œç”Ÿæˆæ¯æ—¥ç«™ç«‹æœƒè­°å ±å‘Š",
    status: "active", autonomy: "lead",
    assignedProjects: [1, 2, 3, 4, 5, 6, 7],
    schedule: { type: "daily", time: "08:00", timezone: "Asia/Taipei" },
    tools: ["kpi-monitor", "report-gen", "notification", "task-assign"],
    llmConfig: { provider: "anthropic", model: "claude-sonnet-4-5-20250929", temperature: 0.7 },
    metrics: { tasksCompleted: 42, avgResponseTime: "2.3s", reliability: 98.5, weeklyTasks: [8, 12, 10, 12] },
    taskQueue: [
      { id: "t1", title: "ç”Ÿæˆæ¯æ—¥ç«™ç«‹å ±å‘Š", status: "pending", priority: "high", dueDate: "2026-02-10" },
      { id: "t2", title: "å”èª¿é …ç›®3é¢¨éšªæœƒè­°", status: "in_progress", priority: "high", dueDate: "2026-02-09" },
      { id: "t3", title: "æ›´æ–°é€±å ±æ¨¡æ¿", status: "completed", priority: "medium", completedAt: "2026-02-07" }
    ],
    activityLog: [
      { time: "2026-02-08 09:30", type: "info", message: "å®Œæˆæ¯æ—¥é€²åº¦æƒæ" },
      { time: "2026-02-08 09:15", type: "alert", message: "åµæ¸¬åˆ°é …ç›®6å»¶é²é¢¨éšª" },
      { time: "2026-02-07 17:00", type: "success", message: "æ¯æ—¥å ±å‘Šå·²ç™¼é€" },
      { time: "2026-02-07 09:00", type: "info", message: "ç³»çµ±å•Ÿå‹•ï¼Œé–‹å§‹æ¯æ—¥æ’ç¨‹" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-002", name: "Analyst", emoji: "ğŸ“Š",
    role: "Data & KPI Specialist",
    description: "ç›£æ§ KPI è¶¨å‹¢ï¼Œç”Ÿæˆæ´å¯Ÿå ±å‘Šï¼Œè­˜åˆ¥æ•¸æ“šæ¨¡å¼",
    status: "active", autonomy: "specialist",
    assignedProjects: [1, 3, 7],
    schedule: { type: "weekly", day: "monday", time: "09:00", timezone: "Asia/Taipei" },
    tools: ["kpi-monitor", "trend-analysis", "report-gen", "data-viz"],
    llmConfig: { provider: "openai", model: "gpt-4o", temperature: 0.3 },
    metrics: { tasksCompleted: 28, avgResponseTime: "5.1s", reliability: 96.2, weeklyTasks: [5, 7, 8, 8] },
    taskQueue: [
      { id: "t4", title: "ç”Ÿæˆé€±å ±KPIæ‘˜è¦", status: "pending", priority: "high", dueDate: "2026-02-10" },
      { id: "t5", title: "åˆ†æé …ç›®1é€²åº¦è¶¨å‹¢", status: "completed", priority: "medium", completedAt: "2026-02-07" }
    ],
    activityLog: [
      { time: "2026-02-08 10:00", type: "info", message: "é–‹å§‹é€±åº¦ KPI æ•¸æ“šæ”¶é›†" },
      { time: "2026-02-07 14:00", type: "success", message: "å®Œæˆé …ç›®1é€²åº¦è¶¨å‹¢åˆ†æ" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-003", name: "Tracker", emoji: "ğŸ“‹",
    role: "PM & Deadline Monitor",
    description: "è¿½è¹¤é€²åº¦ã€æ¨™è¨˜å»¶é²ã€ç™¼é€æˆªæ­¢æ—¥æé†’",
    status: "active", autonomy: "specialist",
    assignedProjects: [1, 2, 3, 4, 5, 6, 7],
    schedule: { type: "daily", time: "07:00", timezone: "Asia/Taipei" },
    tools: ["deadline-check", "progress-calc", "notification", "calendar-sync"],
    llmConfig: { provider: "none", model: "", temperature: 0 },
    metrics: { tasksCompleted: 156, avgResponseTime: "0.8s", reliability: 99.1, weeklyTasks: [35, 42, 38, 41] },
    taskQueue: [
      { id: "t6", title: "æƒææœ¬é€±åˆ°æœŸé …ç›®", status: "in_progress", priority: "high", dueDate: "2026-02-08" },
      { id: "t7", title: "æ›´æ–°ç”˜ç‰¹åœ–é€²åº¦", status: "pending", priority: "medium", dueDate: "2026-02-09" }
    ],
    activityLog: [
      { time: "2026-02-08 07:30", type: "alert", message: "é …ç›®3é€²åº¦è½å¾Œé æœŸ15%" },
      { time: "2026-02-08 07:15", type: "info", message: "å®Œæˆæ¯æ—¥æˆªæ­¢æ—¥æƒæ" },
      { time: "2026-02-07 07:00", type: "info", message: "æ¯æ—¥æƒæï¼š2é …å³å°‡åˆ°æœŸ" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-004", name: "Sentinel", emoji: "ğŸ””",
    role: "Risk Detection",
    description: "åµæ¸¬ç•°å¸¸ã€æ¨™è¨˜é¢¨éšªé …ç›®ã€ç›£æ§ä¾è³´é—œä¿‚",
    status: "active", autonomy: "specialist",
    assignedProjects: [3, 4, 6],
    schedule: { type: "continuous", interval: "30min" },
    tools: ["risk-scorer", "dependency-map", "anomaly-detect", "notification"],
    llmConfig: { provider: "local", model: "llama-3.1-8b", temperature: 0.2 },
    metrics: { tasksCompleted: 89, avgResponseTime: "1.2s", reliability: 97.8, weeklyTasks: [20, 22, 25, 22] },
    taskQueue: [
      { id: "t8", title: "è©•ä¼°é …ç›®6å»¶é²å½±éŸ¿", status: "in_progress", priority: "high", dueDate: "2026-02-08" },
      { id: "t9", title: "æ›´æ–°é¢¨éšªçŸ©é™£", status: "pending", priority: "medium", dueDate: "2026-02-10" }
    ],
    activityLog: [
      { time: "2026-02-08 08:45", type: "alert", message: "é …ç›®6å®¢æˆ¶é«”é©—å„ªåŒ–åš´é‡å»¶é²" },
      { time: "2026-02-08 08:00", type: "warning", message: "é …ç›®3 APIé–‹ç™¼ä¾è³´é …æœªå®Œæˆ" },
      { time: "2026-02-07 16:00", type: "info", message: "é¢¨éšªæƒæå®Œæˆï¼š2é«˜é¢¨éšªï¼Œ1ä¸­é¢¨éšª" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  },
  {
    id: "agent-005", name: "Scribe", emoji: "ğŸ“",
    role: "Documentation & Reports",
    description: "ç”Ÿæˆæœƒè­°è¨˜éŒ„ã€é€±å ±ã€è®Šæ›´æ—¥èªŒ",
    status: "idle", autonomy: "intern",
    assignedProjects: [1, 2, 5],
    schedule: { type: "weekly", day: "friday", time: "16:00", timezone: "Asia/Taipei" },
    tools: ["report-gen", "template-engine", "doc-format", "summary-gen"],
    llmConfig: { provider: "anthropic", model: "claude-sonnet-4-5-20250929", temperature: 0.5 },
    metrics: { tasksCompleted: 15, avgResponseTime: "8.5s", reliability: 94.0, weeklyTasks: [3, 4, 4, 4] },
    taskQueue: [
      { id: "t10", title: "æ’°å¯«æœ¬é€±é€²åº¦é€±å ±", status: "pending", priority: "high", dueDate: "2026-02-14" }
    ],
    activityLog: [
      { time: "2026-02-07 16:30", type: "success", message: "é€±å ±è‰ç¨¿å·²ç”Ÿæˆï¼Œç­‰å¾…å¯©æ ¸" },
      { time: "2026-02-07 16:00", type: "info", message: "é–‹å§‹ç”Ÿæˆç¬¬6é€±é€±å ±" }
    ],
    createdAt: "2026-01-20", updatedAt: "2026-02-07"
  },
  {
    id: "agent-006", name: "Connector", emoji: "ğŸ”—",
    role: "Integration & Data Sync",
    description: "ç®¡ç† API é€£æ¥ã€åŒæ­¥å¤–éƒ¨ç³»çµ±è³‡æ–™",
    status: "paused", autonomy: "specialist",
    assignedProjects: [3, 7],
    schedule: { type: "hourly", interval: "1h" },
    tools: ["api-sync", "webhook-manager", "data-transform", "health-check"],
    llmConfig: { provider: "none", model: "", temperature: 0 },
    metrics: { tasksCompleted: 312, avgResponseTime: "1.5s", reliability: 95.3, weeklyTasks: [70, 78, 82, 82] },
    taskQueue: [
      { id: "t11", title: "æ¢å¾© Google Sheets åŒæ­¥", status: "pending", priority: "high", dueDate: "2026-02-09" },
      { id: "t12", title: "è¨­å®š Jira webhook", status: "pending", priority: "medium", dueDate: "2026-02-12" }
    ],
    activityLog: [
      { time: "2026-02-08 06:00", type: "error", message: "Google Sheets API é€£ç·šé€¾æ™‚" },
      { time: "2026-02-07 23:00", type: "info", message: "æ¯å°æ™‚åŒæ­¥å®Œæˆ" }
    ],
    createdAt: "2026-01-15", updatedAt: "2026-02-08"
  }
];

const defaultWorkflows = [
  {
    id: "wf-001", name: "é€±å ±å‘Š", description: "æ¯é€±è‡ªå‹•æ”¶é›†æ•¸æ“šä¸¦ç”Ÿæˆå ±å‘Š",
    trigger: { type: "schedule", cron: "0 9 * * 1", label: "æ¯é€±ä¸€ 09:00" },
    steps: [
      { agent: "Analyst", action: "æ”¶é›† KPI æ•¸æ“š", output: "KPI æ‘˜è¦" },
      { agent: "Tracker", action: "æ¨™è¨˜é€¾æœŸé …ç›®", output: "é€¾æœŸæ¸…å–®" },
      { agent: "Scribe", action: "ç”Ÿæˆå ±å‘Šè‰ç¨¿", output: "é€±å ±è‰ç¨¿" },
      { agent: "Jarvis", action: "å¯©æ ¸ä¸¦ç™¼é€", output: "æœ€çµ‚é€±å ±" }
    ],
    status: "active", lastRun: "2026-02-03 09:00", nextRun: "2026-02-10 09:00"
  },
  {
    id: "wf-002", name: "é¢¨éšªè­¦å ±", description: "å³æ™‚åµæ¸¬ä¸¦é€šå ±é¢¨éšª",
    trigger: { type: "event", event: "status_change_to_risk", label: "ç‹€æ…‹è®Šæ›´ç‚ºå»¶é²/é¢¨éšª" },
    steps: [
      { agent: "Sentinel", action: "åµæ¸¬é¢¨éšªæ¢ä»¶", output: "é¢¨éšªå ±å‘Š" },
      { agent: "Analyst", action: "è©•ä¼°å½±éŸ¿ç¯„åœ", output: "å½±éŸ¿åˆ†æ" },
      { agent: "Jarvis", action: "åˆ¤å®šåš´é‡åº¦", output: "åš´é‡åº¦ç­‰ç´š" },
      { agent: "Connector", action: "ç™¼é€é€šçŸ¥", output: "é€šçŸ¥ç´€éŒ„" }
    ],
    status: "active", lastRun: "2026-02-08 08:45", nextRun: "on-event"
  },
  {
    id: "wf-003", name: "é€²åº¦æ›´æ–°", description: "è³‡æ–™è®Šæ›´æ™‚è‡ªå‹•æ›´æ–°ç›¸é—œæŒ‡æ¨™",
    trigger: { type: "event", event: "data_change", label: "è³‡æ–™è®Šæ›´æ™‚" },
    steps: [
      { agent: "Tracker", action: "è¨ˆç®—å·®ç•°", output: "è®Šæ›´æ‘˜è¦" },
      { agent: "Analyst", action: "æ›´æ–° KPI", output: "æ›´æ–°æŒ‡æ¨™" },
      { agent: "Scribe", action: "è¨˜éŒ„è®Šæ›´", output: "è®Šæ›´æ—¥èªŒ" },
      { agent: "Connector", action: "åŒæ­¥å¤–éƒ¨", output: "åŒæ­¥çµæœ" }
    ],
    status: "active", lastRun: "2026-02-08 10:00", nextRun: "on-event"
  }
];

// ==================== STATE MANAGEMENT ====================
let state = {
  projects: [],
  agents: [],
  workflows: [],
  llmConfig: {...llmConfig},
  currentRoute: '/',
  sidebarCollapsed: false,
  theme: 'system',
  editingItem: null,
  searchQuery: ''
};

function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      state.projects = parsed.projects || JSON.parse(JSON.stringify(defaultProjects));
      state.agents = parsed.agents || JSON.parse(JSON.stringify(defaultAgents));
      state.workflows = parsed.workflows || JSON.parse(JSON.stringify(defaultWorkflows));
      state.llmConfig = parsed.llmConfig || {...llmConfig};
      state.theme = parsed.theme || 'system';
      state.sidebarCollapsed = parsed.sidebarCollapsed || false;
    } catch(e) {
      resetToDefaults();
    }
  } else {
    resetToDefaults();
  }
}

function resetToDefaults() {
  state.projects = JSON.parse(JSON.stringify(defaultProjects));
  state.agents = JSON.parse(JSON.stringify(defaultAgents));
  state.workflows = JSON.parse(JSON.stringify(defaultWorkflows));
  state.llmConfig = {...llmConfig};
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    projects: state.projects,
    agents: state.agents,
    workflows: state.workflows,
    llmConfig: state.llmConfig,
    theme: state.theme,
    sidebarCollapsed: state.sidebarCollapsed
  }));
}

// ==================== ROUTER ====================
const routes = {
  '/': renderOverview,
  '/projects': renderProjectsList,
  '/projects/:id': renderProjectDetail,
  '/projects/:id/actions/:aid': renderActionDetail,
  '/timeline': renderTimeline,
  '/agents': renderAgentSquad,
  '/agents/workflows': renderWorkflows,
  '/agents/activity': renderAgentActivity,
  '/agents/:id': renderAgentDetail,
  '/team': renderTeam,
  '/team/:name': renderTeamMemberDetail,
  '/actions': renderAllActions,
  '/settings': renderSettings
};

function navigateTo(path) {
  window.location.hash = path;
}

function parseRoute(hash) {
  const path = hash.replace('#', '') || '/';
  if (routes[path]) return { handler: routes[path], params: {} };

  for (const [pattern, handler] of Object.entries(routes)) {
    const patternParts = pattern.split('/');
    const pathParts = path.split('/');
    if (patternParts.length !== pathParts.length) continue;

    const params = {};
    let match = true;
    for (let i = 0; i < patternParts.length; i++) {
      if (patternParts[i].startsWith(':')) {
        params[patternParts[i].slice(1)] = decodeURIComponent(pathParts[i]);
      } else if (patternParts[i] !== pathParts[i]) {
        match = false;
        break;
      }
    }
    if (match) return { handler, params };
  }
  return { handler: renderOverview, params: {} };
}

function handleRoute() {
  const { handler, params } = parseRoute(window.location.hash);
  state.currentRoute = window.location.hash.replace('#', '') || '/';
  updateSidebarActive();
  updateBreadcrumb();
  const container = document.getElementById('view-container');
  container.innerHTML = '';
  container.className = 'view-container fade-in';
  handler(container, params);
}

window.addEventListener('hashchange', handleRoute);

// ==================== THEME SYSTEM ====================
function initTheme() {
  const saved = state.theme || 'system';
  setTheme(saved);

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (state.theme === 'system') {
      document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
    }
  });
}

function setTheme(theme) {
  state.theme = theme;
  if (theme === 'system') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  } else {
    document.documentElement.setAttribute('data-theme', theme);
  }
  const btn = document.getElementById('theme-toggle');
  if (btn) {
    const current = document.documentElement.getAttribute('data-theme');
    btn.textContent = current === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  }
  saveState();
}

function cycleTheme() {
  const themes = ['light', 'dark', 'system'];
  const idx = themes.indexOf(state.theme);
  setTheme(themes[(idx + 1) % themes.length]);
  showToast(`ä¸»é¡Œ: ${state.theme === 'system' ? 'è·Ÿéš¨ç³»çµ±' : state.theme === 'dark' ? 'æ·±è‰²' : 'æ·ºè‰²'}`);
}

// ==================== UTILITY FUNCTIONS ====================
function updateSidebarActive() {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
    const href = item.getAttribute('data-route');
    if (state.currentRoute === '/' && href === '/') {
      item.classList.add('active');
    } else if (href !== '/' && state.currentRoute.startsWith(href)) {
      item.classList.add('active');
    }
  });
}

function updateBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  if (!bc) return;
  const parts = state.currentRoute.split('/').filter(Boolean);
  let html = '<a href="#/" class="bc-link">ğŸ  é¦–é </a>';
  const routeMap = {
    'projects': 'é …ç›®', 'timeline': 'æ™‚ç¨‹', 'agents': 'ä»£ç†äºº',
    'team': 'åœ˜éšŠ', 'actions': 'Action Items', 'settings': 'è¨­å®š',
    'workflows': 'å·¥ä½œæµ', 'activity': 'æ´»å‹•ç´€éŒ„'
  };

  let path = '';
  parts.forEach((part, i) => {
    path += '/' + part;
    const label = routeMap[part] || (isNaN(part) ? decodeURIComponent(part) : getNameById(parts, part));
    if (i === parts.length - 1) {
      html += ` <span class="bc-sep">â€º</span> <span class="bc-current">${label}</span>`;
    } else {
      html += ` <span class="bc-sep">â€º</span> <a href="#${path}" class="bc-link">${label}</a>`;
    }
  });
  bc.innerHTML = html;
}

function getNameById(parts, id) {
  if (parts.includes('projects')) {
    const p = state.projects.find(p => p.id == id);
    return p ? p.name : `é …ç›® ${id}`;
  }
  if (parts.includes('agents')) {
    const a = state.agents.find(a => a.id === id || a.id === `agent-${id.padStart(3,'0')}`);
    return a ? a.name : `Agent ${id}`;
  }
  return id;
}

function toggleSidebar() {
  state.sidebarCollapsed = !state.sidebarCollapsed;
  document.body.classList.toggle('sidebar-collapsed', state.sidebarCollapsed);
  saveState();
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function getStatusBadge(status) {
  const map = {
    'completed': '<span class="badge badge-success">å·²å®Œæˆ</span>',
    'in_progress': '<span class="badge badge-info">é€²è¡Œä¸­</span>',
    'pending': '<span class="badge badge-warning">å¾…è™•ç†</span>',
    'on_track': '<span class="badge badge-success">æ­£å¸¸</span>',
    'at_risk': '<span class="badge badge-warning">æœ‰é¢¨éšª</span>',
    'delayed': '<span class="badge badge-danger">å»¶é²</span>',
    'active': '<span class="badge badge-success">é‹è¡Œä¸­</span>',
    'idle': '<span class="badge badge-warning">é–’ç½®</span>',
    'paused': '<span class="badge badge-secondary">æš«åœ</span>',
    'error': '<span class="badge badge-danger">éŒ¯èª¤</span>'
  };
  return map[status] || `<span class="badge">${status}</span>`;
}

function getPriorityBadge(priority) {
  const map = {
    'high': '<span class="badge badge-danger">é«˜</span>',
    'medium': '<span class="badge badge-warning">ä¸­</span>',
    'low': '<span class="badge badge-info">ä½</span>'
  };
  return map[priority] || '';
}

function getAllActionItems() {
  const items = [];
  state.projects.forEach(p => {
    p.actionItems.forEach(a => {
      items.push({ ...a, projectId: p.id, projectName: p.name, projectCode: p.code });
    });
  });
  return items;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  return dateStr;
}

function openEditPanel(projectId, actionId) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const action = project.actionItems.find(a => a.id === actionId);
  if (!action) return;

  state.editingItem = { projectId, actionId };

  const body = document.getElementById('edit-panel-body');
  body.innerHTML = `
    <div class="form-group">
      <label class="form-label">é …ç›®</label>
      <input class="form-input" value="${project.name}" disabled>
    </div>
    <div class="form-group">
      <label class="form-label">åç¨±</label>
      <input class="form-input" id="edit-name" value="${action.name}">
    </div>
    <div class="form-group">
      <label class="form-label">ç´°é …èªªæ˜</label>
      <textarea class="form-textarea" id="edit-breakdown" rows="3">${action.breakdown}</textarea>
    </div>
    <div class="form-group">
      <label class="form-label">è² è²¬å–®ä½</label>
      <input class="form-input" id="edit-unit" value="${action.ownerUnit}">
    </div>
    <div class="form-group">
      <label class="form-label">è² è²¬äºº</label>
      <input class="form-input" id="edit-owner" value="${action.owner}">
    </div>
    <div class="form-group">
      <label class="form-label">ç‹€æ…‹</label>
      <select class="form-select" id="edit-status">
        <option value="pending" ${action.status==='pending'?'selected':''}>å¾…è™•ç†</option>
        <option value="in_progress" ${action.status==='in_progress'?'selected':''}>é€²è¡Œä¸­</option>
        <option value="completed" ${action.status==='completed'?'selected':''}>å·²å®Œæˆ</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">å„ªå…ˆåº¦</label>
      <select class="form-select" id="edit-priority">
        <option value="high" ${action.priority==='high'?'selected':''}>é«˜</option>
        <option value="medium" ${action.priority==='medium'?'selected':''}>ä¸­</option>
        <option value="low" ${action.priority==='low'?'selected':''}>ä½</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">é–‹å§‹æœˆä»½</label>
      <input type="number" class="form-input" id="edit-start" value="${action.startMonth}" min="1" max="12">
    </div>
    <div class="form-group">
      <label class="form-label">çµæŸæœˆä»½</label>
      <input type="number" class="form-input" id="edit-end" value="${action.endMonth}" min="1" max="12">
    </div>
  `;

  document.getElementById('edit-overlay').classList.remove('hidden');
  document.getElementById('edit-panel').classList.remove('hidden');

  document.addEventListener('keydown', editPanelEscHandler);
}

function editPanelEscHandler(e) {
  if (e.key === 'Escape') closeEditPanel();
}

function closeEditPanel() {
  document.getElementById('edit-overlay').classList.add('hidden');
  document.getElementById('edit-panel').classList.add('hidden');
  state.editingItem = null;
  document.removeEventListener('keydown', editPanelEscHandler);
}

function saveEdit() {
  if (!state.editingItem) return;
  const { projectId, actionId } = state.editingItem;
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const action = project.actionItems.find(a => a.id === actionId);
  if (!action) return;

  action.name = document.getElementById('edit-name').value;
  action.breakdown = document.getElementById('edit-breakdown').value;
  action.ownerUnit = document.getElementById('edit-unit').value;
  action.owner = document.getElementById('edit-owner').value;
  action.status = document.getElementById('edit-status').value;
  action.priority = document.getElementById('edit-priority').value;
  action.startMonth = parseInt(document.getElementById('edit-start').value);
  action.endMonth = parseInt(document.getElementById('edit-end').value);

  const total = project.actionItems.length;
  const completed = project.actionItems.filter(a => a.status === 'completed').length;
  project.progress = Math.round((completed / total) * 100);

  const hasDelayed = project.actionItems.some(a => a.status === 'delayed');
  const hasAtRisk = project.actionItems.some(a => {
    const now = new Date().getMonth() + 1;
    return a.status === 'pending' && a.startMonth <= now;
  });
  if (hasDelayed) project.status = 'delayed';
  else if (hasAtRisk) project.status = 'at_risk';
  else project.status = 'on_track';

  saveState();
  closeEditPanel();
  handleRoute();
  showToast('å·²å„²å­˜è®Šæ›´', 'success');
}

function handleSearch(query) {
  state.searchQuery = query.toLowerCase();
  if (!query) {
    handleRoute();
    return;
  }
  navigateTo('/actions');
}

function exportData() {
  const data = {
    version: APP_VERSION,
    exportDate: new Date().toISOString(),
    projects: state.projects,
    agents: state.agents,
    workflows: state.workflows,
    llmConfig: state.llmConfig
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dto_dashboard_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('è³‡æ–™å·²åŒ¯å‡º', 'success');
}

function importData(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.projects) state.projects = data.projects;
      if (data.agents) state.agents = data.agents;
      if (data.workflows) state.workflows = data.workflows;
      if (data.llmConfig) state.llmConfig = data.llmConfig;
      saveState();
      handleRoute();
      showToast('è³‡æ–™å·²åŒ¯å…¥', 'success');
    } catch(err) {
      showToast('åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤', 'error');
    }
  };
  reader.readAsText(file);
}

function exportCSV() {
  const items = getAllActionItems();
  const headers = ['é …ç›®ä»£è™Ÿ','é …ç›®åç¨±','ID','åç¨±','ç´°é …','è² è²¬å–®ä½','è² è²¬äºº','ç‹€æ…‹','å„ªå…ˆåº¦','é–‹å§‹æœˆ','çµæŸæœˆ'];
  const rows = items.map(i => [i.projectCode, i.projectName, i.id, i.name, i.breakdown, i.ownerUnit, i.owner, i.status, i.priority, i.startMonth, i.endMonth]);
  const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dto_action_items_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV å·²åŒ¯å‡º', 'success');
}

function showModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
}
/**
 * DTO Dashboard v3.0 - Main View Render Functions
 * Renders HTML for all primary views into container elements
 * References global state object and utility functions
 */

/**
 * renderOverview(container, params)
 * Command Center / Dashboard overview page
 */
function renderOverview(container, params) {
  const allItems = getAllActionItems();
  const completedCount = allItems.filter(i => i.status === 'completed').length;
  const completionPercent = allItems.length > 0 ? Math.round((completedCount / allItems.length) * 100) : 0;
  const riskCount = state.projects.filter(p => p.status === 'at_risk' || p.status === 'delayed').length;

  // Collect and sort activity logs
  const activityLogs = [];
  state.projects.forEach(p => {
    if (p.activityLog && Array.isArray(p.activityLog)) {
      p.activityLog.forEach(log => {
        activityLogs.push({...log, projectCode: p.code});
      });
    }
  });
  activityLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  const recentActivity = activityLogs.slice(0, 8);

  const today = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });

  let html = `
    <div class="view-overview">
      <div class="view-header">
        <h1>ğŸ“Š DTO Command Center</h1>
        <span class="text-muted">${today}</span>
      </div>

      <!-- Quick Stats Row -->
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“‹</div>
          <div class="stat-content">
            <div class="stat-label">ç¸½é …ç›®æ•¸</div>
            <div class="stat-value">${state.projects.length}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-content">
            <div class="stat-label">Action Items</div>
            <div class="stat-value">${allItems.length}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-content">
            <div class="stat-label">å®Œæˆç‡</div>
            <div class="stat-value">${completionPercent}%</div>
            <div class="progress-bar" style="height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 8px;">
              <div style="height: 100%; background: #22c55e; width: ${completionPercent}%; border-radius: 2px;"></div>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">âš ï¸</div>
          <div class="stat-content">
            <div class="stat-label">é¢¨éšªé …ç›®</div>
            <div class="stat-value">${riskCount}</div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="chart-grid">
        <div class="card">
          <h3>Project Progress</h3>
          <canvas id="chart-progress" width="400" height="250"></canvas>
        </div>

        <div class="card">
          <h3>Status Distribution</h3>
          <canvas id="chart-status" width="400" height="250"></canvas>
        </div>

        <div class="card">
          <h3>Monthly Timeline</h3>
          <canvas id="chart-timeline" width="400" height="250"></canvas>
        </div>

        <div class="card">
          <h3>Owner Workload</h3>
          <canvas id="chart-workload" width="400" height="250"></canvas>
        </div>
      </div>

      <!-- Recent Activity Section -->
      <div class="card">
        <h3>ğŸ“Œ Recent Activity</h3>
        <div class="activity-list">
          ${recentActivity.length > 0 ? recentActivity.map(log => {
            const time = new Date(log.timestamp).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
            const emoji = log.agent === 'system' ? 'âš™ï¸' : 'ğŸ¤–';
            return `<div class="activity-item">
              <span>${emoji} <strong>${log.agent || 'System'}</strong> ${log.message}</span>
              <span class="text-muted">${time}</span>
            </div>`;
          }).join('') : '<div class="text-muted">No recent activity</div>'}
        </div>
      </div>

      <!-- Quick Actions Row -->
      <div class="action-buttons">
        <button onclick="exportData()" class="btn btn-secondary">ğŸ“¥ åŒ¯å‡ºJSON</button>
        <button onclick="exportCSV()" class="btn btn-secondary">ğŸ“Š åŒ¯å‡ºCSV</button>
        <button onclick="if(confirm('ç¢ºå®šè¦é‡ç½®è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) { state.projects = []; saveState(); location.reload(); }" class="btn btn-danger">ğŸ”„ é‡ç½®è³‡æ–™</button>
      </div>
    </div>
  `;

  container.innerHTML = html;

  // Initialize charts after DOM is ready
  setTimeout(() => {
    initOverviewCharts();
  }, 100);
}

function initOverviewCharts() {
  // Chart 1: Project Progress (horizontal bar)
  const ctx1 = document.getElementById('chart-progress');
  if (ctx1 && typeof Chart !== 'undefined') {
    new Chart(ctx1.getContext('2d'), {
      type: 'bar',
      data: {
        labels: state.projects.map(p => p.code),
        datasets: [{
          label: 'å®Œæˆç‡ %',
          data: state.projects.map(p => p.progress || 0),
          backgroundColor: state.projects.map(p => {
            if (p.status === 'delayed') return '#ef4444';
            if (p.status === 'at_risk') return '#f59e0b';
            return '#22c55e';
          }),
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            max: 100,
            ticks: { callback: v => v + '%' }
          }
        }
      }
    });
  }

  // Chart 2: Status Distribution (doughnut)
  const ctx2 = document.getElementById('chart-status');
  if (ctx2 && typeof Chart !== 'undefined') {
    const statuses = {};
    state.projects.forEach(p => {
      statuses[p.status] = (statuses[p.status] || 0) + 1;
    });
    new Chart(ctx2.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(statuses),
        datasets: [{
          data: Object.values(statuses),
          backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  // Chart 3: Monthly Timeline (stacked bar)
  const ctx3 = document.getElementById('chart-timeline');
  if (ctx3 && typeof Chart !== 'undefined') {
    const monthCounts = Array(12).fill(0);
    getAllActionItems().forEach(item => {
      for (let m = (item.startMonth || 1) - 1; m < (item.endMonth || 12); m++) {
        if (m >= 0 && m < 12) monthCounts[m]++;
      }
    });
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    new Chart(ctx3.getContext('2d'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [{
          label: 'Active Items',
          data: monthCounts,
          backgroundColor: '#3b82f6',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    });
  }

  // Chart 4: Owner Workload (bar)
  const ctx4 = document.getElementById('chart-workload');
  if (ctx4 && typeof Chart !== 'undefined') {
    const ownerCounts = {};
    getAllActionItems().forEach(item => {
      const owner = item.owner || 'Unassigned';
      ownerCounts[owner] = (ownerCounts[owner] || 0) + 1;
    });
    const topOwners = Object.entries(ownerCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
    new Chart(ctx4.getContext('2d'), {
      type: 'bar',
      data: {
        labels: topOwners.map(o => o[0]),
        datasets: [{
          label: 'Items',
          data: topOwners.map(o => o[1]),
          backgroundColor: '#8b5cf6',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    });
  }
}

/**
 * renderProjectsList(container, params)
 * Project list page with card/table toggle
 */
function renderProjectsList(container, params) {
  const viewMode = state.viewMode || 'card';
  let filteredProjects = state.projects;

  if (state.filterStatus) {
    filteredProjects = filteredProjects.filter(p => p.status === state.filterStatus);
  }
  if (state.searchQuery) {
    const q = state.searchQuery.toLowerCase();
    filteredProjects = filteredProjects.filter(p =>
      p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q)
    );
  }

  let html = `
    <div class="view-projects-list">
      <div class="view-header">
        <h1>ğŸ“‹ é …ç›®ç®¡ç†</h1>
      </div>

      <div class="controls-row">
        <div class="control-group">
          <label>æª¢è¦–:</label>
          <button onclick="state.viewMode='card'; handleRoute()" class="btn ${viewMode==='card' ? 'btn-primary' : 'btn-secondary'}">ğŸ¨ å¡ç‰‡</button>
          <button onclick="state.viewMode='table'; handleRoute()" class="btn ${viewMode==='table' ? 'btn-primary' : 'btn-secondary'}">ğŸ“Š è¡¨æ ¼</button>
        </div>

        <div class="control-group">
          <label>ç‹€æ…‹:</label>
          <select onchange="state.filterStatus = this.value; handleRoute()" class="input-select">
            <option value="">å…¨éƒ¨</option>
            <option value="planning">Planning</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="at_risk">At Risk</option>
            <option value="delayed">Delayed</option>
          </select>
        </div>

        <input type="text" placeholder="æœå°‹..." onchange="state.searchQuery = this.value; handleRoute()" class="input-text" style="flex: 1;">
      </div>
  `;

  if (viewMode === 'card') {
    html += `<div class="card-grid">`;
    filteredProjects.forEach(project => {
      const itemCount = (project.actionItems || []).length;
      const completedCount = (project.actionItems || []).filter(i => i.status === 'completed').length;
      html += `
        <div class="card" onclick="navigateTo('/projects/${project.id}')">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <span class="badge">${project.code}</span>
            ${getStatusBadge(project.status)}
          </div>
          <h3>${project.name}</h3>
          <p class="text-muted" style="margin: 8px 0;">${project.description || 'No description'}</p>
          <div class="progress-bar" style="margin: 12px 0;">
            <div style="background: #3b82f6; width: ${project.progress || 0}%; height: 100%;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 8px;">
            <span class="text-muted">${project.owner || '-'}</span>
            <span>${project.progress || 0}%</span>
          </div>
          <div class="text-muted" style="font-size: 0.85em;">ğŸ“ ${completedCount}/${itemCount} completed</div>
        </div>
      `;
    });
    html += `</div>`;
  } else {
    html += `
      <table class="data-table">
        <thead>
          <tr>
            <th>ä»£è™Ÿ</th>
            <th>åç¨±</th>
            <th>è² è²¬å–®ä½</th>
            <th>é€²åº¦</th>
            <th>ç‹€æ…‹</th>
            <th>Action Items</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
    `;
    filteredProjects.forEach(project => {
      const itemCount = (project.actionItems || []).length;
      const completedCount = (project.actionItems || []).filter(i => i.status === 'completed').length;
      html += `
        <tr>
          <td><span class="badge">${project.code}</span></td>
          <td>${project.name}</td>
          <td>${project.owner || '-'}</td>
          <td><div class="progress-bar" style="width: 100px;"><div style="background: #3b82f6; width: ${project.progress || 0}%; height: 100%;"></div></div></td>
          <td>${getStatusBadge(project.status)}</td>
          <td>${completedCount}/${itemCount}</td>
          <td><button onclick="navigateTo('/projects/${project.id}')" class="btn btn-sm">Edit</button></td>
        </tr>
      `;
    });
    html += `
        </tbody>
      </table>
    `;
  }

  html += `
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderProjectDetail(container, params)
 * Project detail page
 */
function renderProjectDetail(container, params) {
  const project = state.projects.find(p => p.id === params.id);
  if (!project) {
    container.innerHTML = '<div class="error">Project not found</div>';
    return;
  }

  const allItems = project.actionItems || [];
  const completedCount = allItems.filter(i => i.status === 'completed').length;
  const inProgressCount = allItems.filter(i => i.status === 'in_progress').length;
  const pendingCount = allItems.filter(i => i.status === 'pending').length;

  const activeTab = state.projectDetailTab || 'items';

  let html = `
    <div class="view-project-detail">
      <a href="#" onclick="event.preventDefault(); navigateTo('/projects')" class="link">â† è¿”å›é …ç›®åˆ—è¡¨</a>

      <div class="detail-header">
        <div>
          <h1>${project.name}</h1>
          <div style="margin-top: 8px;">
            <span class="badge">${project.code}</span>
            ${getStatusBadge(project.status)}
          </div>
        </div>
      </div>

      <p class="text-muted" style="margin: 16px 0;">${project.description}</p>

      <div class="stats-row">
        <div class="stat-mini">
          <div class="stat-label">é€²åº¦</div>
          <div class="stat-value">${project.progress || 0}%</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">ç¸½ Items</div>
          <div class="stat-value">${allItems.length}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">å®Œæˆ</div>
          <div class="stat-value">${completedCount}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">é€²è¡Œä¸­</div>
          <div class="stat-value">${inProgressCount}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">å¾…è™•ç†</div>
          <div class="stat-value">${pendingCount}</div>
        </div>
      </div>

      <div class="tabs">
        <button onclick="state.projectDetailTab='items'; handleRoute()" class="tab ${activeTab==='items' ? 'active' : ''}">Action Items</button>
        <button onclick="state.projectDetailTab='timeline'; handleRoute()" class="tab ${activeTab==='timeline' ? 'active' : ''}">æ™‚ç¨‹</button>
        <button onclick="state.projectDetailTab='team'; handleRoute()" class="tab ${activeTab==='team' ? 'active' : ''}">åœ˜éšŠ</button>
      </div>

      <div class="tab-content">
  `;

  if (activeTab === 'items') {
    html += renderProjectDetailItems(project);
  } else if (activeTab === 'timeline') {
    html += renderProjectDetailTimeline(project);
  } else if (activeTab === 'team') {
    html += renderProjectDetailTeam(project);
  }

  html += `
      </div>
    </div>
  `;

  container.innerHTML = html;
}

function renderProjectDetailItems(project) {
  let items = project.actionItems || [];
  if (state.filterActionStatus) {
    items = items.filter(i => i.status === state.filterActionStatus);
  }
  if (state.filterActionPriority) {
    items = items.filter(i => i.priority === state.filterActionPriority);
  }

  let html = `
    <div class="filter-row">
      <select onchange="state.filterActionStatus = this.value; handleRoute()" class="input-select">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
      </select>
      <select onchange="state.filterActionPriority = this.value; handleRoute()" class="input-select">
        <option value="">All Priority</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>

    <table class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>åç¨±</th>
          <th>è² è²¬äºº</th>
          <th>ç‹€æ…‹</th>
          <th>å„ªå…ˆåº¦</th>
          <th>æ™‚ç¨‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
  `;

  items.forEach(item => {
    const timeline = item.startMonth && item.endMonth ? `M${item.startMonth}-M${item.endMonth}` : '-';
    html += `
      <tr>
        <td>${item.id}</td>
        <td>${item.name}</td>
        <td>${item.owner || '-'}</td>
        <td>${getStatusBadge(item.status)}</td>
        <td>${getPriorityBadge(item.priority)}</td>
        <td>${timeline}</td>
        <td><button onclick="openEditPanel('${project.id}', '${item.id}')" class="btn btn-sm">Edit</button></td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>
  `;

  return html;
}

function renderProjectDetailTimeline(project) {
  const items = project.actionItems || [];
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  let html = `
    <div class="gantt-container">
      <table class="gantt-table">
        <thead>
          <tr>
            <th style="width: 200px;">Action Item</th>
            ${months.map(m => `<th style="width: 30px;">${m}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
  `;

  items.forEach(item => {
    html += `<tr>
      <td>${item.name}</td>
    `;
    for (let m = 1; m <= 12; m++) {
      const isActive = item.startMonth && item.endMonth && m >= item.startMonth && m <= item.endMonth;
      const bgColor = !isActive ? 'transparent' :
        item.status === 'completed' ? '#22c55e' :
        item.status === 'in_progress' ? '#3b82f6' :
        item.status === 'delayed' ? '#ef4444' : '#94a3b8';
      html += `<td style="background: ${bgColor}; cursor: pointer;" onclick="navigateTo('/projects/${project.id}/actions/${item.id}')"></td>`;
    }
    html += `</tr>`;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  return html;
}

function renderProjectDetailTeam(project) {
  const items = project.actionItems || [];
  const ownerMap = {};

  items.forEach(item => {
    const owner = item.owner || 'Unassigned';
    if (!ownerMap[owner]) {
      ownerMap[owner] = [];
    }
    ownerMap[owner].push(item);
  });

  let html = `<div class="team-overview">`;

  Object.entries(ownerMap).forEach(([owner, ownerItems]) => {
    const completed = ownerItems.filter(i => i.status === 'completed').length;
    const inProgress = ownerItems.filter(i => i.status === 'in_progress').length;
    const pending = ownerItems.filter(i => i.status === 'pending').length;

    html += `
      <div class="card">
        <h3>${owner}</h3>
        <div class="stats-row">
          <div class="stat-mini">
            <div class="stat-label">Total</div>
            <div class="stat-value">${ownerItems.length}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">âœ…</div>
            <div class="stat-value">${completed}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">ğŸ”„</div>
            <div class="stat-value">${inProgress}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">â³</div>
            <div class="stat-value">${pending}</div>
          </div>
        </div>
      </div>
    `;
  });

  html += `</div>`;
  return html;
}

/**
 * renderActionDetail(container, params)
 * Single action item detail
 */
function renderActionDetail(container, params) {
  const project = state.projects.find(p => p.id === params.id);
  if (!project) {
    container.innerHTML = '<div class="error">Project not found</div>';
    return;
  }

  const action = (project.actionItems || []).find(a => a.id === params.aid);
  if (!action) {
    container.innerHTML = '<div class="error">Action item not found</div>';
    return;
  }

  let html = `
    <div class="view-action-detail">
      <a href="#" onclick="event.preventDefault(); navigateTo('/projects/${project.id}')" class="link">â† è¿”å› ${project.name}</a>

      <div class="card" style="margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <h2>${action.name}</h2>
          <button onclick="openEditPanel('${project.id}', '${action.id}')" class="btn btn-primary">âœï¸ Edit</button>
        </div>

        <table class="detail-table">
          <tr>
            <td class="label">ID</td>
            <td>${action.id}</td>
          </tr>
          <tr>
            <td class="label">Project</td>
            <td>${project.code} - ${project.name}</td>
          </tr>
          <tr>
            <td class="label">Breakdown</td>
            <td>${action.breakdown || '-'}</td>
          </tr>
          <tr>
            <td class="label">Owner Unit</td>
            <td>${action.ownerUnit || '-'}</td>
          </tr>
          <tr>
            <td class="label">Owner</td>
            <td>${action.owner || '-'}</td>
          </tr>
          <tr>
            <td class="label">Status</td>
            <td>${getStatusBadge(action.status)}</td>
          </tr>
          <tr>
            <td class="label">Priority</td>
            <td>${getPriorityBadge(action.priority)}</td>
          </tr>
          <tr>
            <td class="label">Timeline</td>
            <td>Month ${action.startMonth || '-'} to Month ${action.endMonth || '-'}</td>
          </tr>
        </table>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderTimeline(container, params)
 * Full year Gantt chart for all projects
 */
function renderTimeline(container, params) {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const currentMonth = new Date().getMonth() + 1;

  const allItems = [];
  state.projects.forEach(project => {
    (project.actionItems || []).forEach(item => {
      allItems.push({...item, projectId: project.id, projectCode: project.code, projectName: project.name});
    });
  });

  let html = `
    <div class="view-timeline">
      <div class="view-header">
        <h1>ğŸ“… å¹´åº¦æ™‚ç¨‹ç¸½è¦½</h1>
      </div>

      <div style="display: flex; gap: 16px; margin: 16px 0;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 3px;"></div>
          <span>Completed</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 3px;"></div>
          <span>In Progress</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #94a3b8; border-radius: 3px;"></div>
          <span>Pending</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 3px;"></div>
          <span>Delayed</span>
        </div>
      </div>

      <div class="gantt-container">
        <table class="gantt-table">
          <thead>
            <tr>
              <th style="width: 250px;">Item</th>
              ${months.map((m, i) => `<th style="width: 40px; background: ${i+1===currentMonth ? '#fef3c7' : 'transparent'};">${m}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
  `;

  allItems.forEach(item => {
    html += `<tr>
      <td style="padding: 8px; font-size: 0.9em;">
        <div>${item.projectCode}</div>
        <div style="color: #666; font-size: 0.85em;">${item.name}</div>
      </td>
    `;

    for (let m = 1; m <= 12; m++) {
      const isActive = item.startMonth && item.endMonth && m >= item.startMonth && m <= item.endMonth;
      const bgColor = !isActive ? 'transparent' :
        item.status === 'completed' ? '#22c55e' :
        item.status === 'in_progress' ? '#3b82f6' :
        item.status === 'delayed' ? '#ef4444' : '#94a3b8';
      const cursor = isActive ? 'pointer' : 'default';

      html += `<td style="background: ${bgColor}; cursor: ${cursor}; border-right: 1px solid #e5e7eb;" onclick="if(this.style.background) navigateTo('/projects/${item.projectId}/actions/${item.id}')"></td>`;
    }
    html += `</tr>`;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderTeam(container, params)
 * Team workload overview
 */
function renderTeam(container, params) {
  const allItems = getAllActionItems();
  const ownerMap = {};

  allItems.forEach(item => {
    const owner = item.owner || 'Unassigned';
    if (!ownerMap[owner]) {
      ownerMap[owner] = [];
    }
    ownerMap[owner].push(item);
  });

  let html = `
    <div class="view-team">
      <div class="view-header">
        <h1>ğŸ‘¥ åœ˜éšŠå·¥ä½œé‡</h1>
      </div>

      <div class="card-grid">
  `;

  Object.entries(ownerMap).forEach(([owner, items]) => {
    const completed = items.filter(i => i.status === 'completed').length;
    const inProgress = items.filter(i => i.status === 'in_progress').length;
    const pending = items.filter(i => i.status === 'pending').length;
    const completionPercent = items.length > 0 ? Math.round((completed / items.length) * 100) : 0;

    html += `
      <div class="card" onclick="navigateTo('/team/${encodeURIComponent('${owner}')}')">
        <h3>${owner}</h3>

        <div class="stats-row">
          <div class="stat-mini">
            <div class="stat-label">Total</div>
            <div class="stat-value">${items.length}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">Done</div>
            <div class="stat-value">${completed}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">In Progress</div>
            <div class="stat-value">${inProgress}</div>
          </div>
          <div class="stat-mini">
            <div class="stat-label">Pending</div>
            <div class="stat-value">${pending}</div>
          </div>
        </div>

        <div class="progress-bar" style="margin: 12px 0;">
          <div style="background: #22c55e; width: ${completionPercent}%; height: 100%;"></div>
        </div>
        <div class="text-muted" style="font-size: 0.9em;">${completionPercent}% complete</div>
      </div>
    `;
  });

  html += `
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderTeamMemberDetail(container, params)
 * Individual team member detail
 */
function renderTeamMemberDetail(container, params) {
  const ownerName = decodeURIComponent(params.name);
  const allItems = getAllActionItems().filter(i => (i.owner || 'Unassigned') === ownerName);

  const completed = allItems.filter(i => i.status === 'completed').length;
  const inProgress = allItems.filter(i => i.status === 'in_progress').length;
  const pending = allItems.filter(i => i.status === 'pending').length;

  let html = `
    <div class="view-team-member">
      <a href="#" onclick="event.preventDefault(); navigateTo('/team')" class="link">â† è¿”å›åœ˜éšŠç¸½è¦½</a>

      <h1>${ownerName}</h1>

      <div class="stats-row">
        <div class="stat-mini">
          <div class="stat-label">Total Items</div>
          <div class="stat-value">${allItems.length}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">Completed</div>
          <div class="stat-value">${completed}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">In Progress</div>
          <div class="stat-value">${inProgress}</div>
        </div>
        <div class="stat-mini">
          <div class="stat-label">Pending</div>
          <div class="stat-value">${pending}</div>
        </div>
      </div>

      <h2 style="margin-top: 24px;">Action Items</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Project</th>
            <th>Item Name</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Timeline</th>
          </tr>
        </thead>
        <tbody>
  `;

  // Map items back to projects
  allItems.forEach(item => {
    const project = state.projects.find(p => p.actionItems && p.actionItems.some(a => a.id === item.id));
    const timeline = item.startMonth && item.endMonth ? `M${item.startMonth}-M${item.endMonth}` : '-';

    html += `
      <tr>
        <td>${project ? project.code : '-'}</td>
        <td>${item.name}</td>
        <td>${getStatusBadge(item.status)}</td>
        <td>${getPriorityBadge(item.priority)}</td>
        <td>${timeline}</td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderAllActions(container, params)
 * Full action items table with filters
 */
function renderAllActions(container, params) {
  let allItems = getAllActionItems().map(item => {
    const project = state.projects.find(p => p.actionItems && p.actionItems.some(a => a.id === item.id));
    return {...item, projectId: project ? project.id : null, projectCode: project ? project.code : '-'};
  });

  if (state.filterProject) {
    allItems = allItems.filter(i => i.projectId === state.filterProject);
  }
  if (state.filterActionStatus) {
    allItems = allItems.filter(i => i.status === state.filterActionStatus);
  }
  if (state.filterActionPriority) {
    allItems = allItems.filter(i => i.priority === state.filterActionPriority);
  }
  if (state.searchQuery) {
    const q = state.searchQuery.toLowerCase();
    allItems = allItems.filter(i => i.name.toLowerCase().includes(q) || i.breakdown?.toLowerCase().includes(q));
  }

  const sortField = state.sortField || 'name';
  const sortOrder = state.sortOrder || 'asc';
  allItems.sort((a, b) => {
    const aVal = a[sortField];
    const bVal = b[sortField];
    if (sortOrder === 'asc') return aVal > bVal ? 1 : -1;
    return aVal < bVal ? 1 : -1;
  });

  const completedCount = allItems.filter(i => i.status === 'completed').length;
  const completionPercent = allItems.length > 0 ? Math.round((completedCount / allItems.length) * 100) : 0;

  let html = `
    <div class="view-all-actions">
      <div class="view-header">
        <h1>ğŸ“ å…¨éƒ¨ Action Items</h1>
      </div>

      <div class="filter-row">
        <select onchange="state.filterProject = this.value; handleRoute()" class="input-select">
          <option value="">All Projects</option>
          ${state.projects.map(p => `<option value="${p.id}">${p.code}</option>`).join('')}
        </select>

        <select onchange="state.filterActionStatus = this.value; handleRoute()" class="input-select">
          <option value="">All Status</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>

        <select onchange="state.filterActionPriority = this.value; handleRoute()" class="input-select">
          <option value="">All Priority</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>

        <input type="text" placeholder="æœå°‹..." onchange="state.searchQuery = this.value; handleRoute()" class="input-text" style="flex: 1;">
      </div>

      <table class="data-table">
        <thead>
          <tr>
            <th onclick="state.sortField='projectCode'; state.sortOrder=state.sortOrder==='asc'?'desc':'asc'; handleRoute()">#</th>
            <th onclick="state.sortField='projectCode'; state.sortOrder=state.sortOrder==='asc'?'desc':'asc'; handleRoute()">é …ç›®</th>
            <th onclick="state.sortField='name'; state.sortOrder=state.sortOrder==='asc'?'desc':'asc'; handleRoute()">åç¨±</th>
            <th>ç´°é …</th>
            <th>è² è²¬äºº</th>
            <th>ç‹€æ…‹</th>
            <th>å„ªå…ˆåº¦</th>
            <th>æ™‚ç¨‹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
  `;

  allItems.forEach((item, idx) => {
    const timeline = item.startMonth && item.endMonth ? `M${item.startMonth}-M${item.endMonth}` : '-';
    html += `
      <tr>
        <td>${idx + 1}</td>
        <td>${item.projectCode}</td>
        <td>${item.name}</td>
        <td>${item.breakdown || '-'}</td>
        <td>${item.owner || '-'}</td>
        <td>${getStatusBadge(item.status)}</td>
        <td>${getPriorityBadge(item.priority)}</td>
        <td>${timeline}</td>
        <td>
          <button onclick="openEditPanel('${item.projectId}', '${item.id}')" class="btn btn-sm">Edit</button>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>

      <div style="padding: 16px; background: #f3f4f6; border-radius: 8px; margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; font-size: 0.95em;">
          <span><strong>ç¸½è¨ˆ:</strong> ${allItems.length} items</span>
          <span><strong>å®Œæˆ:</strong> ${completedCount} (${completionPercent}%)</span>
        </div>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/**
 * renderSettings(container, params)
 * Settings page
 */
function renderSettings(container, params) {
  const theme = localStorage.getItem('theme') || 'light';
  const llmConfig = state.llmConfig || {provider: 'None', apiEndpoint: '', apiKey: '', modelName: '', localPath: '', maxTokens: 2000, temperature: 0.7};

  let html = `
    <div class="view-settings">
      <div class="view-header">
        <h1>âš™ï¸ è¨­å®š</h1>
      </div>

      <!-- Theme Section -->
      <div class="card">
        <h2>ä¸»é¡Œ</h2>
        <div class="setting-group">
          <label>
            <input type="radio" name="theme" value="light" ${theme === 'light' ? 'checked' : ''} onchange="setTheme('light')"> æ·ºè‰²
          </label>
          <label>
            <input type="radio" name="theme" value="dark" ${theme === 'dark' ? 'checked' : ''} onchange="setTheme('dark')"> æ·±è‰²
          </label>
          <label>
            <input type="radio" name="theme" value="system" ${theme === 'system' ? 'checked' : ''} onchange="setTheme('system')"> è·Ÿéš¨ç³»çµ±
          </label>
        </div>
      </div>

      <!-- LLM Configuration Section -->
      <div class="card">
        <h2>ğŸ¤– AI æ¨¡å‹è¨­å®š</h2>
        <p class="text-muted">è¨­å®š AI Agent ä½¿ç”¨çš„èªè¨€æ¨¡å‹</p>

        <div class="setting-group">
          <label>Provider</label>
          <select id="llm-provider" class="input-select" value="${llmConfig.provider}">
            <option value="None">None</option>
            <option value="OpenAI">OpenAI</option>
            <option value="Anthropic">Anthropic</option>
            <option value="Local">Local Model</option>
          </select>
        </div>

        <div class="setting-group">
          <label>API Endpoint</label>
          <input type="text" id="llm-endpoint" class="input-text" value="${llmConfig.apiEndpoint}" placeholder="https://api.example.com/v1">
        </div>

        <div class="setting-group">
          <label>API Key</label>
          <input type="password" id="llm-key" class="input-text" value="${llmConfig.apiKey}" placeholder="sk-...">
        </div>

        <div class="setting-group">
          <label>Model Name</label>
          <input type="text" id="llm-model" class="input-text" value="${llmConfig.modelName}" placeholder="gpt-4, claude-3, etc.">
        </div>

        <div class="setting-group" id="llm-local-group" style="display: ${llmConfig.provider === 'Local' ? 'block' : 'none'};">
          <label>Local Model Path</label>
          <input type="text" id="llm-local-path" class="input-text" value="${llmConfig.localPath}" placeholder="/path/to/model">
        </div>

        <div class="setting-group">
          <label>Max Tokens</label>
          <input type="number" id="llm-tokens" class="input-text" value="${llmConfig.maxTokens}" min="100" max="10000" step="100">
        </div>

        <div class="setting-group">
          <label>Temperature (${llmConfig.temperature})</label>
          <input type="range" id="llm-temp" class="input-range" min="0" max="1" step="0.1" value="${llmConfig.temperature}">
        </div>

        <button onclick="testLLMConnection()" class="btn btn-secondary">ğŸ”— Test Connection</button>
        <button onclick="saveLLMConfig()" class="btn btn-primary">ğŸ’¾ Save</button>
        <div id="llm-test-result"></div>
      </div>

      <!-- Data Section -->
      <div class="card">
        <h2>ğŸ“Š è³‡æ–™</h2>

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="exportData()" class="btn btn-secondary">ğŸ“¥ åŒ¯å‡º JSON</button>
          <button onclick="exportCSV()" class="btn btn-secondary">ğŸ“Š åŒ¯å‡º CSV</button>
          <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(this.files[0])">
          <button onclick="document.getElementById('import-file').click()" class="btn btn-secondary">ğŸ“¤ åŒ¯å…¥ JSON</button>
          <button onclick="if(confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) { resetData(); }" class="btn btn-danger">ğŸ”„ é‡ç½®ç‚ºé è¨­è³‡æ–™</button>
        </div>
      </div>

      <!-- About Section -->
      <div class="card">
        <h2>â„¹ï¸ é—œæ–¼</h2>
        <p><strong>Version:</strong> ${window.APP_VERSION || 'v3.0.0'}</p>
        <p><a href="https://github.com/glen200392/dto-dashboard" target="_blank" class="link">ğŸ”— GitHub Repository</a></p>
      </div>
    </div>
  `;

  container.innerHTML = html;

  // Setup provider select change
  const providerSelect = document.getElementById('llm-provider');
  if (providerSelect) {
    providerSelect.onchange = function() {
      const localGroup = document.getElementById('llm-local-group');
      if (this.value === 'Local' && localGroup) {
        localGroup.style.display = 'block';
      } else if (localGroup) {
        localGroup.style.display = 'none';
      }
    };
  }
}

function testLLMConnection() {
  const resultDiv = document.getElementById('llm-test-result');
  if (resultDiv) {
    resultDiv.innerHTML = '<div class="text-muted" style="margin-top: 8px;">âœ… Test successful (mock)</div>';
    setTimeout(() => { resultDiv.innerHTML = ''; }, 3000);
  }
}

function saveLLMConfig() {
  state.llmConfig = {
    provider: document.getElementById('llm-provider')?.value || 'None',
    apiEndpoint: document.getElementById('llm-endpoint')?.value || '',
    apiKey: document.getElementById('llm-key')?.value || '',
    modelName: document.getElementById('llm-model')?.value || '',
    localPath: document.getElementById('llm-local-path')?.value || '',
    maxTokens: parseInt(document.getElementById('llm-tokens')?.value || '2000'),
    temperature: parseFloat(document.getElementById('llm-temp')?.value || '0.7')
  };
  saveState();
  showToast('LLM Configuration saved', 'success');
}

function resetData() {
  state.projects = [];
  saveState();
  showToast('Data reset to default', 'info');
  location.reload();
}
/**
 * DTO Dashboard v3.0 - Agent Management Views
 * Render functions for AI Agent Squad Control Center
 */

/**
 * 1. renderAgentSquad(container, params)
 * Main hub for AI agent management - displays overview, stats, and agent cards
 */
function renderAgentSquad(container, params) {
  const agents = state.agents || [];
  const workflows = state.workflows || [];

  // Calculate global stats
  const activeCount = agents.filter(a => a.status === 'active').length;
  const totalTasks = agents.reduce((sum, a) => sum + (a.taskQueue?.length || 0), 0);
  const completedToday = agents.reduce((sum, a) => {
    const todayCompleted = a.taskQueue?.filter(t => t.status === 'completed').length || 0;
    return sum + todayCompleted;
  }, 0);
  const pendingTasks = agents.reduce((sum, a) => {
    const pending = a.taskQueue?.filter(t => ['pending', 'in_progress'].includes(t.status)).length || 0;
    return sum + pending;
  }, 0);
  const alertCount = agents.reduce((sum, a) => {
    const todayAlerts = (a.activityLog || [])
      .filter(log => ['alert', 'warning', 'error'].includes(log.type))
      .length;
    return sum + todayAlerts;
  }, 0);

  container.innerHTML = `
    <div class="agent-squad-container">
      <!-- Header -->
      <div class="section-header">
        <h1>ğŸ¤– AI Agent æ§åˆ¶ä¸­å¿ƒ</h1>
        <p class="subtitle">Digital Transformation Agent Squad</p>
      </div>

      <!-- Quick Actions Bar -->
      <div class="quick-actions-bar">
        <button class="btn btn-primary" onclick="handleAddNewAgent()">
          â• æ–°å¢ Agent
        </button>
        <button class="btn btn-secondary" onclick="handlePauseAllAgents()">
          â¸ï¸ å…¨éƒ¨æš«åœ
        </button>
        <button class="btn btn-secondary" onclick="handleActivateAllAgents()">
          â–¶ï¸ å…¨éƒ¨å•Ÿå‹•
        </button>
        <button class="btn btn-secondary" onclick="handleStandupReport()">
          ğŸ“Š è§¸ç™¼ç«™ç«‹æœƒè­°
        </button>
      </div>

      <!-- Global Stats Panel -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${activeCount}/${agents.length}</div>
          <div class="stat-label">æ´»èº Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${completedToday}</div>
          <div class="stat-label">ä»Šæ—¥å®Œæˆä»»å‹™</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${pendingTasks}</div>
          <div class="stat-label">å¾…è™•ç†ä»»å‹™</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${alertCount}</div>
          <div class="stat-label">è­¦å ±æ•¸</div>
        </div>
      </div>

      <!-- Agent Cards Grid -->
      <div class="card-grid">
        ${agents.map(agent => `
          <div class="agent-card" onclick="navigateTo('/agents/${agent.id}')">
            <!-- Status indicator -->
            <div class="card-status-indicator" style="${getStatusIndicatorStyle(agent.status)}"></div>

            <!-- Agent Identity -->
            <div class="agent-card-header">
              <span class="agent-emoji">${agent.emoji || 'ğŸ¤–'}</span>
              <div class="agent-info">
                <h3>${agent.name}</h3>
                <p>${agent.role}</p>
              </div>
            </div>

            <!-- Status & Autonomy Badges -->
            <div class="badge-group">
              <span class="badge badge-${agent.status}">${getStatusBadge(agent.status)}</span>
              <span class="badge badge-autonomy">${getAutonomyBadge(agent.autonomy)}</span>
            </div>

            <!-- LLM Indicator -->
            ${agent.llmConfig && agent.llmConfig.provider !== 'none' ? `
              <div class="llm-indicator">ğŸ§  ${agent.llmConfig.model || 'Custom'}</div>
            ` : ''}

            <!-- Assigned Projects -->
            ${agent.assignedProjects && agent.assignedProjects.length > 0 ? `
              <div class="projects-tags">
                ${agent.assignedProjects.map(pid => `<span class="tag">P${pid}</span>`).join('')}
              </div>
            ` : ''}

            <!-- Key Metrics -->
            <div class="metrics-row">
              <span>âœ“ ${agent.metrics?.tasksCompleted || 0} tasks</span>
              <span>âš¡ ${agent.metrics?.reliability || 0}% reliable</span>
            </div>

            <!-- Last Activity -->
            <div class="last-activity">
              ${agent.activityLog && agent.activityLog.length > 0 ? `
                <small>${agent.activityLog[agent.activityLog.length - 1].message}</small>
              ` : `<small>ç„¡æœ€è¿‘æ´»å‹•</small>`}
            </div>

            <!-- Action Buttons -->
            <div class="card-actions">
              <button class="btn-icon" onclick="event.stopPropagation(); handleToggleAgentStatus('${agent.id}')" title="Toggle Status">
                ${agent.status === 'active' ? 'â¸ï¸' : 'â–¶ï¸'}
              </button>
              <button class="btn-icon" onclick="event.stopPropagation(); navigateTo('/agents/${agent.id}')" title="Configure">
                âš™ï¸
              </button>
              <button class="btn-icon" onclick="event.stopPropagation(); handleQuickTaskAssign('${agent.id}')" title="Assign Task">
                â•
              </button>
            </div>
          </div>
        `).join('')}
      </div>

      <!-- Quick Activity Feed -->
      <div class="activity-feed-section">
        <div class="feed-header">
          <h3>æœ€è¿‘æ´»å‹•</h3>
          <div class="feed-nav">
            <a onclick="navigateTo('/workflows')" class="feed-link">å·¥ä½œæµç®¡ç†</a>
            <span class="divider">|</span>
            <a onclick="navigateTo('/activity')" class="feed-link">å®Œæ•´æ´»å‹•ç´€éŒ„</a>
          </div>
        </div>
        <div class="activity-list">
          ${getRecentActivities(agents, 10).map(item => `
            <div class="activity-item">
              <span class="time">${item.time}</span>
              <span class="agent">${item.emoji} ${item.agent}</span>
              <span class="type-badge badge-${item.type}">${getActivityTypeIcon(item.type)}</span>
              <span class="message">${item.message}</span>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  // Initialize any charts if needed
  setTimeout(() => {
    // Placeholder for chart initialization
  }, 100);
}

/**
 * 2. renderAgentDetail(container, params)
 * Agent detail page with full CRUD and multiple tabs
 */
function renderAgentDetail(container, params) {
  const agentId = params.id;
  const agent = state.agents.find(a => a.id === agentId);

  if (!agent) {
    container.innerHTML = '<p>Agent not found</p>';
    return;
  }

  const projects = state.projects || [];
  let activeTab = 'queue';

  const renderTabs = () => {
    const tabContent = {
      queue: renderTaskQueueTab(agent),
      metrics: renderMetricsTab(agent),
      activity: renderActivityHistoryTab(agent)
    };
    return tabContent[activeTab] || tabContent.queue;
  };

  container.innerHTML = `
    <div class="agent-detail-container">
      <!-- Back Link -->
      <div class="back-link">
        <a onclick="navigateTo('/agents')">â† è¿”å› Agent åˆ—è¡¨</a>
      </div>

      <!-- Agent Identity Section -->
      <div class="agent-identity-section">
        <div class="identity-header">
          <div class="emoji-name">
            <input type="text" class="emoji-input" id="agentEmoji" value="${agent.emoji}" maxlength="2" style="width: 60px;">
            <input type="text" class="name-input" id="agentName" value="${agent.name}" placeholder="Agent Name">
          </div>
          <div class="role-description">
            <input type="text" class="role-input" id="agentRole" value="${agent.role}" placeholder="Role">
            <textarea class="description-input" id="agentDescription" placeholder="Description">${agent.description || ''}</textarea>
          </div>
        </div>

        <!-- Status & Autonomy Controls -->
        <div class="controls-grid">
          <div class="control-group">
            <label>Status</label>
            <div class="status-buttons">
              <button class="btn-toggle ${agent.status === 'active' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {status: 'active'})">Active</button>
              <button class="btn-toggle ${agent.status === 'idle' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {status: 'idle'})">Idle</button>
              <button class="btn-toggle ${agent.status === 'paused' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {status: 'paused'})">Paused</button>
            </div>
          </div>

          <div class="control-group">
            <label>Autonomy Level</label>
            <div class="autonomy-selector">
              <button class="btn-toggle ${agent.autonomy === 'intern' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {autonomy: 'intern'})">ğŸŸ¡ Intern</button>
              <button class="btn-toggle ${agent.autonomy === 'specialist' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {autonomy: 'specialist'})">ğŸ”µ Specialist</button>
              <button class="btn-toggle ${agent.autonomy === 'lead' ? 'active' : ''}" onclick="handleUpdateAgent('${agentId}', {autonomy: 'lead'})">ğŸŸ¢ Lead</button>
            </div>
          </div>
        </div>

        <!-- Schedule -->
        <div class="control-group">
          <label>Schedule</label>
          <div class="schedule-display">
            <span>${agent.schedule?.type || 'N/A'} at ${agent.schedule?.time || 'N/A'}</span>
            <span class="tz">${agent.schedule?.timezone || 'UTC'}</span>
            <button class="btn-icon" onclick="handleEditSchedule('${agentId}')">âœï¸</button>
          </div>
        </div>

        <!-- Assigned Projects -->
        <div class="control-group">
          <label>Assigned Projects</label>
          <div class="projects-checkboxes">
            ${projects.map((proj, idx) => `
              <label class="checkbox-label">
                <input type="checkbox" ${agent.assignedProjects?.includes(proj.id || idx + 1) ? 'checked' : ''}
                       onchange="handleUpdateAgent('${agentId}', {assignedProjects: getSelectedProjects()})">
                ${proj.name || \`Project \${idx + 1}\`}
              </label>
            `).join('')}
          </div>
        </div>

        <!-- Tools -->
        <div class="control-group">
          <label>Tools</label>
          <div class="tools-tags">
            ${(agent.tools || []).map(tool => `<span class="tag">${tool}</span>`).join('')}
          </div>
        </div>

        <!-- LLM Config -->
        <div class="llm-config-section">
          <h3>ğŸ§  AI æ¨¡å‹è¨­å®š</h3>
          <p class="note">ğŸ”Œ é ç•™æ¥å£ â€” æœªä¾†å¯é€£æ¥å¾Œç«¯ AI å¼•æ“ï¼ˆCrewAI / LangGraph / Swarm / Ollamaï¼‰</p>

          <div class="control-group">
            <label>Provider</label>
            <select id="llmProvider" onchange="handleLLMConfigChange('${agentId}')">
              <option value="none" ${agent.llmConfig?.provider === 'none' ? 'selected' : ''}>None</option>
              <option value="openai" ${agent.llmConfig?.provider === 'openai' ? 'selected' : ''}>OpenAI</option>
              <option value="anthropic" ${agent.llmConfig?.provider === 'anthropic' ? 'selected' : ''}>Anthropic</option>
              <option value="local" ${agent.llmConfig?.provider === 'local' ? 'selected' : ''}>Local</option>
            </select>
          </div>

          <div class="control-group">
            <label>Model</label>
            <input type="text" id="llmModel" value="${agent.llmConfig?.model || ''}" placeholder="e.g., claude-opus-4-6">
          </div>

          <div class="control-group">
            <label>Temperature (0.0 - 1.0)</label>
            <input type="range" id="llmTemp" min="0" max="1" step="0.1" value="${agent.llmConfig?.temperature || 0.7}">
            <span id="tempValue">${agent.llmConfig?.temperature || 0.7}</span>
          </div>

          <label class="checkbox-label">
            <input type="checkbox" onchange="handleUseGlobalConfig('${agentId}')">
            Use Global Config
          </label>
        </div>

        <!-- Save & Delete -->
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="handleSaveAgentChanges('${agentId}')">ğŸ’¾ Save Changes</button>
          <button class="btn btn-danger" onclick="handleDeleteAgent('${agentId}')">ğŸ—‘ï¸ Delete Agent</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs-container">
        <div class="tab-nav">
          <button class="tab-btn ${activeTab === 'queue' ? 'active' : ''}" onclick="switchAgentTab('queue', '${agentId}')">ä»»å‹™ä½‡åˆ—</button>
          <button class="tab-btn ${activeTab === 'metrics' ? 'active' : ''}" onclick="switchAgentTab('metrics', '${agentId}')">æ•ˆèƒ½æŒ‡æ¨™</button>
          <button class="tab-btn ${activeTab === 'activity' ? 'active' : ''}" onclick="switchAgentTab('activity', '${agentId}')">æ´»å‹•æ­·å²</button>
        </div>
        <div class="tab-content" id="tabContent">
          ${renderTabs()}
        </div>
      </div>
    </div>
  `;

  // Initialize event listeners
  document.getElementById('llmTemp')?.addEventListener('input', (e) => {
    document.getElementById('tempValue').textContent = e.target.value;
  });
}

function renderTaskQueueTab(agent) {
  const taskQueue = agent.taskQueue || [];
  const pending = taskQueue.filter(t => t.status === 'pending');
  const inProgress = taskQueue.filter(t => t.status === 'in_progress');
  const completed = taskQueue.filter(t => t.status === 'completed');

  return `
    <div class="task-queue-tab">
      <div class="task-section">
        <h4>é€²è¡Œä¸­ (${inProgress.length})</h4>
        <div class="task-list">
          ${inProgress.map(task => renderTaskItem(agent.id, task)).join('')}
        </div>
      </div>

      <div class="task-section">
        <h4>å¾…è™•ç† (${pending.length})</h4>
        <div class="task-list">
          ${pending.map(task => renderTaskItem(agent.id, task)).join('')}
        </div>
      </div>

      <div class="task-section collapsible">
        <h4>å·²å®Œæˆ (${completed.length})</h4>
        <div class="task-list" style="display:none;">
          ${completed.map(task => renderTaskItem(agent.id, task)).join('')}
        </div>
      </div>

      <div class="add-task-form">
        <h4>â• æŒ‡æ´¾æ–°ä»»å‹™</h4>
        <input type="text" id="newTaskTitle" placeholder="Task Title">
        <select id="newTaskPriority">
          <option>low</option>
          <option selected>medium</option>
          <option>high</option>
        </select>
        <input type="date" id="newTaskDueDate">
        <button class="btn btn-primary" onclick="handleAddTaskToAgent('${agent.id}')">Add Task</button>
      </div>
    </div>
  `;
}

function renderTaskItem(agentId, task) {
  const statusIcon = {pending: 'â­•', in_progress: 'ğŸ”„', completed: 'âœ…'}[task.status] || '?';
  const priorityColor = {high: '#e74c3c', medium: '#f39c12', low: '#95a5a6'}[task.priority] || '#95a5a6';

  return `
    <div class="task-item" style="border-left: 4px solid ${priorityColor}">
      <span onclick="handleTaskStatusChange('${agentId}', '${task.id}')" style="cursor:pointer;" title="Click to change status">
        ${statusIcon} ${task.title}
      </span>
      <span class="priority-badge" style="background-color: ${priorityColor};">${task.priority}</span>
      <span class="due-date">${task.dueDate || 'No due date'}</span>
    </div>
  `;
}

function renderMetricsTab(agent) {
  const metrics = agent.metrics || {};

  return `
    <div class="metrics-tab">
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-num">${metrics.tasksCompleted || 0}</div>
          <div class="stat-lbl">Tasks Completed</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${metrics.avgResponseTime || '0s'}</div>
          <div class="stat-lbl">Avg Response Time</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${metrics.reliability || 0}%</div>
          <div class="stat-lbl">Reliability Score</div>
        </div>
      </div>

      <div class="chart-container">
        <h4>Weekly Task Trend</h4>
        <canvas id="weeklyChart"></canvas>
      </div>

      <button class="btn btn-secondary" onclick="handleGeneratePerformanceReport('${agent.id}')">
        ğŸ“‹ Generate Performance Report
      </button>
    </div>
  `;
}

function renderActivityHistoryTab(agent) {
  const activityLog = agent.activityLog || [];

  return `
    <div class="activity-tab">
      <div class="activity-filters">
        <select id="activityTypeFilter" onchange="filterActivityLog()">
          <option value="">All Types</option>
          <option value="info">Info</option>
          <option value="alert">Alert</option>
          <option value="warning">Warning</option>
          <option value="success">Success</option>
          <option value="error">Error</option>
        </select>
      </div>

      <div class="activity-timeline">
        ${activityLog.slice().reverse().map(entry => `
          <div class="activity-entry">
            <span class="time">${entry.time}</span>
            <span class="type-badge badge-${entry.type}">${getActivityTypeIcon(entry.type)}</span>
            <span class="message">${entry.message}</span>
          </div>
        `).join('')}
      </div>

      <div class="export-buttons">
        <button class="btn btn-secondary" onclick="handleExportActivityLog('${agent.id}')">ğŸ“¥ åŒ¯å‡º Log</button>
        <button class="btn btn-secondary" onclick="handleClearActivityLog('${agent.id}')">ğŸ—‘ï¸ æ¸…é™¤æ­·å²</button>
      </div>
    </div>
  `;
}

/**
 * 3. renderWorkflows(container, params)
 * Workflow management page
 */
function renderWorkflows(container, params) {
  const workflows = state.workflows || [];
  const agents = state.agents || [];

  container.innerHTML = `
    <div class="workflows-container">
      <div class="breadcrumb">
        <a onclick="navigateTo('/agents')">Agent æ§åˆ¶ä¸­å¿ƒ</a> > å·¥ä½œæµç®¡ç†
      </div>

      <div class="section-header">
        <h1>âš¡ å·¥ä½œæµç®¡ç†</h1>
      </div>

      <!-- Create Workflow Button -->
      <button class="btn btn-primary" onclick="handleCreateWorkflow()">
        â• å»ºç«‹æ–°å·¥ä½œæµ
      </button>

      <!-- Workflow Cards -->
      <div class="card-grid">
        ${workflows.map(workflow => `
          <div class="workflow-card">
            <div class="workflow-header">
              <h3>${workflow.name}</h3>
              <span class="badge badge-${workflow.status}">${workflow.status === 'active' ? 'âœ“ Active' : 'â¸ï¸ Paused'}</span>
            </div>
            <p class="description">${workflow.description || 'No description'}</p>

            <!-- Trigger Info -->
            <div class="trigger-info">
              <span>â° ${workflow.trigger?.label || 'On-demand'}</span>
            </div>

            <!-- Visual Flow -->
            <div class="workflow-steps">
              <div class="workflow-step">
                <div class="step-content">â°</div>
                <div class="step-label">Trigger</div>
              </div>
              ${(workflow.steps || []).map((step, idx) => `
                <div class="workflow-arrow">â†’</div>
                <div class="workflow-step">
                  <div class="step-content">ğŸ¤–</div>
                  <div class="step-label">${step.agent}</div>
                  <small>${step.action}</small>
                </div>
              `).join('')}
              <div class="workflow-arrow">â†’</div>
              <div class="workflow-step">
                <div class="step-content">ğŸ“„</div>
                <div class="step-label">Output</div>
              </div>
            </div>

            <!-- Run Info -->
            <div class="run-info">
              <small>Last: ${workflow.lastRun || 'Never'}</small>
              <small>Next: ${workflow.nextRun || 'N/A'}</small>
            </div>

            <!-- Actions -->
            <div class="card-actions">
              <button class="btn-icon" onclick="handleToggleWorkflow('${workflow.id}')" title="Toggle">
                ${workflow.status === 'active' ? 'â¸ï¸' : 'â–¶ï¸'}
              </button>
              <button class="btn-icon" onclick="handleEditWorkflow('${workflow.id}')" title="Edit">
                âœï¸
              </button>
              <button class="btn-icon" onclick="handleManualTrigger('${workflow.id}')" title="Run Now">
                â–¶ï¸
              </button>
              <button class="btn-icon" onclick="handleDeleteWorkflow('${workflow.id}')" title="Delete">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        `).join('')}
      </div>

      <!-- Integration Info -->
      <div class="info-box">
        <h4>ğŸ”— Future Integration</h4>
        <p>æ­¤å·¥ä½œæµç³»çµ±é ç•™ä»¥ä¸‹æ•´åˆæ¥å£ï¼š</p>
        <ul>
          <li><strong>CrewAI Backend</strong> - å¤šä»£ç†å”ä½œå¼•æ“</li>
          <li><strong>LangGraph</strong> - æœ‰ç‹€æ…‹å·¥ä½œæµå¼•æ“</li>
          <li><strong>OpenAI Swarm</strong> - è¼•é‡ç´šä»£ç†ç·¨æ’</li>
          <li><strong>Local LLM</strong> - æ”¯æ´ Ollama / vLLM åœ°ç«¯éƒ¨ç½²</li>
        </ul>
        <p style="font-size: 0.9em; color: #666;">è¨­å®š API ç«¯é»å¾Œï¼Œå·¥ä½œæµå°‡è‡ªå‹•é€é LLM å¾Œç«¯åŸ·è¡Œã€‚</p>
      </div>
    </div>
  `;
}

/**
 * 4. renderAgentActivity(container, params)
 * Global activity log page for all agents
 */
function renderAgentActivity(container, params) {
  const agents = state.agents || [];
  const allActivities = mergeAgentActivities(agents);

  container.innerHTML = `
    <div class="activity-container">
      <div class="breadcrumb">
        <a onclick="navigateTo('/agents')">Agent æ§åˆ¶ä¸­å¿ƒ</a> > æ´»å‹•ç´€éŒ„
      </div>

      <div class="section-header">
        <h1>ğŸ“œ å…¨åŸŸæ´»å‹•ç´€éŒ„</h1>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <select id="filterAgent" onchange="reloadActivityPage()">
          <option value="">All Agents</option>
          ${agents.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
        </select>

        <select id="filterType" onchange="reloadActivityPage()">
          <option value="">All Types</option>
          <option value="info">Info</option>
          <option value="alert">Alert</option>
          <option value="warning">Warning</option>
          <option value="success">Success</option>
          <option value="error">Error</option>
        </select>

        <select id="filterDateRange" onchange="reloadActivityPage()">
          <option value="today">Today</option>
          <option value="3days">3 Days</option>
          <option value="7days">7 Days</option>
          <option value="all">All</option>
        </select>

        <input type="text" id="searchActivity" placeholder="Search..." onkeyup="reloadActivityPage()">
      </div>

      <!-- Summary Stats -->
      <div class="summary-stats">
        <div class="stat-box">
          <div class="stat-num">${allActivities.length}</div>
          <div class="stat-lbl">Total Events</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${allActivities.filter(a => ['alert', 'warning', 'error'].includes(a.type)).length}</div>
          <div class="stat-lbl">Alerts</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${getMostActiveAgent(agents)}</div>
          <div class="stat-lbl">Most Active Agent</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${allActivities[0]?.time || 'N/A'}</div>
          <div class="stat-lbl">Last Event</div>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="activity-timeline-full">
        ${groupActivitiesByDate(allActivities).map(group => `
          <div class="date-group">
            <h3 class="date-header">${group.date}</h3>
            ${group.activities.map(activity => `
              <div class="activity-item">
                <span class="time">${activity.time}</span>
                <span class="agent">${activity.emoji} ${activity.agent}</span>
                <span class="type-badge badge-${activity.type}">${getActivityTypeIcon(activity.type)}</span>
                <span class="message">${activity.message}</span>
              </div>
            `).join('')}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

/* ============================================================
   HELPER FUNCTIONS
   ============================================================ */

function getStatusIndicatorStyle(status) {
  const colors = {
    active: '#27ae60',
    idle: '#f39c12',
    paused: '#95a5a6',
    error: '#e74c3c'
  };
  return `background-color: ${colors[status] || '#95a5a6'}; width: 12px; height: 12px; border-radius: 50%; position: absolute; top: 10px; right: 10px;`;
}

function getAutonomyBadge(level) {
  const badges = {
    intern: 'ğŸŸ¡ Intern',
    specialist: 'ğŸ”µ Specialist',
    lead: 'ğŸŸ¢ Lead'
  };
  return badges[level] || '?';
}

function getActivityTypeIcon(type) {
  const icons = {
    info: 'â„¹ï¸',
    alert: 'âš ï¸',
    warning: 'âš ï¸',
    success: 'âœ…',
    error: 'âŒ'
  };
  return icons[type] || 'â€¢';
}

function getRecentActivities(agents, limit) {
  const activities = [];
  agents.forEach(agent => {
    (agent.activityLog || []).slice(-3).forEach(log => {
      activities.push({
        ...log,
        emoji: agent.emoji,
        agent: agent.name
      });
    });
  });
  return activities.sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, limit);
}

function mergeAgentActivities(agents) {
  const activities = [];
  agents.forEach(agent => {
    (agent.activityLog || []).forEach(log => {
      activities.push({
        ...log,
        emoji: agent.emoji,
        agent: agent.name,
        agentId: agent.id
      });
    });
  });
  return activities.sort((a, b) => new Date(b.time) - new Date(a.time));
}

function groupActivitiesByDate(activities) {
  const grouped = {};
  activities.forEach(activity => {
    const date = activity.time?.split(' ')[0] || 'Unknown';
    if (!grouped[date]) grouped[date] = [];
    grouped[date].push(activity);
  });

  return Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).map(date => ({
    date,
    activities: grouped[date]
  }));
}

function getMostActiveAgent(agents) {
  if (agents.length === 0) return 'N/A';
  const mostActive = agents.reduce((prev, current) =>
    (prev.activityLog?.length || 0) > (current.activityLog?.length || 0) ? prev : current
  );
  return mostActive.name || 'N/A';
}

/* ============================================================
   EVENT HANDLERS
   ============================================================ */

function handleAddNewAgent() {
  showModal('New Agent', renderNewAgentForm(), { width: '500px' });
}

function renderNewAgentForm() {
  return `
    <div class="form-group">
      <label>Emoji</label>
      <input type="text" id="formEmoji" maxlength="2" value="ğŸ¤–">
    </div>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="formName" placeholder="Agent Name">
    </div>
    <div class="form-group">
      <label>Role</label>
      <input type="text" id="formRole" placeholder="Role">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="formDesc" placeholder="Description"></textarea>
    </div>
    <div class="form-group">
      <label>Autonomy</label>
      <select id="formAutonomy">
        <option value="intern">Intern</option>
        <option value="specialist">Specialist</option>
        <option value="lead">Lead</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="handleSaveNewAgent()">Create Agent</button>
  `;
}

function handleSaveNewAgent() {
  const newAgent = {
    id: 'agent-' + String(state.agents.length + 1).padStart(3, '0'),
    emoji: document.getElementById('formEmoji').value || 'ğŸ¤–',
    name: document.getElementById('formName').value,
    role: document.getElementById('formRole').value,
    description: document.getElementById('formDesc').value,
    autonomy: document.getElementById('formAutonomy').value,
    status: 'active',
    assignedProjects: [],
    schedule: { type: 'daily', time: '08:00', timezone: 'Asia/Taipei' },
    tools: [],
    llmConfig: { provider: 'none', model: '', temperature: 0.7 },
    metrics: { tasksCompleted: 0, avgResponseTime: '0s', reliability: 100, weeklyTasks: [0, 0, 0, 0] },
    taskQueue: [],
    activityLog: [{ time: new Date().toISOString(), type: 'success', message: 'Agent created' }],
    createdAt: new Date().toISOString().split('T')[0],
    updatedAt: new Date().toISOString().split('T')[0]
  };

  state.agents.push(newAgent);
  saveState();
  closeModal();
  showToast('Agent created successfully');
  navigateTo('/agents/' + newAgent.id);
}

function handlePauseAllAgents() {
  state.agents.forEach(a => a.status = 'paused');
  saveState();
  showToast('All agents paused');
  handleRoute(window.location.hash);
}

function handleActivateAllAgents() {
  state.agents.forEach(a => a.status = 'active');
  saveState();
  showToast('All agents activated');
  handleRoute(window.location.hash);
}

function handleStandupReport() {
  const report = generateStandupReport(state.agents);
  showModal('Daily Standup Report', `<pre>${report}</pre>`, { width: '600px' });
}

function generateStandupReport(agents) {
  const today = new Date().toLocaleDateString();
  let report = `DAILY STANDUP REPORT - ${today}\n\n`;

  agents.forEach(agent => {
    const completed = agent.taskQueue?.filter(t => t.status === 'completed').length || 0;
    const pending = agent.taskQueue?.filter(t => t.status === 'pending').length || 0;
    const inProgress = agent.taskQueue?.filter(t => t.status === 'in_progress').length || 0;

    report += `${agent.emoji} ${agent.name} (${agent.role})\n`;
    report += `  Status: ${agent.status}\n`;
    report += `  Completed: ${completed} | In Progress: ${inProgress} | Pending: ${pending}\n`;
    report += `  Reliability: ${agent.metrics?.reliability || 0}%\n\n`;
  });

  return report;
}

function handleToggleAgentStatus(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.status = agent.status === 'active' ? 'paused' : 'active';
    saveState();
    handleRoute(window.location.hash);
  }
}

function handleQuickTaskAssign(agentId) {
  showModal('Quick Task Assign', `
    <input type="text" id="quickTaskTitle" placeholder="Task Title">
    <select id="quickTaskPriority"><option>low</option><option selected>medium</option><option>high</option></select>
    <button class="btn btn-primary" onclick="handleSaveQuickTask('${agentId}')">Add</button>
  `, { width: '400px' });
}

function handleSaveQuickTask(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.taskQueue.push({
      id: 't' + Date.now(),
      title: document.getElementById('quickTaskTitle').value,
      status: 'pending',
      priority: document.getElementById('quickTaskPriority').value,
      dueDate: new Date().toISOString().split('T')[0]
    });
    saveState();
    closeModal();
    showToast('Task assigned');
  }
}

function handleUpdateAgent(agentId, updates) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    Object.assign(agent, updates);
    agent.updatedAt = new Date().toISOString().split('T')[0];
    saveState();
    handleRoute(window.location.hash);
  }
}

function handleSaveAgentChanges(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.emoji = document.getElementById('agentEmoji').value;
    agent.name = document.getElementById('agentName').value;
    agent.role = document.getElementById('agentRole').value;
    agent.description = document.getElementById('agentDescription').value;
    agent.llmConfig.provider = document.getElementById('llmProvider').value;
    agent.llmConfig.model = document.getElementById('llmModel').value;
    agent.llmConfig.temperature = parseFloat(document.getElementById('llmTemp').value);
    agent.updatedAt = new Date().toISOString().split('T')[0];
    saveState();
    showToast('Agent updated');
  }
}

function handleDeleteAgent(agentId) {
  if (confirm('Delete this agent? This action cannot be undone.')) {
    state.agents = state.agents.filter(a => a.id !== agentId);
    saveState();
    showToast('Agent deleted');
    navigateTo('/agents');
  }
}

function handleAddTaskToAgent(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    const title = document.getElementById('newTaskTitle').value;
    const priority = document.getElementById('newTaskPriority').value;
    const dueDate = document.getElementById('newTaskDueDate').value;

    if (title) {
      agent.taskQueue.push({
        id: 't' + Date.now(),
        title,
        status: 'pending',
        priority,
        dueDate
      });
      saveState();
      document.getElementById('newTaskTitle').value = '';
      handleRoute(window.location.hash);
      showToast('Task added');
    }
  }
}

function handleTaskStatusChange(agentId, taskId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    const task = agent.taskQueue.find(t => t.id === taskId);
    if (task) {
      const statuses = ['pending', 'in_progress', 'completed'];
      const currentIdx = statuses.indexOf(task.status);
      task.status = statuses[(currentIdx + 1) % statuses.length];
      saveState();
      handleRoute(window.location.hash);
    }
  }
}

function handleEditSchedule(agentId) {
  showModal('Edit Schedule', `
    <input type="text" id="schedType" value="${state.agents.find(a => a.id === agentId)?.schedule?.type || ''}">
    <input type="time" id="schedTime" value="${state.agents.find(a => a.id === agentId)?.schedule?.time || ''}">
    <button class="btn btn-primary" onclick="handleSaveSchedule('${agentId}')">Save</button>
  `);
}

function handleSaveSchedule(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent) {
    agent.schedule.type = document.getElementById('schedType').value;
    agent.schedule.time = document.getElementById('schedTime').value;
    saveState();
    closeModal();
    handleRoute(window.location.hash);
  }
}

function handleGeneratePerformanceReport(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  const report = `Performance Report: ${agent?.name}\n\nTasks Completed: ${agent?.metrics?.tasksCompleted}\nReliability: ${agent?.metrics?.reliability}%\nAvg Response Time: ${agent?.metrics?.avgResponseTime}`;
  showModal('Performance Report', `<pre>${report}</pre>`);
}

function handleExportActivityLog(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  const json = JSON.stringify(agent?.activityLog, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${agent?.name}_activity.json`;
  a.click();
  showToast('Log exported');
}

function handleClearActivityLog(agentId) {
  if (confirm('Clear all activity history? This cannot be undone.')) {
    const agent = state.agents.find(a => a.id === agentId);
    if (agent) {
      agent.activityLog = [];
      saveState();
      handleRoute(window.location.hash);
      showToast('Activity log cleared');
    }
  }
}

function switchAgentTab(tabName, agentId) {
  // This would normally update the active tab and re-render
  // For now, a simplified version
  handleRoute(`#/agents/${agentId}`);
}

function handleCreateWorkflow() {
  showModal('New Workflow', renderWorkflowForm());
}

function renderWorkflowForm() {
  return `
    <input type="text" id="wfName" placeholder="Workflow Name">
    <textarea id="wfDesc" placeholder="Description"></textarea>
    <select id="wfTrigger"><option value="schedule">Schedule</option><option value="event">Event</option></select>
    <button class="btn btn-primary" onclick="handleSaveWorkflow()">Create</button>
  `;
}

function handleSaveWorkflow() {
  const newWorkflow = {
    id: 'wf-' + Date.now(),
    name: document.getElementById('wfName').value,
    description: document.getElementById('wfDesc').value,
    trigger: { type: document.getElementById('wfTrigger').value, label: 'Weekly' },
    steps: [],
    status: 'active',
    lastRun: '',
    nextRun: ''
  };
  state.workflows.push(newWorkflow);
  saveState();
  closeModal();
  showToast('Workflow created');
  handleRoute('#/workflows');
}

function handleToggleWorkflow(workflowId) {
  const wf = state.workflows.find(w => w.id === workflowId);
  if (wf) {
    wf.status = wf.status === 'active' ? 'paused' : 'active';
    saveState();
    handleRoute('#/workflows');
  }
}

function handleDeleteWorkflow(workflowId) {
  if (confirm('Delete workflow?')) {
    state.workflows = state.workflows.filter(w => w.id !== workflowId);
    saveState();
    handleRoute('#/workflows');
  }
}

function handleManualTrigger(workflowId) {
  showToast('Workflow triggered');
}

function handleEditWorkflow(workflowId) {
  showToast('Edit workflow (coming soon)');
}

function handleUseGlobalConfig(agentId) {
  const agent = state.agents.find(a => a.id === agentId);
  if (agent && state.llmConfig) {
    agent.llmConfig = { ...state.llmConfig };
    saveState();
    handleRoute(window.location.hash);
  }
}

function handleLLMConfigChange(agentId) {
  // Update LLM config on change
}

function reloadActivityPage() {
  handleRoute('#/activity');
}

function filterActivityLog() {
  // Filter implementation
}

function getSelectedProjects() {
  // Helper to get selected projects
  return [];
}

    
function toggleTheme() {
  const themes = ['light', 'dark', 'system'];
  const current = state.theme || 'system';
  const idx = themes.indexOf(current);
  const next = themes[(idx + 1) % themes.length];
  setTheme(next);
}

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadState();
      initTheme();
      if (state.sidebarCollapsed) {
        document.body.classList.add('sidebar-collapsed');
      }
      handleRoute();
    });
  </script>
</body>
</html>
